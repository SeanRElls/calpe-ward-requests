<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calpe Ward Off Duty Requests</title>

  <!-- Supabase JS (v2) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- =========================
       STYLES
       ========================= -->

  <style>
    :root{
      --grid: #d9d9d9;
      --grid-soft: #ececec;
      --text: #111;
      --muted: #6b6b6b;
      --header: #f4f4f4;
      --sheet-bg: #ffffff;
      --sep: #c0c0c0;
      --sep-fill: #e3e3e3;

      --closed-fill: #f0f0f0;
      --weekend-fill: #fafafa;

      --cn-band: #ffd18a;
      --sn-band: #9fd0ff;
      --na-band: #a8e6a1;
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 18px;
      color: var(--text);
      background: #f7f7f7;
    }

    .wrap{
      background: var(--sheet-bg);
      border: 1px solid var(--grid);
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 14px 14px 10px;
      overflow: auto;
    }

    .titlebar{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin: 2px 2px 12px;
    }

    h1{
      font-size: 22px;
      margin: 0;
      font-weight: 750;
      letter-spacing: 0.2px;
    }

    .subtitle{
      font-size: 13px;
      color: var(--muted);
    }

    .rightbits{
      display:flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .badge{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background:#eee;
      color:#222;
      white-space: nowrap;
    }

    .badge.admin{
      background:#222;
      color:#fff;
    }

    table{
      border-collapse: separate;
      border-spacing: 0;
      width: max-content;
      min-width: 100%;
      font-size: 12px;
    }

    th, td{
      border-right: 1px solid var(--grid-soft);
      border-bottom: 1px solid var(--grid-soft);
      text-align: center;
      vertical-align: middle;
      padding: 0;
      height: 24px;
      background: #fff;
      min-width: 34px;
    }

    table tr:first-child th{ border-top: 1px solid var(--grid); }
    table tr th:first-child, table tr td:first-child{ border-left: 1px solid var(--grid); }
    table tr:last-child td{ border-bottom: 1px solid var(--grid); }
    table tr th{ border-bottom: 1px solid var(--grid); }

    thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--header);
    }

    .name-col{
      position: sticky;
      left: 0;
      z-index: 6;
      background: #fff;
      text-align: left;
      padding: 0 10px;
      min-width: 220px;
      font-weight: 650;
      border-right: 2px solid var(--sep);
      cursor: pointer;
    }

    thead .name-col{
      background: var(--header);
      z-index: 10;
      font-weight: 750;
      cursor: default;
    }

    .week-comment-btn {
  margin-left: 6px;
  border: 1px solid #ccc;
  border-radius: 999px;
  padding: 2px 8px;
  background: #fff;
  cursor: pointer;
  font-size: 12px;
}
.week-comment-btn.has-comment {
  border-color: #111;
  font-weight: 700;
}
.week-label { font-weight: 600; }

    
    th.week-label{
      font-weight: 800;
      font-size: 12px;
      letter-spacing: 0.2px;
      color: #222;
      height: 28px;
      background: #ededed;
    }

    th.day{
      font-weight: 800;
      height: 22px;
      color: #222;
    }

    th.date{
      font-weight: 700;
      height: 22px;
      color: #222;
    }

    .week-sep{
      min-width: 14px;
      width: 14px;
      background: var(--sep-fill) !important;
      border-right: 2px solid var(--sep) !important;
      border-left: 0 !important;
    }

    .closed{
      background: var(--closed-fill) !important;
      color: #9b9b9b;
    }

    .weekend{
      background: var(--weekend-fill);
    }

    tr.section-row td{
      height: 22px;
      font-weight: 850;
      text-align: left;
      padding: 0 10px;
      border-top: 2px solid #9a9a9a;
      border-bottom: 2px solid #9a9a9a;
    }

    tr.section-row td span{
      color: #1b1b1b;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    td.section-cn { background: var(--cn-band) !important; }
    td.section-sn { background: var(--sn-band) !important; }
    td.section-na { background: var(--na-band) !important; }

    td.cell{
      font-size: 12px;
      color: #111;
    }

    td.cell:hover{
      background: #f6fbff;
    }

    /* Locked vs unlocked rows */
    tr.locked td.cell{ opacity: 0.55; }
    tr.locked td.cell:hover{ background: #fff; }
    tr.unlocked td.cell{ opacity: 1; }
    tr.unlocked td.cell.editable{ outline: 2px solid rgba(0,0,0,0.08); cursor: pointer; }

    /* ===== MODALS (shared) ===== */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 14px;
    }

    .modal{
      width: min(520px, 100%);
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      padding: 14px;
    }

    .modal h2{
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .modal p{
      margin: 0 0 12px 0;
      font-size: 13px;
      color: #444;
      line-height: 1.35;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items: stretch;
      flex-wrap: wrap;
    }

    input.pin{
      flex: 1 1 220px;
      font-size: 18px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid #ccc;
      letter-spacing: 10px;
      text-align: center;
      min-width: 220px;
    }

    .btns{
      display:flex;
      gap: 10px;
      flex: 1 1 200px;
      justify-content: flex-end;
      min-width: 200px;
    }

    button{
      font-size: 14px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #ccc;
      background: #f7f7f7;
      cursor: pointer;
      flex: 1;
      min-width: 110px;
    }

    button.primary{
      background:#111;
      border-color:#111;
      color:#fff;
    }

    button:disabled{
      opacity: 0.6;
      cursor: not-allowed;
    }

    .err{
      margin-top: 10px;
      font-size: 12px;
      color: #b00020;
      display:none;
    }

    @media (max-width: 480px){
      body{ margin: 12px; }
      .wrap{ padding: 12px; }
      .titlebar{ flex-direction: column; align-items: flex-start; }
      .rightbits{ justify-content: flex-start; }
      input.pin{ flex: 1 1 100%; min-width: 0; }
      .btns{ flex: 1 1 100%; min-width: 0; }
      button{ min-width: 0; }
    }

    /* ===== SHIFT PICKER ===== */
    .shift-grid{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 12px 0 16px;
    }

    .shift-btn{
      padding: 14px 0;
      font-size: 14px;
      border-radius: 12px;
      border: 1px solid #ccc;
      background: #f7f7f7;
      cursor: pointer;
      font-weight: 700;
    }

    .shift-btn:hover{
      background: #e9f2ff;
    }

    .shift-btn.off{
      background: #ffecec;
      border-color: #ffb3b3;
    }

    @media (max-width: 480px){
      .shift-grid{
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="titlebar">
      <div>
        <h1>Calpe Ward Requests</h1>
        <div class="subtitle" id="periodLabel"></div>
      </div>
      <div class="rightbits">
        <div class="badge" id="loginBadge">Not logged in</div>
        <div class="badge admin" id="adminBadge" style="display:none;">ADMIN</div>
      </div>
    </div>

    <table id="rota"></table>
  </div>

  <!-- =========================
       PIN MODAL (login)
       ========================= -->
  <div class="modal-backdrop" id="pinModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pinTitle">
      <h2 id="pinTitle">Enter PIN</h2>
      <p id="pinDesc">Enter your 4-digit PIN to unlock editing.</p>

      <div class="row">
        <input class="pin" id="pinInput" inputmode="numeric" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" />
        <div class="btns">
          <button id="pinCancel" type="button">Cancel</button>
          <button class="primary" id="pinConfirm" type="button">Unlock</button>
        </div>
      </div>

      <div class="err" id="pinErr">Wrong PIN.</div>
    </div>
  </div>

  <!-- =========================
       SHIFT PICKER MODAL (Patch 2)
       ========================= -->
  <div class="modal-backdrop" id="shiftModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="shiftTitle">
      <h2 id="shiftTitle">Select shift</h2>
      <p id="shiftDesc">Choose a request for this day.</p>


      <div class="shift-grid">
        <button class="shift-btn" data-shift="LD" type="button">LD</button>
        <button class="shift-btn" data-shift="8-8" type="button">8â€“8</button>
        <button class="shift-btn" data-shift="N" type="button">N</button>
        <button class="shift-btn" data-shift="W" type="button">W</button>
        <button class="shift-btn off" data-shift="O" type="button">O</button>
        <button class="shift-btn" data-shift="CLEAR" type="button">Clear</button>
      </div>

      <div class="btns">
        <button id="shiftCancel" type="button">Cancel</button>
      </div>
    </div>
  </div>
 <!-- =========================
      COMMENTS 
       ========================= -->
  
  <div class="modal-backdrop" id="weekCommentModal" aria-hidden="true" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="weekCommentTitle">
    <h2 id="weekCommentTitle">Week comments</h2>

    <div id="weekCommentAdminList"
         style="display:none; max-height:260px; overflow:auto; border:1px solid #ddd; border-radius:8px; padding:8px; margin-bottom:10px;">
    </div>

    <label style="display:block; font-weight:600; margin:8px 0 6px;">Your comment</label>
    <textarea id="weekCommentInput" rows="4" style="width:100%;"></textarea>

    <div class="btns" style="margin-top:10px;">
      <button id="weekCommentCancel" type="button">Close</button>
      <button id="weekCommentSave" class="primary" type="button">Save</button>
    </div>
  </div>
</div>


  <script>
    /* =========================================================
       1) CONFIG
       ========================================================= */
    const SUPABASE_URL = "https://tbclufdtyefexwwitfsz.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiY2x1ZmR0eWVmZXh3d2l0ZnN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwODA4ODksImV4cCI6MjA4MjY1Njg4OX0.OYnj44QQCTD-5tqR2XSVt4oQso9Ol8ZLH2tLsRGIreA";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    const STORAGE_KEY = "calpeward.loggedInUserId";
    const MAX_REQUESTS_PER_WEEK = 5;

    /* =========================================================
       2) HELPERS (dates, formatting)
       ========================================================= */
    const fmt = (d) => d.toLocaleDateString("en-GB", { day: "numeric", month: "short" });
    
   function isoDate(d){
  const x = new Date(d);
  x.setHours(12,0,0,0); // pin to midday to avoid timezone rollover
  const y = x.getFullYear();
  const m = String(x.getMonth()+1).padStart(2,"0");
  const da = String(x.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}

    function startOfWeekSunday(dateObj){
      const d = new Date(dateObj);
      const day = d.getDay();
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() - day);
      return d;
    }
    function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }

    function groupDatesIntoWeeks(dates){
      const map = new Map();
      for(const item of dates){
        const d = new Date(item.date);
        const ws = startOfWeekSunday(d);
        const key = isoDate(ws);

        if(!map.has(key)){
          map.set(key, { weekStart: ws, days: [], open: (item.rota_weeks && item.rota_weeks.open) ?? true });
        }
        map.get(key).days.push(item);
      }

      const weeks = [];
      for(const w of map.values()){
        const dayLookup = new Map(w.days.map(x => [x.date, x]));
        const ordered = [];

        for(let i=0;i<7;i++){
          const dd = addDays(w.weekStart, i);
          const ds = isoDate(dd);
          const row = dayLookup.get(ds) || { date: ds, rota_weeks: { open: w.open } };
          ordered.push(row);
        }

        weeks.push({
          weekStart: w.weekStart,
          weekEnd: addDays(w.weekStart, 6),
          open: w.open,
          days: ordered
        });
      }

      weeks.sort((a,b) => a.weekStart - b.weekStart);
      return weeks;
    }

    function groupUsers(users){
      const buckets = { charge_nurse: [], staff_nurse: [], nursing_assistant: [] };

      for(const u of users){
        const label =
          u.roles?.name ||
          (u.role_id === 1 ? "charge_nurse" :
           u.role_id === 2 ? "staff_nurse" :
           u.role_id === 3 ? "nursing_assistant" : "staff_nurse");

        (buckets[label] || buckets.staff_nurse).push(u);
      }

      return [
        { title: "Charge Nurses",      className: "section-cn", items: buckets.charge_nurse },
        { title: "Staff Nurses",       className: "section-sn", items: buckets.staff_nurse },
        { title: "Nursing Assistants", className: "section-na", items: buckets.nursing_assistant }
      ].filter(g => g.items.length > 0);
    }
function getWeekStart(dateStr){
  const d = new Date(dateStr);
  const day = d.getDay(); // 0 = Sunday
  d.setDate(d.getDate() - day);
  d.setHours(0,0,0,0);
  return isoDate(d);
}

function countUserRequestsThisWeek(userId, dateStr){
  const weekStart = getWeekStart(dateStr);
  let count = 0;

  for (const r of requestsCache.values()){
    if (r.user_id !== userId) continue;
    if (getWeekStart(r.date) === weekStart) count++;
  }

  return count;
}

function nextOffPrioritySmart(currentRank, taken){
  // Cycle intent: null -> 1 -> 2 -> 3 -> null
  let desired =
    (currentRank == null) ? 1 :
    (currentRank === 1) ? 2 :
    (currentRank === 2) ? 3 :
    null;

  // If desired is taken elsewhere, pick the next available in order 1,2,3.
  if (desired != null && taken.has(desired)) {
    if (!taken.has(1)) desired = 1;
    else if (!taken.has(2)) desired = 2;
    else if (!taken.has(3)) desired = 3;
    else desired = null; // all used, must be normal O
  }

  return desired;
}
    
function getTakenOffRanksThisWeek(userId, dateStr, excludeKey){
  const ws = getWeekStart(dateStr);
  const taken = new Set();

  // include saved rows
  for (const [k, r] of requestsCache.entries()){
    if (k === excludeKey) continue;
    if (r.user_id !== userId) continue;
    if (getWeekStart(r.date) !== ws) continue;
    if (r.value !== "O") continue;
    if (r.important_rank === 1 || r.important_rank === 2 || r.important_rank === 3) {
      taken.add(r.important_rank);
    }
  }

  // include pending edits
  for (const [k, pe] of Object.entries(pendingEdits)){
    if (k === excludeKey) continue;
    if (pe.userId !== userId) continue;
    if (getWeekStart(pe.date) !== ws) continue;
    if (pe.shift !== "O") continue;
    if (pe.important_rank === 1 || pe.important_rank === 2 || pe.important_rank === 3) {
      taken.add(pe.important_rank);
    }
  }

  return taken;
}

async function fetchWeekComments(weekId){
  const { data, error } = await supabaseClient
    .from("week_comments")
    .select("user_id, comment, updated_at")
    .eq("week_id", weekId);

  if (error) throw error;
  return data || [];
}

async function upsertWeekComment(weekId, userId, comment){
  const payload = {
    week_id: weekId,
    user_id: userId,
    comment: comment ?? ""
  };

  const { data, error } = await supabaseClient
    .from("week_comments")
    .upsert(payload, { onConflict: "week_id,user_id" })
    .select("week_id, user_id, comment, updated_at")
    .single();

  if (error) throw error;
  return data;
}

/* =========================================================
   3) STATE (who is logged in / what is unlocked)
   ========================================================= */
let currentUser = null;      // user object when logged in (by PIN)
let selectedUser = null;     // user you clicked before PIN entry

/* =========================================================
   3b) STATE (editing + requests)
   ========================================================= */
let activeCell = null;           // { td, userId, date }
const pendingEdits = {};         // key -> { userId, date, shift }
const requestsCache = new Map(); // key -> { id, user_id, date, value, important_rank }

// key: `${user_id}_${date}` -> { id, user_id, date, value, important_rank }

    /* =========================================================
       4) DOM REFERENCES
       ========================================================= */
    const modal = document.getElementById("pinModal");
    const pinInput = document.getElementById("pinInput");
    const pinErr = document.getElementById("pinErr");
    const pinTitle = document.getElementById("pinTitle");
    const pinDesc = document.getElementById("pinDesc");
    const pinConfirmBtn = document.getElementById("pinConfirm");
    const pinCancelBtn = document.getElementById("pinCancel");
    const loginBadge = document.getElementById("loginBadge");
    const adminBadge = document.getElementById("adminBadge");

    // Shift modal refs
    const shiftModal = document.getElementById("shiftModal");
    const shiftCancelBtn = document.getElementById("shiftCancel");
    
// Week comment modal refs
const weekCommentModal = document.getElementById("weekCommentModal");
const weekCommentCancel = document.getElementById("weekCommentCancel");
const weekCommentSave = document.getElementById("weekCommentSave");
const weekCommentInput = document.getElementById("weekCommentInput");
const weekCommentAdminList = document.getElementById("weekCommentAdminList");

let activeWeekIdForComment = null;





    /* =========================================================
       5) PIN MODAL (open/close)
       ========================================================= */
    function openPinModal(user){
      selectedUser = user;

      pinTitle.textContent = `PIN for ${user.name}`;
      pinDesc.textContent = "Enter your 4-digit PIN to unlock editing.";
      pinErr.style.display = "none";
      pinInput.value = "";

      modal.style.display = "flex";
      modal.setAttribute("aria-hidden", "false");

      setTimeout(() => pinInput.focus(), 50);
    }

    function closePinModal(){
      modal.style.display = "none";
      modal.setAttribute("aria-hidden", "true");
      selectedUser = null;
      pinConfirmBtn.disabled = false;
    }

    pinCancelBtn.addEventListener("click", closePinModal);
    modal.addEventListener("click", (e) => { if(e.target === modal) closePinModal(); });

    pinInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        pinConfirmBtn.click();
      }
    });

    /* =========================================================
       6) AUTH (verify PIN via RPC)
       ========================================================= */
    pinConfirmBtn.addEventListener("click", async () => {
      const pin = pinInput.value.trim();
      if(!selectedUser) return;

      if(!/^\d{4}$/.test(pin)){
        pinErr.textContent = "PIN must be 4 digits.";
        pinErr.style.display = "block";
        return;
      }

      pinConfirmBtn.disabled = true;
      pinErr.style.display = "none";

      try{
        const { data: ok, error } = await supabaseClient.rpc("verify_user_pin", {
          p_user_id: selectedUser.id,
          p_pin: pin
        });

        if(error){
          console.error("RPC error:", error);
          pinErr.textContent = "Server error (RPC).";
          pinErr.style.display = "block";
          pinConfirmBtn.disabled = false;
          return;
        }

        if(ok !== true){
          pinErr.textContent = "Wrong PIN.";
          pinErr.style.display = "block";
          pinConfirmBtn.disabled = false;
          return;
        }

        currentUser = selectedUser;
        localStorage.setItem(STORAGE_KEY, currentUser.id);

        closePinModal();
        applyUnlockState();
        updateBadges();

      }catch(err){
        console.error("Login exception:", err);
        pinErr.textContent = "Login error. Try again.";
        pinErr.style.display = "block";
        pinConfirmBtn.disabled = false;
      }
    });

    function updateBadges(){
      if(!currentUser){
        loginBadge.textContent = "Not logged in";
        adminBadge.style.display = "none";
        return;
      }
      loginBadge.textContent = `Logged in: ${currentUser.name}`;
      adminBadge.style.display = currentUser.is_admin ? "inline-block" : "none";
    }
/* =========================================================
   PATCH 2) SHIFT PICKER LOGIC (with OFF priority)
   ========================================================= */

function openShiftModal(){
  if (!activeCell) return;
  shiftModal.style.display = "flex";
  shiftModal.setAttribute("aria-hidden", "false");
}

function closeShiftModal(){
  shiftModal.style.display = "none";
  shiftModal.setAttribute("aria-hidden", "true");
  activeCell = null;
}

shiftCancelBtn.addEventListener("click", closeShiftModal);
shiftModal.addEventListener("click", (e) => {
  if (e.target === shiftModal) closeShiftModal();
});

document.querySelectorAll(".shift-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    if (!activeCell) return;

    const td = activeCell.td;
    const userId = activeCell.userId;
    const date = activeCell.date;
const shift = btn.dataset.shift;
const key = `${userId}_${date}`;
const existing = requestsCache.get(key);

// Special handling for OFF: cycle priority
let rankToSave = null;

if (shift === "O") {
  const pe = pendingEdits[key];
  const existing = requestsCache.get(key);

  const currentRank =
    (pe && pe.shift === "O") ? (pe.important_rank ?? null) :
    (existing?.value === "O") ? (existing.important_rank ?? null) :
    null;

  const taken = getTakenOffRanksThisWeek(userId, date, key);
  rankToSave = nextOffPrioritySmart(currentRank, taken);
}
 

    /* -----------------------------
       STEP 1: Max 5 per week guard
       ----------------------------- */
    if (shift !== "CLEAR") {
      const currentCount = countUserRequestsThisWeek(userId, date);
      const alreadyExists = requestsCache.has(key);

      if (!alreadyExists && currentCount >= MAX_REQUESTS_PER_WEEK) {
        alert("You can only enter 5 requests per week.");
        closeShiftModal();
        return;
      }
    }


    /* -----------------------------
       Optimistic UI update
       ----------------------------- */
 if (shift === "CLEAR") {
  td.textContent = "";
  delete pendingEdits[key];
} else if (shift === "O") {
  if (rankToSave === 1) td.textContent = "OÂ¹";
else if (rankToSave === 2) td.textContent = "OÂ²";
else if (rankToSave === 3) td.textContent = "OÂ³";
else td.textContent = "O";

  pendingEdits[key] = { userId, date, shift, important_rank: rankToSave };
} else {
  td.textContent = shift;
  pendingEdits[key] = { userId, date, shift, important_rank: null };
}

    closeShiftModal();
/* -----------------------------
   Auto-save to Supabase
   ----------------------------- */
try {
  if (shift === "CLEAR") {
    await deleteRequestCell(userId, date);
    requestsCache.delete(key);
    delete pendingEdits[key];
    toast(`Cleared + saved (${key})`);
  } else {
    const saved = await upsertRequestCell(
      userId,
      date,
      shift,
      rankToSave
    );

    requestsCache.set(key, saved);
    delete pendingEdits[key];
    toast(`Saved (${key}) = ${shift}`);
  }
} catch (err) {
  console.error("Auto-save failed:", err);

  const msg =
    err?.message ||
    err?.error?.message ||
    err?.details ||
    JSON.stringify(err);

// Revert UI to last known good state (pendingEdits first, then saved)
const pe = pendingEdits[key];
const existing = requestsCache.get(key);

const row = pe ? { value: pe.shift, important_rank: pe.important_rank } : existing;
if (row?.value === "O") {
  if (row.important_rank === 1) td.textContent = "OÂ¹";
  else if (row.important_rank === 2) td.textContent = "OÂ²";
  else if (row.important_rank === 3) td.textContent = "OÂ³";
  else td.textContent = "O";
} else {
  td.textContent = row?.value || "";
}



  delete pendingEdits[key];

  if ((msg || "").toLowerCase().includes("max 5")) {
    alert("Max 5 requests per week. Clear one day to pick another.");
    return;
  }

  if ((msg || "").toLowerCase().includes("priority") ||
      (msg || "").toLowerCase().includes("max 2")) {
    alert("You can only have 2 priority OFF requests per week.");
    return;
  }

  alert("Save failed. Check console.");
}
  });
});


    /* =========================================================
   PATCH 2B) AUTO-SAVE (write to Supabase after each selection)
   ========================================================= */

function toast(msg){
  // tiny, non-annoying feedback. If you hate it, delete it.
  console.log(msg);
}

// Upsert a single cell to Supabase
async function upsertRequestCell(userId, date, value, importantRank){
  const payload = {
    user_id: userId,
    date: date,
    value: value === "" ? null : value,
    important_rank: importantRank ?? null
  };

  const { data, error } = await supabaseClient
    .from("requests")
    .upsert(payload, { onConflict: "user_id,date" })
    .select("id, user_id, date, value, important_rank")
    .single();

  if (error) throw error;
  return data;
}


// Delete a cell completely (optional, but nice for CLEAR)
async function deleteRequestCell(userId, date){
  const { error } = await supabaseClient
    .from("requests")
    .delete()
    .eq("user_id", userId)
    .eq("date", date);

  if (error) throw error;
}

    
/* =========================================================
   7) DATA LOADING (users + dates + requests)
   ========================================================= */
async function loadRota() {
  // -----------------------------
  // 7A) Load users
  // -----------------------------
  const { data: users, error: userError } = await supabaseClient
    .from("users")
    .select("id, name, role_id, is_admin, roles(name)")
    .order("name");

  if (userError) {
    console.error("Users load error:", userError);
    alert("Failed to load users.");
    return;
  }

  // -----------------------------
  // 7B) Restore login (localStorage)
  // -----------------------------
  const savedId = localStorage.getItem(STORAGE_KEY);
  if (savedId) {
    const found = users.find(u => u.id === savedId);
    if (found) currentUser = found;
  }

  // -----------------------------
  // 7C) Load rota dates
  // -----------------------------
  const { data: dates, error: dateError } = await supabaseClient
    .from("rota_dates")
    .select("date, rota_weeks(open)")
    .order("date");

  if (dateError) {
    console.error("Dates load error:", dateError);
    alert("Failed to load dates.");
    return;
  }

  // -----------------------------
  // 7D) Load requests for visible date range
  // -----------------------------
  // Clear cache first so refresh doesn't stack old data
  if (typeof requestsCache !== "undefined" && requestsCache?.clear) {
    requestsCache.clear();
  }

  const dateMin = dates[0]?.date;
  const dateMax = dates[dates.length - 1]?.date;

  if (dateMin && dateMax) {
    const { data: reqs, error: reqErr } = await supabaseClient
      .from("requests")
      .select("id, user_id, date, value, important_rank")
      .gte("date", dateMin)
      .lte("date", dateMax);

    if (reqErr) {
      console.error("Requests load error:", reqErr);
      alert("Failed to load requests.");
      return;
    }

    // Store in cache: key = userId_date
    if (typeof requestsCache !== "undefined" && requestsCache?.set) {
      for (const r of reqs || []) {
        requestsCache.set(`${r.user_id}_${r.date}`, r);
      }
    }
  }

  // -----------------------------
  // 7E) Render table (weeks + users)
  // -----------------------------
  const weeks = groupDatesIntoWeeks(dates);
  render(users, weeks);

  // Period label
  if (weeks.length) {
    document.getElementById("periodLabel").textContent =
      `${fmt(weeks[0].weekStart)} â€“ ${fmt(weeks[weeks.length - 1].weekEnd)} (Sunâ€“Sat weeks)`;
  }

  // Apply locks + badges
  applyUnlockState();
  updateBadges();
}

    /* =========================================================
   8) RENDER (table header + grouped rows)
   ========================================================= */
function render(users, weeks){
  const table = document.getElementById("rota");
  table.innerHTML = "";

  const thead = document.createElement("thead");
  const tbody = document.createElement("tbody");
  table.appendChild(thead);
  table.appendChild(tbody);

  // ----- Header row 1: week labels
  const r1 = document.createElement("tr");
  const hName = document.createElement("th");
  hName.className = "name-col";
  hName.textContent = "Name";
  r1.appendChild(hName);

  weeks.forEach((w, idx) => {
    const th = document.createElement("th");
    th.className = "week-head " + (w.open ? "" : "closed");

    th.colSpan = 7;
    th.innerHTML = `
  <span class="week-label">${fmt(w.weekStart)} â€“ ${fmt(w.weekEnd)}</span>
  <button
    class="week-comment-btn"
    type="button"
   data-week-id="${w.days[0]?.rota_weeks?.id || ""}"


    title="Week comment"
  >ðŸ’¬</button>
`;
    r1.appendChild(th);

    if(idx !== weeks.length - 1){
      const sep = document.createElement("th");
      sep.className = "week-sep";
      r1.appendChild(sep);
    }
  });
  thead.appendChild(r1);

  // ----- Header row 2: day letters
  const r2 = document.createElement("tr");
  const blank2 = document.createElement("th");
  blank2.className = "name-col";
  blank2.textContent = "";
  r2.appendChild(blank2);

  const dayLetters = ["S","M","T","W","T","F","S"];
  weeks.forEach((w, idx) => {
    for(let i=0;i<7;i++){
      const th = document.createElement("th");
      th.className = "day " + (w.open ? "" : "closed");
      th.textContent = dayLetters[i];
      r2.appendChild(th);
    }
    if(idx !== weeks.length - 1){
      const sep = document.createElement("th");
      sep.className = "week-sep";
      r2.appendChild(sep);
    }
  });
  thead.appendChild(r2);

  // ----- Header row 3: date numbers
  const r3 = document.createElement("tr");
  const blank3 = document.createElement("th");
  blank3.className = "name-col";
  blank3.textContent = "";
  r3.appendChild(blank3);

  weeks.forEach((w, idx) => {
    for(let i=0;i<7;i++){
      const d = new Date(w.days[i].date);
      const isWeekend = (i === 0 || i === 6);
      const th = document.createElement("th");
      th.className = "date " + (w.open ? "" : "closed") + (isWeekend ? " weekend" : "");
      th.textContent = d.getDate();
      r3.appendChild(th);
    }
    if(idx !== weeks.length - 1){
      const sep = document.createElement("th");
      sep.className = "week-sep";
      r3.appendChild(sep);
    }
  });
  thead.appendChild(r3);

  // ----- Body grouped by role
  const groups = groupUsers(users);

  for(const g of groups){
    // section header row
    const sectionTr = document.createElement("tr");
    sectionTr.className = "section-row";

    const sectionTd = document.createElement("td");
    sectionTd.className = `name-col ${g.className}`;
    sectionTd.colSpan = 1 + (weeks.length * 7) + (weeks.length - 1);
    sectionTd.innerHTML = `<span>${g.title}</span>`;
    sectionTr.appendChild(sectionTd);
    tbody.appendChild(sectionTr);

    // user rows
    for(const u of g.items){
      const tr = document.createElement("tr");
      tr.dataset.userId = u.id;

      // name cell (PIN login)
      const nameTd = document.createElement("td");
      nameTd.className = "name-col";
      nameTd.textContent = u.name;
      nameTd.addEventListener("click", () => openPinModal(u));
      tr.appendChild(nameTd);

      // date cells
      weeks.forEach((w, idx) => {
        for(let i=0;i<7;i++){
          const isWeekend = (i === 0 || i === 6);
          const dateStr = w.days[i].date;

          const td = document.createElement("td");
          td.className = "cell" + (w.open ? "" : " closed") + (isWeekend ? " weekend" : "");
          td.dataset.userId = u.id;
          td.dataset.date = dateStr;

          // âœ… Fill from cache / pending edits
          const key = `${u.id}_${dateStr}`;

          // Pending edits override everything visually
if (pendingEdits[key]) {
  const pe = pendingEdits[key];

if (pe.shift === "O") {
  if (pe.important_rank === 1) td.textContent = "OÂ¹";
  else if (pe.important_rank === 2) td.textContent = "OÂ²";
  else if (pe.important_rank === 3) td.textContent = "OÂ³";
  else td.textContent = "O";
} else {
  td.textContent = pe.shift || "";
}

} else {
  const r = requestsCache.get(key);

if (r?.value === "O") {
  if (r.important_rank === 1) td.textContent = "OÂ¹";
  else if (r.important_rank === 2) td.textContent = "OÂ²";
  else if (r.important_rank === 3) td.textContent = "OÂ³";
  else td.textContent = "O";
}
}
          

          tr.appendChild(td);
        }

        if(idx !== weeks.length - 1){
          const sep = document.createElement("td");
          sep.className = "week-sep";
          tr.appendChild(sep);
        }
      });

      tbody.appendChild(tr);
    }
  }

  // Keep your existing logic
  applyUnlockState();
  updateBadges();
}


    /* =========================================================
       9) UNLOCK LOGIC (who can edit which row)
       ========================================================= */
    function applyUnlockState(){
      const rows = document.querySelectorAll("#rota tbody tr");

      rows.forEach(r => {
        if(r.classList.contains("section-row")) return;

        const userId = r.dataset.userId;
        const isUnlocked =
          currentUser && (currentUser.is_admin || currentUser.id === userId);

        r.classList.toggle("unlocked", !!isUnlocked);
        r.classList.toggle("locked", !isUnlocked);

        r.querySelectorAll("td.cell").forEach(td => {
          td.classList.toggle("editable", !!isUnlocked);

          // bind once
          if (!td.dataset.bound) {
            td.dataset.bound = "1";
            td.addEventListener("click", () => {
              if (!td.classList.contains("editable")) return;

              activeCell = {
                td,
                userId: td.dataset.userId,
                date: td.dataset.date
              };

              console.log("Cell selected:", activeCell);
              openShiftModal();
            });
          }
        });
      });
    


    /* =========================================================
       10) BOOT
       ========================================================= */
    loadRota();
  </script>
</body>
</html>






































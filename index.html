<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calpe Ward Off Duty Requests</title>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --grid: #d9d9d9;
      --grid-soft: #ececec;
      --text: #111;
      --muted: #6b6b6b;
      --header: #f4f4f4;
      --sheet-bg: #ffffff;
      --sep: #c0c0c0;
      --sep-fill: #e3e3e3;

      --closed-fill: #f0f0f0;
      --weekend-fill: #fafafa;

      /* Brighter Excel-like section bands */
      --cn-band: #ffd18a; /* warm yellow/orange */
      --sn-band: #9fd0ff; /* bright blue */
      --na-band: #a8e6a1; /* bright green */
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 18px;
      color: var(--text);
      background: #f7f7f7;
    }

    .wrap{
      background: var(--sheet-bg);
      border: 1px solid var(--grid);
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 14px 14px 10px;
      overflow: auto;
    }

    .titlebar{
      display:flex;
      align-items: baseline;
      gap: 12px;
      margin: 2px 2px 12px;
    }

    h1{
      font-size: 22px;
      margin: 0;
      font-weight: 750;
      letter-spacing: 0.2px;
    }

    .subtitle{
      font-size: 13px;
      color: var(--muted);
    }

    table{
      border-collapse: separate;
      border-spacing: 0;
      width: max-content;
      min-width: 100%;
      font-size: 12px;
    }

    th, td{
      border-right: 1px solid var(--grid-soft);
      border-bottom: 1px solid var(--grid-soft);
      text-align: center;
      vertical-align: middle;
      padding: 0;
      height: 24px;
      background: #fff;
      min-width: 34px;
    }

    /* outer border */
    table tr:first-child th{ border-top: 1px solid var(--grid); }
    table tr th:first-child,
    table tr td:first-child{ border-left: 1px solid var(--grid); }
    table tr:last-child td{ border-bottom: 1px solid var(--grid); }
    table tr th{ border-bottom: 1px solid var(--grid); }

    /* sticky header */
    thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--header);
    }

    /* sticky name column */
    .name-col{
      position: sticky;
      left: 0;
      z-index: 6;
      background: #fff;
      text-align: left;
      padding: 0 10px;
      min-width: 220px;
      font-weight: 650;
      border-right: 2px solid var(--sep);
    }
    thead .name-col{
      background: var(--header);
      z-index: 10;
      font-weight: 750;
    }

    th.week-label{
      font-weight: 800;
      font-size: 12px;
      letter-spacing: 0.2px;
      color: #222;
      height: 28px;
      background: #ededed;
      border-bottom: 1px solid var(--grid);
    }

    th.day{
      font-weight: 800;
      background: var(--header);
      height: 22px;
      color: #222;
    }

    th.date{
      font-weight: 700;
      background: var(--header);
      height: 22px;
      color: #222;
    }

    /* Week separator column */
    .week-sep{
      min-width: 14px;
      width: 14px;
      background: var(--sep-fill) !important;
      border-right: 2px solid var(--sep) !important;
      border-left: 0 !important;
    }
    thead .week-sep{ background: var(--sep-fill) !important; }

    /* Closed week cells */
    .closed{
      background: var(--closed-fill) !important;
      color: #9b9b9b;
    }

    /* Weekend shading */
    .weekend{ background: var(--weekend-fill); }

    /* Section band rows */
    tr.section-row td{
      height: 22px;
      font-weight: 850;
      text-align: left;
      padding: 0 10px;
      border-top: 2px solid #9a9a9a;
      border-bottom: 2px solid #9a9a9a;
    }
    tr.section-row td span{
      color: #1b1b1b;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    td.section-cn { background: var(--cn-band) !important; }
    td.section-sn { background: var(--sn-band) !important; }
    td.section-na { background: var(--na-band) !important; }

    td.cell{
      font-size: 12px;
      color: #111;
    }
    td.cell:hover{ background: #f6fbff; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="titlebar">
      <h1>Calpe Ward Requests</h1>
      <div class="subtitle" id="periodLabel"></div>
    </div>

    <table id="rota"></table>
  </div>

  <script>
    const supabaseClient = window.supabase.createClient(
      "https://tbclufdtyefexwwitfsz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiY2x1ZmR0eWVmZXh3d2l0ZnN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwODA4ODksImV4cCI6MjA4MjY1Njg4OX0.OYnj44QQCTD-5tqR2XSVt4oQso9Ol8ZLH2tLsRGIreA"
    );

    const fmt = (d) => d.toLocaleDateString("en-GB", { day: "numeric", month: "short" });
    const isoDate = (d) => d.toISOString().slice(0,10);

    function startOfWeekSunday(dateObj){
      const d = new Date(dateObj);
      const day = d.getDay(); // Sunday=0
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() - day);
      return d;
    }

    function addDays(d, n){
      const x = new Date(d);
      x.setDate(x.getDate() + n);
      return x;
    }

    function groupDatesIntoWeeks(dates){
      const map = new Map();

      for(const item of dates){
        const d = new Date(item.date);
        const ws = startOfWeekSunday(d);
        const key = isoDate(ws);

        if(!map.has(key)){
          map.set(key, {
            weekStart: ws,
            days: [],
            open: (item.rota_weeks && item.rota_weeks.open) ?? true
          });
        }
        map.get(key).days.push(item);
      }

      const weeks = [];
      for(const w of map.values()){
        const dayLookup = new Map(w.days.map(x => [x.date, x]));
        const ordered = [];

        for(let i=0;i<7;i++){
          const dd = addDays(w.weekStart, i);
          const ds = isoDate(dd);
          const row = dayLookup.get(ds) || { date: ds, rota_weeks: { open: w.open } };
          ordered.push(row);
        }

        weeks.push({
          weekStart: w.weekStart,
          weekEnd: addDays(w.weekStart, 6),
          open: w.open,
          days: ordered
        });
      }

      weeks.sort((a,b) => a.weekStart - b.weekStart);
      return weeks;
    }

    function groupUsers(users){
      const buckets = { charge_nurse: [], staff_nurse: [], nursing_assistant: [] };

      for(const u of users){
        const label = u.roles?.name || (
          u.role_id === 1 ? "charge_nurse" :
          u.role_id === 2 ? "staff_nurse" :
          u.role_id === 3 ? "nursing_assistant" : "staff_nurse"
        );
        (buckets[label] || buckets.staff_nurse).push(u);
      }

      return [
        { key: "charge_nurse", title: "Charge Nurses", className: "section-cn", items: buckets.charge_nurse },
        { key: "staff_nurse", title: "Staff Nurses", className: "section-sn", items: buckets.staff_nurse },
        { key: "nursing_assistant", title: "Nursing Assistants", className: "section-na", items: buckets.nursing_assistant }
      ].filter(g => g.items.length > 0);
    }

    async function loadRota(){
      const { data: users, error: userError } = await supabaseClient
        .from("users")
        .select("id, name, role_id, can_edit, roles(name)")
        .order("name");

      if(userError){
        console.error(userError);
        alert("Failed to load users");
        return;
      }

      const { data: dates, error: dateError } = await supabaseClient
        .from("rota_dates")
        .select(`date, rota_weeks(open)`)
        .order("date");

      if(dateError){
        console.error(dateError);
        alert("Failed to load dates");
        return;
      }

      const weeks = groupDatesIntoWeeks(dates);
      render(users, weeks);

      if(weeks.length){
        const first = weeks[0].weekStart;
        const last = weeks[weeks.length-1].weekEnd;
        document.getElementById("periodLabel").textContent =
          `${fmt(first)} – ${fmt(last)} (Sun–Sat weeks)`;
      }
    }

    function render(users, weeks){
      const table = document.getElementById("rota");
      table.innerHTML = "";

      const thead = document.createElement("thead");
      const tbody = document.createElement("tbody");
      table.appendChild(thead);
      table.appendChild(tbody);

      // Row 1: week ranges
      const r1 = document.createElement("tr");
      const hName = document.createElement("th");
      hName.className = "name-col";
      hName.textContent = "Name";
      r1.appendChild(hName);

      weeks.forEach((w, idx) => {
        const th = document.createElement("th");
        th.className = "week-label " + (w.open ? "" : "closed");
        th.colSpan = 7;
        th.textContent = `${fmt(w.weekStart)} – ${fmt(w.weekEnd)}`;
        r1.appendChild(th);

        if(idx !== weeks.length - 1){
          const sep = document.createElement("th");
          sep.className = "week-sep";
          r1.appendChild(sep);
        }
      });
      thead.appendChild(r1);

      // Row 2: day letters
      const r2 = document.createElement("tr");
      const blank2 = document.createElement("th");
      blank2.className = "name-col";
      blank2.textContent = "";
      r2.appendChild(blank2);

      const dayLetters = ["S","M","T","W","T","F","S"];
      weeks.forEach((w, idx) => {
        for(let i=0;i<7;i++){
          const th = document.createElement("th");
          th.className = "day " + (w.open ? "" : "closed");
          th.textContent = dayLetters[i];
          r2.appendChild(th);
        }
        if(idx !== weeks.length - 1){
          const sep = document.createElement("th");
          sep.className = "week-sep";
          r2.appendChild(sep);
        }
      });
      thead.appendChild(r2);

      // Row 3: date numbers
      const r3 = document.createElement("tr");
      const blank3 = document.createElement("th");
      blank3.className = "name-col";
      blank3.textContent = "";
      r3.appendChild(blank3);

      weeks.forEach((w, idx) => {
        for(let i=0;i<7;i++){
          const d = new Date(w.days[i].date);
          const isWeekend = (i === 0 || i === 6);
          const th = document.createElement("th");
          th.className = "date " + (w.open ? "" : "closed") + (isWeekend ? " weekend" : "");
          th.textContent = d.getDate();
          r3.appendChild(th);
        }
        if(idx !== weeks.length - 1){
          const sep = document.createElement("th");
          sep.className = "week-sep";
          r3.appendChild(sep);
        }
      });
      thead.appendChild(r3);

      // Body: grouped users
      const groups = groupUsers(users);

      for(const g of groups){
        const sectionTr = document.createElement("tr");
        sectionTr.className = "section-row";

        const sectionTd = document.createElement("td");
        sectionTd.className = `name-col ${g.className}`;
        sectionTd.colSpan = 1 + (weeks.length * 7) + (weeks.length - 1);
        sectionTd.innerHTML = `<span>${g.title}</span>`;
        sectionTr.appendChild(sectionTd);
        tbody.appendChild(sectionTr);

        for(const u of g.items){
          const tr = document.createElement("tr");

          const nameTd = document.createElement("td");
          nameTd.className = "name-col";
          nameTd.textContent = u.name;
          tr.appendChild(nameTd);

          weeks.forEach((w, idx) => {
            for(let i=0;i<7;i++){
              const isWeekend = (i === 0 || i === 6);
              const td = document.createElement("td");
              td.className = "cell" + (w.open ? "" : " closed") + (isWeekend ? " weekend" : "");
              td.dataset.userId = u.id;
              td.dataset.date = w.days[i].date;
              td.textContent = "";
              tr.appendChild(td);
            }
            if(idx !== weeks.length - 1){
              const sep = document.createElement("td");
              sep.className = "week-sep";
              tr.appendChild(sep);
            }
          });

          tbody.appendChild(tr);
        }
      }
    }

    loadRota();
  </script>
</body>
</html>

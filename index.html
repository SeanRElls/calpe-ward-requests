<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calpe Ward Off Duty Requests</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
/* =========================================================
   0. CSS VARIABLES / THEME
   ========================================================= */
:root{
  --bg:#f7f7f7;
  --sheet:#ffffff;
  --grid:#d9d9d9;
  --grid-soft:#ececec;
  --header:#f4f4f4;
  --sep:#bdbdbd;
  --sep-fill:#e3e3e3;
  --text:#111;
  --muted:#6b6b6b;

  --cn:#ffd18a;
  --sn:#9fd0ff;
  --na:#a8e6a1;

  --closed:#f0f0f0;
}

/* =========================================================
   1. BASE LAYOUT
   ========================================================= */
body{
  margin:14px;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
  color:var(--text);
}

.wrap{
  background:var(--sheet);
  border:1px solid var(--grid);
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,.05);
  padding:14px;
  overflow:auto;
}

.titlebar{
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:12px;
}

h1{
  margin:0;
  font-size:22px;
  font-weight:800;
}

.subtitle{
  font-size:13px;
  color:var(--muted);
}

.controls{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

.badge{
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  background:#eee;
}

.badge.admin{
  background:#111;
  color:#fff;
}

button{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #ccc;
  background:#f7f7f7;
  font-size:13px;
}

button.primary{
  background:#111;
  color:#fff;
  border-color:#111;
}

/* =========================================================
   2. TABLE
   ========================================================= */
table{
  border-collapse:separate;
  border-spacing:0;
  min-width:100%;
  width:max-content;
  font-size:12px;
}

th,td{
  border-right:1px solid var(--grid-soft);
  border-bottom:1px solid var(--grid-soft);
  min-width:34px;
  height:26px;
  text-align:center;
}

thead th{
  position:sticky;
  top:0;
  background:var(--header);
  z-index:5;
}

.name-col{
  position:sticky;
  left:0;
  z-index:6;
  background:#fff;
  min-width:200px;
  text-align:left;
  padding:0 10px;
  font-weight:700;
  border-right:2px solid var(--sep);
}

thead .name-col{
  background:var(--header);
  z-index:10;
}

.week-label{
  background:#ededed;
  font-weight:800;
}

.week-sep{
  width:14px;
  background:var(--sep-fill);
  border-right:2px solid var(--sep);
}

.section-row td{
  font-weight:800;
  padding-left:10px;
}

.section-cn{background:var(--cn);}
.section-sn{background:var(--sn);}
.section-na{background:var(--na);}

.cell{
  cursor:pointer;
}

.cell.locked{
  background:var(--closed);
  color:#999;
  cursor:default;
}

/* =========================================================
   3. MODAL (PIN + CELL EDITOR)
   ========================================================= */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  align-items:flex-end;
  justify-content:center;
  z-index:1000;
}

.modal{
  background:#fff;
  width:100%;
  max-width:520px;
  border-radius:16px 16px 0 0;
  padding:16px;
}

.modal h2{
  margin:0 0 8px;
}

.modal .options{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  margin-top:10px;
}

.modal .options button{
  font-size:14px;
}

/* =========================================================
   4. MOBILE
   ========================================================= */
@media(min-width:700px){
  .modal-backdrop{
    align-items:center;
  }
  .modal{
    border-radius:16px;
  }
}
</style>
</head>

<body>

<div class="wrap">
  <div class="titlebar">
    <div>
      <h1>Calpe Ward Requests</h1>
      <div class="subtitle" id="periodLabel"></div>
    </div>
    <div class="controls">
      <select id="periodSelect"></select>
      <span class="badge" id="loginBadge">Not logged in</span>
      <span class="badge admin" id="adminBadge" style="display:none">ADMIN</span>
      <button id="logoutBtn" style="display:none">Logout</button>
    </div>
  </div>

  <table id="rota"></table>
</div>

<!-- MODAL -->
<div class="modal-backdrop" id="editorBackdrop">
  <div class="modal">
    <h2 id="editorTitle"></h2>
    <div class="options">
      <button data-value="O">O</button>
      <button data-value="O1">O – Important 1</button>
      <button data-value="O2">O – Important 2</button>
      <button data-value="LD">LD</button>
      <button data-value="8-8">8-8</button>
      <button data-value="N">N</button>
      <button data-value="W">W</button>
      <button data-value="CLEAR">Clear</button>
    </div>
  </div>
</div>

<script>
/* =========================================================
   5. CONFIG
   ========================================================= */
const SUPABASE_URL = "https://tbclufdtyefexwwitfsz.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiY2x1ZmR0eWVmZXh3d2l0ZnN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwODA4ODksImV4cCI6MjA4MjY1Njg4OX0.OYnj44QQCTD-5tqR2XSVt4oQso9Ol8ZLH2tLsRGIreA";
const STORAGE_KEY = "calpeward.user";

/* =========================================================
   6. GLOBAL STATE
   ========================================================= */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

let periods=[], users=[], weeks=[], requests=[];
let currentPeriod=null;
let currentUser=null;
let activeCell=null;

/* =========================================================
   7. AUTH (PIN already solved, session restore only)
   ========================================================= */
const saved = localStorage.getItem(STORAGE_KEY);
if(saved) currentUser = JSON.parse(saved);

if(currentUser){
  document.getElementById("loginBadge").textContent = `Logged in: ${currentUser.name}`;
  document.getElementById("logoutBtn").style.display="inline-block";
  if(currentUser.is_admin) document.getElementById("adminBadge").style.display="inline-block";
}

document.getElementById("logoutBtn").onclick=()=>{
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
};

/* =========================================================
   8. DATA LOADING
   ========================================================= */
async function loadAll(){
  periods = (await sb.from("rota_periods").select("*").order("start_date")).data;
  users   = (await sb.from("users").select("*").order("name")).data;
  currentPeriod = periods.find(p=>p.is_active) || periods[0];

  populatePeriodSelect();
  await loadPeriodData();
}

async function loadPeriodData(){
  weeks = (await sb.from("rota_weeks").select("*").eq("period_id",currentPeriod.id).order("week_start")).data;
  requests = (await sb.from("requests").select("*")).data;
  render();
}

/* =========================================================
   9. PERIOD SELECTOR
   ========================================================= */
function populatePeriodSelect(){
  const sel=document.getElementById("periodSelect");
  sel.innerHTML="";
  periods.forEach(p=>{
    const o=document.createElement("option");
    o.value=p.id;
    o.textContent=`${p.start_date} – ${p.end_date}${p.is_active?" (Active)":""}`;
    if(p.id===currentPeriod.id) o.selected=true;
    sel.appendChild(o);
  });
  sel.onchange=()=>{
    currentPeriod=periods.find(p=>p.id===sel.value);
    loadPeriodData();
  };
}

/* =========================================================
   10. RENDER
   ========================================================= */
function render(){
  const table=document.getElementById("rota");
  table.innerHTML="";

  const thead=document.createElement("thead");
  const tbody=document.createElement("tbody");
  table.append(thead,tbody);

  const hr=document.createElement("tr");
  hr.innerHTML=`<th class="name-col">Name</th>`;
  weeks.forEach(w=>{
    const th=document.createElement("th");
    th.colSpan=7;
    th.className="week-label";
    th.textContent=`${w.week_start} – ${w.week_end}`;
    hr.appendChild(th);
    const sep=document.createElement("th");
    sep.className="week-sep";
    hr.appendChild(sep);
  });
  thead.appendChild(hr);

  users.forEach(u=>{
    const tr=document.createElement("tr");
    tr.dataset.uid=u.id;

    const name=document.createElement("td");
    name.className="name-col";
    name.textContent=u.name;
    tr.appendChild(name);

    weeks.forEach(w=>{
      for(let i=0;i<7;i++){
        const d=document.createElement("td");
        d.className="cell";
        d.textContent="";
        d.onclick=()=>openEditor(u,d);
        tr.appendChild(d);
      }
      const sep=document.createElement("td");
      sep.className="week-sep";
      tr.appendChild(sep);
    });

    tbody.appendChild(tr);
  });
}

/* =========================================================
   11. CELL EDITOR
   ========================================================= */
const backdrop=document.getElementById("editorBackdrop");
const editorTitle=document.getElementById("editorTitle");

function openEditor(user,cell){
  if(!currentUser) return;
  if(!currentUser.is_admin && user.id!==currentUser.id) return;

  activeCell={user,cell};
  editorTitle.textContent=`${user.name}`;
  backdrop.style.display="flex";
}

backdrop.onclick=e=>{
  if(e.target===backdrop) backdrop.style.display="none";
};

document.querySelectorAll(".modal button").forEach(btn=>{
  btn.onclick=()=>applyValue(btn.dataset.value);
});

function applyValue(v){
  if(!activeCell) return;
  if(v==="CLEAR"){
    activeCell.cell.textContent="";
  }else if(v==="O1"){
    activeCell.cell.textContent="O¹";
  }else if(v==="O2"){
    activeCell.cell.textContent="O²";
  }else{
    activeCell.cell.textContent=v;
  }
  backdrop.style.display="none";
}

/* =========================================================
   12. INIT
   ========================================================= */
loadAll();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calpe Ward Requests</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
/* =========================================================
   0) VARIABLES + BASE
   ========================================================= */
:root{
  --grid:#d9d9d9; --grid-soft:#ececec;
  --text:#111; --muted:#6b6b6b;
  --header:#f4f4f4; --sheet:#fff;
  --sep:#c0c0c0; --sep-fill:#e3e3e3;
  --cn:#ffd18a; --sn:#9fd0ff; --na:#a8e6a1;
}

body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  margin:16px; background:#f7f7f7; color:var(--text);
}

.wrap{
  background:var(--sheet);
  border:1px solid var(--grid);
  border-radius:10px;
  padding:14px;
  overflow:auto;
}

/* =========================================================
   1) HEADER
   ========================================================= */
.titlebar{
  display:flex; justify-content:space-between; gap:12px;
  margin-bottom:12px; flex-wrap:wrap;
}
h1{ margin:0; font-size:22px; }
.subtitle{ font-size:13px; color:var(--muted); }

.badge{
  font-size:12px; padding:4px 8px; border-radius:999px;
  background:#eee;
}
.badge.admin{ background:#111; color:#fff; }

/* =========================================================
   2) TABLE
   ========================================================= */
table{
  border-collapse:separate; border-spacing:0;
  width:max-content; min-width:100%; font-size:12px;
}

th,td{
  border-right:1px solid var(--grid-soft);
  border-bottom:1px solid var(--grid-soft);
  height:28px; min-width:36px;
  text-align:center;
}

thead th{
  position:sticky; top:0; z-index:5;
  background:var(--header);
}

.name-col{
  position:sticky; left:0; z-index:6;
  background:#fff;
  min-width:220px;
  padding:0 10px;
  font-weight:600;
  border-right:2px solid var(--sep);
  cursor:pointer;
}

.week-label{ font-weight:700; background:#ededed; }
.week-sep{
  width:14px; background:var(--sep-fill);
  border-right:2px solid var(--sep);
}

.section-row td{
  font-weight:700; text-align:left;
  padding-left:10px;
}
.section-cn{ background:var(--cn)!important; }
.section-sn{ background:var(--sn)!important; }
.section-na{ background:var(--na)!important; }

td.cell{
  cursor:pointer;
}
td.cell.locked{
  opacity:.5; cursor:not-allowed;
}

/* =========================================================
   3) MODALS
   ========================================================= */
.modal-backdrop{
  position:fixed; inset:0;
  display:none; justify-content:center; align-items:center;
  background:rgba(0,0,0,.35); z-index:1000;
}
.modal{
  background:#fff; border-radius:14px;
  padding:16px; width:min(360px,100%);
}
.modal h2{ margin-top:0; }

select,button,input{
  font-size:16px;
  padding:10px;
}

/* ========================================================= */
</style>
</head>

<body>
<div class="wrap">
  <div class="titlebar">
    <div>
      <h1>Calpe Ward Requests</h1>
      <div class="subtitle" id="periodLabel"></div>
    </div>
    <div>
      <span class="badge" id="loginBadge">Not logged in</span>
      <span class="badge admin" id="adminBadge" style="display:none;">ADMIN</span>
    </div>
  </div>

  <table id="rota"></table>
</div>

<!-- =========================================================
     PIN MODAL
     ========================================================= -->
<div class="modal-backdrop" id="pinModal">
  <div class="modal">
    <h2 id="pinTitle">Enter PIN</h2>
    <input id="pinInput" maxlength="4" inputmode="numeric" />
    <div style="margin-top:10px; display:flex; gap:10px;">
      <button id="pinCancel">Cancel</button>
      <button id="pinConfirm">Unlock</button>
    </div>
    <div id="pinErr" style="color:#b00020; display:none;">Wrong PIN</div>
  </div>
</div>

<!-- =========================================================
     SHIFT PICKER
     ========================================================= -->
<div class="modal-backdrop" id="shiftModal">
  <div class="modal">
    <h2>Select shift</h2>
    <select id="shiftSelect">
      <option value="">Clear</option>
      <option>LD</option>
      <option>8-8</option>
      <option>N</option>
      <option>W</option>
      <option>O</option>
    </select>
    <div style="margin-top:10px; display:flex; gap:10px;">
      <button id="shiftCancel">Cancel</button>
      <button id="shiftSave">Save</button>
    </div>
    <div id="shiftErr" style="color:#b00020; display:none;"></div>
  </div>
</div>

<script>
/* =========================================================
   4) CONFIG
   ========================================================= */
const SUPABASE_URL = "https://tbclufdtyefexwwitfsz.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiY2x1ZmR0eWVmZXh3d2l0ZnN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwODA4ODksImV4cCI6MjA4MjY1Njg4OX0.OYnj44QQCTD-5tqR2XSVt4oQso9Ol8ZLH2tLsRGIreA";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const STORAGE_KEY = "calpeward.user";

/* =========================================================
   5) STATE
   ========================================================= */
let users=[], weeks=[];
let currentUser=null;
let activeCell=null;

/* =========================================================
   6) AUTH
   ========================================================= */
const pinModal=document.getElementById("pinModal");
const pinInput=document.getElementById("pinInput");
const pinErr=document.getElementById("pinErr");

function openPin(user){
  window.selectedUser=user;
  pinModal.style.display="flex";
}
document.getElementById("pinConfirm").onclick=async()=>{
  const { data } = await supabase.rpc("verify_user_pin",{
    p_user_id:window.selectedUser.id,
    p_pin:pinInput.value
  });
  if(data){
    currentUser=window.selectedUser;
    localStorage.setItem(STORAGE_KEY,currentUser.id);
    pinModal.style.display="none";
    updateBadges();
    applyLocks();
  }else pinErr.style.display="block";
};
document.getElementById("pinCancel").onclick=()=>pinModal.style.display="none";

/* =========================================================
   7) DATA LOAD
   ========================================================= */
async function load(){
  const u = await supabase.from("users").select("*").order("name");
  users=u.data;

  const saved=localStorage.getItem(STORAGE_KEY);
  if(saved) currentUser=users.find(x=>x.id===saved);

  const d = await supabase.from("rota_dates").select("date,rota_weeks(open)").order("date");
  weeks = groupDates(d.data);
  render();
  updateBadges();
}
load();

/* =========================================================
   8) RENDER
   ========================================================= */
function render(){
  const t=document.getElementById("rota");
  t.innerHTML="";
  const tb=document.createElement("tbody");

  users.forEach(u=>{
    const tr=document.createElement("tr");
    tr.dataset.uid=u.id;

    const name=document.createElement("td");
    name.className="name-col";
    name.textContent=u.name;
    name.onclick=()=>openPin(u);
    tr.appendChild(name);

    weeks.forEach(w=>{
      w.days.forEach(d=>{
        const td=document.createElement("td");
        td.className="cell";
        td.onclick=()=>openShift(td,u,d.date);
        tr.appendChild(td);
      });
      tr.appendChild(document.createElement("td")).className="week-sep";
    });
    tb.appendChild(tr);
  });
  t.appendChild(tb);
  applyLocks();
}

/* =========================================================
   9) SHIFT EDITING + RULES
   ========================================================= */
const shiftModal=document.getElementById("shiftModal");
const shiftSelect=document.getElementById("shiftSelect");
const shiftErr=document.getElementById("shiftErr");

function openShift(td,user,date){
  if(!currentUser || (currentUser.id!==user.id && !currentUser.is_admin)) return;
  activeCell={td,user,date};
  shiftErr.style.display="none";
  shiftModal.style.display="flex";
}

document.getElementById("shiftSave").onclick=async()=>{
  const val=shiftSelect.value;
  // rules placeholder â€“ enforced server-side next
  await supabase.from("rota_requests").upsert({
    user_id:activeCell.user.id,
    date:activeCell.date,
    value:val
  });
  activeCell.td.textContent=val;
  shiftModal.style.display="none";
};
document.getElementById("shiftCancel").onclick=()=>shiftModal.style.display="none";

/* =========================================================
   10) LOCKING
   ========================================================= */
function applyLocks(){
  document.querySelectorAll("td.cell").forEach(td=>{
    td.classList.toggle("locked",!currentUser);
  });
}
function updateBadges(){
  const lb=document.getElementById("loginBadge");
  const ab=document.getElementById("adminBadge");
  if(currentUser){
    lb.textContent=`Logged in: ${currentUser.name}`;
    ab.style.display=currentUser.is_admin?"inline-block":"none";
  }
}

/* ========================================================= */
</script>
</body>
</html>

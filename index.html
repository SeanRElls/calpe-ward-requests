<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calpe Ward Off Duty Requests</title>

  <!-- Supabase JS (v2) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- =========================
       STYLES
       ========================= -->

  <style>
    :root{
      --grid: #d9d9d9;
      --grid-soft: #ececec;
      --text: #111;
      --muted: #6b6b6b;
      --header: #f4f4f4;
      --sheet-bg: #ffffff;
      --sep: #c0c0c0;
      --sep-fill: #e3e3e3;

      --closed-fill: #f0f0f0;
      --weekend-fill: #fafafa;

         --cn-band: #a8e6a1;
      --sn-band: #9fd0ff;
      --na-band: #ffd18a;
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 18px;
      color: var(--text);
      background: #f7f7f7;
    }

.wrap{
  background: var(--sheet-bg);
  border: 1px solid var(--grid);
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  padding: 10px;
  overflow: hidden;
  
}
/* Scroll container for the whole rota */
.rota-scroll{
  width: 100%;
  overflow: auto;                 /* both x + y */
  max-height: calc(100vh - 220px);/* adjust this number */
  -webkit-overflow-scrolling: touch;
  touch-action: pan-x pan-y;
}


/* ===== nice status pill for closeLabel ===== */
#closeLabel{
  margin-top: 6px;
}
.close-pill .msg{ font-weight: 650; }

    .close-pill{
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 999px;
  background: #f2f4f7;
  border: 1px solid #d7dbe0;
  color: #222;
  font-size: 12px;
  line-height: 1;
  white-space: nowrap;
}

    body.modal-open{
  overflow: hidden;
  
}
    
.close-pill .dot{
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: #2e7d32; /* green */
  flex: 0 0 auto;
}

.close-pill.is-soon{
  background: #fff4e5;
  border-color: #ffd59a;
}
.close-pill.is-soon .dot{ background:#d97706; } /* amber */

.close-pill.is-closed{
  background: #f3f3f3;
  border-color: #d0d0d0;
  color: #666;
}
.close-pill.is-closed .dot{ background:#888; }

.close-pill strong{
  font-weight: 750;
}

.close-pill .mini{
  opacity: 0.85;
}
.week-toggle-btn{
  min-height: 40px;
  padding: 10px 14px;
}
.close-pill .timeleft{
  font-variant-numeric: tabular-nums;
  font-weight: 750;
  padding: 4px 8px;
  border-radius: 999px;
  background: rgba(0,0,0,0.06);
}

#adminPeriodSelect{
  min-height: 40px;
}
    .titlebar{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin: 2px 2px 12px;
    }

    h1{
      font-size: 22px;
      margin: 0;
      font-weight: 750;
      letter-spacing: 0.2px;
    }

    .subtitle{
      font-size: 13px;
      color: var(--muted);
    }

    .rightbits{
      display:flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .badge{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background:#eee;
      color:#222;
      white-space: nowrap;
    }

    .badge.admin{
      background:#222;
      color:#fff;
    }

  .week-toggle-btn{
  flex: 0 0 auto;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: fit-content;
  padding: 6px 10px;
  min-width: 0;
  border-radius: 999px;
  font-size: 12px;
  line-height: 1;
}

    table{
      border-collapse: separate;
      border-spacing: 0;
      width: max-content;
      min-width: 100%;
      font-size: 12px;
    }

    th, td{
      border-right: 1px solid var(--grid-soft);
      border-bottom: 1px solid var(--grid-soft);
      text-align: center;
      vertical-align: middle;
      padding: 0;
      height: 24px;
      background: #fff;
      min-width: 34px;
    }

    table tr:first-child th{ border-top: 1px solid var(--grid); }
    table tr th:first-child, table tr td:first-child{ border-left: 1px solid var(--grid); }
    table tr:last-child td{ border-bottom: 1px solid var(--grid); }
    table tr th{ border-bottom: 1px solid var(--grid); }

    thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--header);
    }

.name-col{
  position: sticky;
  left: 0;
  z-index: 6;
  background: #fff;
  text-align: left;
  padding: 0 8px;
  font-weight: 650;
  border-right: 2px solid var(--sep);

  width: clamp(140px, 38vw, 220px);
  min-width: clamp(140px, 38vw, 220px);
  max-width: clamp(140px, 38vw, 220px);

  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

    thead .name-col{
      background: var(--header);
      z-index: 10;
      font-weight: 750;
      cursor: default;
    }
    
@media (max-width: 480px){
  .name-col{
    font-size: 12px;
  }
}

  .week-comment-btn{
  flex: 0 0 auto;          /* stop flex stretching */
  min-width: 0 !important; /* override global min-width:110px */
  width: 22px;
  height: 22px;
  padding: 0;
  margin-left: 6px;

  display: inline-flex;
  align-items: center;
  justify-content: center;

  border: 1px solid #ccc;
  border-radius: 999px;
  background: #fff;
  cursor: pointer;
  font-size: 12px;
  line-height: 1;
}
.week-comment-btn.has-comment{
  border-color:#111;
  font-weight:700;
}
    
.week-label { font-weight: 600; }

    .header-subrow{
  display:flex;
  flex-wrap:wrap;
  gap: 8px;              /* <-- this is your "space after the badge" */
  align-items:center;
}
#periodLabel{ margin: 0; }
#closeLabel{ margin: 0; }
    th.week-label{
      font-weight: 800;
      font-size: 12px;
      letter-spacing: 0.2px;
      color: #222;
      height: 28px;
      background: #ededed;
    }

    th.day{
      font-weight: 800;
      height: 22px;
      color: #222;
    }

    th.date{
      font-weight: 700;
      height: 22px;
      color: #222;
    }

    .week-sep{
      min-width: 14px;
      width: 14px;
      background: var(--sep-fill) !important;
      border-right: 2px solid var(--sep) !important;
      border-left: 0 !important;
    }

    .closed{
      background: var(--closed-fill) !important;
      color: #9b9b9b;
    }

    .weekend{
      background: var(--weekend-fill);
    }
    
.badge.admin{
  cursor: pointer;
  user-select: none;
}

.badge.admin:hover{
  filter: brightness(0.9);
}

.badge.admin:active{
  transform: scale(0.97);
}
    tr.section-row td{
      height: 22px;
      font-weight: 850;
      text-align: left;
      padding: 0 10px;
      border-top: 2px solid #9a9a9a;
      border-bottom: 2px solid #9a9a9a;
    }

    tr.section-row td span{
      color: #1b1b1b;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    td.section-cn { background: var(--cn-band) !important; }
    td.section-sn { background: var(--sn-band) !important; }
    td.section-na { background: var(--na-band) !important; }

    td.cell{
      font-size: 12px;
      color: #111;
    }

    td.cell:hover{
      background: #f6fbff;
    }

    /* Locked vs unlocked rows */
    tr.locked td.cell{ opacity: 0.55; }
    tr.locked td.cell:hover{ background: #fff; }
    tr.unlocked td.cell{ opacity: 1; }
    tr.unlocked td.cell.editable{ outline: 2px solid rgba(0,0,0,0.08); cursor: pointer; }

    /* ===== MODALS (shared) ===== */
.modal-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  display: none;



  z-index: 1000;
  padding: 14px;
  padding-bottom: calc(14px + env(safe-area-inset-bottom));
  overflow: hidden;
  align-items: flex-start;
  justify-content: center;
}

.modal{
  width: min(520px, 100%);
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  padding: 14px;

  /* ✅ scrolling */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;

  /* ✅ REAL viewport height on modern mobile */
  max-height: calc(100dvh - 28px);

  /* ✅ keep last content reachable above iPhone home bar */
  padding-bottom: calc(14px + env(safe-area-inset-bottom));
}

/* ✅ fallback for older iOS that doesn't support dvh properly */
@supports not (height: 100dvh){
  .modal{ max-height: calc(100vh - 28px); }
}


    .modal h2{
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .modal p{
      margin: 0 0 12px 0;
      font-size: 13px;
      color: #444;
      line-height: 1.35;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items: stretch;
      flex-wrap: wrap;
    }

    input.pin{
      flex: 1 1 220px;
      font-size: 18px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid #ccc;
      letter-spacing: 10px;
      text-align: center;
      min-width: 220px;
    }

    .btns{
      display:flex;
      gap: 10px;
      flex: 1 1 200px;
      justify-content: flex-end;
      min-width: 200px;
    }

    button{
      font-size: 14px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #ccc;
      background: #f7f7f7;
      cursor: pointer;
      flex: 1;
      min-width: 110px;
    }

    
    button.primary{
      background:#111;
      border-color:#111;
      color:#fff;
    }

    button:disabled{
      opacity: 0.6;
      cursor: not-allowed;
    }

    .err{
      margin-top: 10px;
      font-size: 12px;
      color: #b00020;
      display:none;
    }

    @media (max-width: 480px){
      body{ margin: 12px; }
      .wrap{ padding: 12px; }
      .titlebar{ flex-direction: column; align-items: flex-start; }
      .rightbits{ justify-content: flex-start; }
      input.pin{ flex: 1 1 100%; min-width: 0; }
      .btns{ flex: 1 1 100%; min-width: 0; }
      button{ min-width: 0; }
    }


#adminUsersList{
  border: 1px solid #eceef2;
  border-radius: 14px;
  overflow: hidden;
  background: #fff;
}

.user-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
}

.user-meta{ min-width:0; }              /* allows name to shrink */
.user-name{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}



.user-actions button{
  white-space: nowrap;                  /* ✅ prevents button text wrapping */
}

.user-meta{
  min-width:0;
}

.user-name{
  font-weight: 600;           /* or 500 if you want even quieter */
  font-size: 13px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}




.user-actions{
  display:flex;
  gap: 6px;
  flex: 0 0 auto;
}

.user-tag{
  display:inline-block;
  margin-left: 6px;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 800;
  border: 1px solid #ddd;
  background: #f7f7f7;
  color: #333;
}

.user-tag.admin{
  background:#111;
  border-color:#111;
  color:#fff;
}

.user-tag.inactive{
  background:#f3f3f3;
  color:#666;
}

    #adminViewUsers #adminSaveUserBtn,
#adminViewUsers #adminCancelUserEditBtn{
  height: 36px;
  border-radius: 999px;
}

    /* ===== SHIFT PICKER ===== */
    .shift-grid{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 12px 0 16px;
    }

    .shift-btn{
      padding: 14px 0;
      font-size: 14px;
      border-radius: 12px;
      border: 1px solid #ccc;
      background: #f7f7f7;
      cursor: pointer;
      font-weight: 700;
    }

    .shift-btn:hover{
      background: #e9f2ff;
    }

    .shift-btn.off{
      background: #ffecec;
      border-color: #ffb3b3;
    }
    
#periodSelect{
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid #ccc;
  background: #fff;
  font-size: 12px;
  min-width: 220px;
  flex: 0 0 auto;
}

    .week-head { z-index: 9; }
.week-comment-btn { position: relative; z-index: 10; }

    
  @media (max-width: 480px){
  .shift-grid{
    grid-template-columns: repeat(2, 1fr);
  }
}

    /* =========================================================
   USER MODAL: reuse Admin styling so it doesn't look like 2009
   ========================================================= */

#userModal .modal{
  padding: 14px;
  border-radius: 16px;
  background: var(--card);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: var(--ink);
}

#userModal h2{
  font-size: 15px;
  font-weight: 800;
  letter-spacing: 0.2px;
  margin-bottom: 6px;
}

#userModal .subtitle{
  font-size: 12px;
  color: #667085;
}

/* Card blocks inside the modal */
#userModal .modal > div{
  border: 1px solid var(--line) !important;
  border-radius: 14px !important;
  background: #fff !important;
}

/* Inputs: match admin compact style */
#userModal input{
  box-sizing: border-box !important;
  height: 30px !important;
  padding: 4px 10px !important;
  border-radius: 10px !important;
  border: 1px solid var(--line) !important;
  font-size: 12px !important;
  background: #fff !important;
  letter-spacing: 2px !important; /* was comically wide */
  text-align: center;
  flex: 1 1 140px;
  min-width: 140px !important;
}

/* Buttons: same as admin */
#userModal button{
  box-sizing: border-box !important;
  height: 30px !important;
  padding: 0 12px !important;
  border-radius: 999px !important;
  font-size: 12px !important;
  min-width: auto !important;
  flex: 0 0 auto !important;
  border: 1px solid #d6dbe4 !important;
  background: #fff !important;
  color: var(--ink) !important;
}

#userModal button:hover{
  background: #f8fafc !important;
}

/* Primary button: match admin primary */
#userModal button.primary{
  background: var(--accent-weak) !important;
  border: 1px solid rgba(37,99,235,0.28) !important;
  color: var(--accent) !important;
  box-shadow: none !important;
}

#userModal button.primary:hover{
  background: var(--accent-weak-hover) !important;
  border-color: rgba(37,99,235,0.38) !important;
}

/* Tidy row + footer buttons */
#userModal .row{
  gap: 8px;
}

#userModal .btns{
  justify-content: flex-end;
  gap: 8px;
}

#userModal .btns:last-of-type{
  justify-content: space-between;
}

/* Optional: make the bottom actions not look like slabs */
#userLogout, #userClose{
  flex: 1 1 0 !important;
}

    
     /* =========================
   MOBILE HEADER LAYOUT (FINAL)
   ========================= */
@media (max-width: 520px){

  /* Title area tighter */
  .titlebar{
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
    margin: 0 0 10px;
  }

  h1{
    font-size: 20px;
    line-height: 1.1;
  }

  /* Space under Requests closed/open pill */
  #closeLabel{
    margin-top: 4px;
    margin-bottom: 8px;
  }

  .close-pill{
    padding: 6px 10px;
    gap: 8px;
    font-size: 11px;
  }

  .close-pill .timeleft{
    padding: 3px 7px;
    font-size: 11px;
  }

  .close-pill .mini{
    display: none;
  }

  /* RIGHT SIDE CONTROLS */
  .rightbits{
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: flex-start;
  }

  /* Dropdown takes full row */
  #periodSelect{
    flex: 1 1 100%;
    width: 100%;
    height: 34px;
    font-size: 12px;
    border-radius: 999px;
  }

  /* Logged-in + ADMIN sit together underneath */
  #loginBadge,
  #adminBadge{
    flex: 0 0 auto;
    font-size: 11px;
    padding: 6px 10px;
    white-space: nowrap;
  }
}
/* =========================================================
   ADMIN UI PATCH: compact, colored, tabs sticky
   ========================================================= */
:root{
--accent: #4F8DF7;                 /* softer, cleaner */
--accent-hover: #2F6FEA;           /* still blue, less harsh */
--accent-weak: rgba(79,141,247,0.16);
  --accent-weak-hover: rgba(79,141,247,0.24); /* ✅ add this */

  --ink: #0f172a;
  --card: #ffffff;
  --line: #e6e8ee;
  --soft: #f6f7fb;
}

/* Make ADMIN badge not "villain mode" */
.badge.admin{
  background: var(--accent);
  border: 1px solid rgba(0,0,0,0.06);
  color: #fff;
}

    
/* Admin modal container tighter + nicer */
#adminModal .modal{
  padding: 14px;
  border-radius: 16px;
  background: var(--card);
}

/* Sticky tab row (so it doesn't "disappear" when you scroll) */
#adminModal .modal > div:first-of-type{
  position: sticky;
  top: 0;
  z-index: 5;
  background: var(--card);
  padding-top: 6px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--line);
}

/* Tabs: compact segmented control style */
#adminTabPeriods, #adminTabGenerate, #adminTabUsers{
  height: 34px;
  padding: 0 12px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: #fff;
  font-size: 12px;
  font-weight: 750;
  color: var(--ink);
  min-width: 0;
  flex: 0 0 auto;
}
#adminTabPeriods.is-active,
#adminTabGenerate.is-active,
#adminTabUsers.is-active{
  background: var(--accent-weak);
border-color: rgba(37,99,235,0.22);
  color: var(--accent);
}

/* Buttons inside admin: smaller by default */
#adminModal button{
  box-sizing: border-box !important;
  height: 30px !important;
  padding: 0 10px !important;
  border-radius: 999px !important;
  font-size: 12px !important;
  min-width: auto !important;
  flex: 0 0 auto !important;  /* stops the "stretch to huge" look */
}

/* Primary action buttons: colored, not black */
#adminModal button.primary{
  background: var(--accent-weak) !important;
  border: 1px solid rgba(37,99,235,0.28) !important;
  color: var(--accent) !important;
  box-shadow: none !important;
}
#adminModal button.primary:hover{
  background: var(--accent-weak-hover) !important;
  border-color: rgba(37,99,235,0.38) !important;
}

/* keep ADMIN badge readable but not “villain button” */
.badge.admin{
  background: var(--accent-weak);
  border: 1px solid rgba(37,99,235,0.28);
  color: var(--accent);
  box-shadow: none;
}
.badge.admin:hover{
  background: var(--accent-weak-hover);
  border-color: rgba(37,99,235,0.38);
}
    
/* Cards inside admin: softer */
#adminViewUsers > div,
#adminViewPeriods > div,
#adminViewGenerate > div{
  border: 1px solid var(--line) !important;
  border-radius: 14px !important;
  background: #fff;
}

/* Inputs/selects: compact + clean */
#adminModal input,
#adminModal select{
  box-sizing: border-box !important;
  height: 30px !important;
  padding: 4px 8px !important;
  border-radius: 10px !important;
  border: 1px solid var(--line) !important;
  font-size: 12px !important;
  background: #fff !important;
}

/* Users list rows: tighter */
.user-row{
  padding: 8px 10px;
}
.user-name{
  font-size: 13px;
}
.user-role{
  font-size: 11px;
  color: #6b7280;
}

/* User action buttons: small and subtle */
.user-actions button{
  height: 30px !important;
  padding: 0 10px !important;
  border-radius: 999px !important;
  font-size: 12px !important;
  background: #fff !important;
  border: 1px solid #d6dbe4 !important;
  color: #0f172a !important;
}
.user-actions button:hover{
  background: #f8fafc !important;
}

/* Tags */
.user-tag.admin{
  background: var(--accent-weak);
  border-color: rgba(37,99,235,0.28);
  color: var(--accent);
}
.user-tag.inactive{
  background: #f1f2f6;
  border-color: #e2e5ee;
  color: #6b7280;
}
#adminModal .modal{
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: var(--ink);
}

#adminModal h2{
  font-size: 15px;
  font-weight: 800;
  letter-spacing: 0.2px;
}

#adminModal .subtitle{
  font-size: 12px;
  color: #667085;
}
  
    .user-group-title{
  padding: 10px 12px;
  font-weight: 800;
  font-size: 12px;
  color: #64748b;
  background: #f8fafc;
  border-top: 1px solid #eef2f7;
}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="titlebar">
     <div style="display:flex; gap:12px; align-items:center;">
  <img
    src="logo.png"
    alt="Calpe Ward"
    style="height:44px; width:auto;"
  />

<div>
  <h1>Calpe Ward Requests</h1>

  <div class="header-subrow">
    <div class="subtitle" id="periodLabel"></div>
    <div class="subtitle" id="closeLabel"></div>
  </div>
</div>
</div>
      <div class="rightbits">
        <select id="periodSelect"></select>
        <div class="badge" id="loginBadge">Not logged in</div>
        <div class="badge admin" id="adminBadge" style="display:none;">ADMIN</div>
       
      </div>
    </div>

   <div id="rotaScroll" class="rota-scroll">
  <table id="rota"></table>
</div>
  </div>

  <!-- =========================
       PIN MODAL (login)
       ========================= -->
  <div class="modal-backdrop" id="pinModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pinTitle">
      <h2 id="pinTitle">Enter PIN</h2>
      <p id="pinDesc">Enter your 4-digit PIN to unlock editing.</p>

      <div class="row">
        <input class="pin" id="pinInput" inputmode="numeric" maxlength="4" placeholder="••••" />
        <div class="btns">
          <button id="pinCancel" type="button">Cancel</button>
          <button class="primary" id="pinConfirm" type="button">Unlock</button>
        </div>
      </div>

      <div class="err" id="pinErr">Wrong PIN.</div>
    </div>
  </div>

  <!-- =========================
       SHIFT PICKER MODAL (Patch 2)
       ========================= -->
  <div class="modal-backdrop" id="shiftModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="shiftTitle">
      <h2 id="shiftTitle">Select shift</h2>
      <p id="shiftDesc">Choose a request for this day.</p>


      <div class="shift-grid">
        <button class="shift-btn" data-shift="LD" type="button">LD</button>
        <button class="shift-btn" data-shift="8-8" type="button">8–8</button>
        <button class="shift-btn" data-shift="N" type="button">N</button>
        <button class="shift-btn" data-shift="W" type="button">W</button>
        <button class="shift-btn off" data-shift="O" type="button">O</button>
        <button class="shift-btn" data-shift="CLEAR" type="button">Clear</button>
      </div>

      <div class="btns">
        <button id="shiftCancel" type="button">Cancel</button>
      </div>
    </div>
  </div>
 <!-- =========================
      COMMENTS 
       ========================= -->
  
  <div class="modal-backdrop" id="weekCommentModal" aria-hidden="true" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="weekCommentTitle">
    <h2 id="weekCommentTitle">Week comments</h2>

    <div id="weekCommentAdminList"
         style="display:none; max-height:260px; overflow:auto; border:1px solid #ddd; border-radius:8px; padding:8px; margin-bottom:10px;">
    </div>

    <label style="display:block; font-weight:600; margin:8px 0 6px;">Your comment</label>
    <textarea id="weekCommentInput" rows="4" style="width:100%;"></textarea>

    <div class="btns" style="margin-top:10px;">
      <button id="weekCommentCancel" type="button">Close</button>
      <button id="weekCommentSave" class="primary" type="button">Save</button>
    </div>
  </div>
</div>

  <!-- =========================
     ADMIN PANEL (v1)
     ========================= -->
<div class="modal-backdrop" id="adminModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
    <h2 id="adminTitle">Admin Console</h2>
    <p class="subtitle">Manage rota periods and generate new weeks.</p>

    <div style="display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 12px;">
<button id="adminTabPeriods" type="button" class="is-active">Rota periods</button>
<button id="adminTabGenerate" type="button">Generate</button>
<button id="adminTabUsers" type="button">Users</button>

    </div>

 <!-- TAB: PERIODS -->
<div id="adminViewPeriods">

  <!-- Period picker -->
  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
    <div style="font-weight:800;">Rota period</div>
    <select id="adminPeriodSelect" style="padding:8px 10px; border-radius:999px; border:1px solid #ccc; font-size:12px; min-width:220px;"></select>
    <div class="subtitle" id="adminPeriodMeta"></div>
  </div>

  <!-- Requests close time -->
  <div style="border:1px solid #ddd; border-radius:10px; padding:10px; margin-bottom:10px;">
    <div style="font-weight:800; margin-bottom:6px;">Requests closing time</div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <input id="adminClosesAtInput" type="datetime-local"
        style="padding:8px 10px; border-radius:10px; border:1px solid #ccc; font-size:12px;" />

      <button id="adminClosesAtSaveBtn" type="button"
        style="min-width:auto; padding:8px 10px; border-radius:999px; font-size:12px;">
        Save close time
      </button>

      <button id="adminClosesAtClearBtn" type="button"
        style="min-width:auto; padding:8px 10px; border-radius:999px; font-size:12px;">
        Clear
      </button>
    </div>

    <div class="subtitle" id="adminClosesAtHelp" style="margin-top:8px;">
      Set when requests will lock for this whole 5-week period.
    </div>
  </div>

  <!-- Period controls -->
  <div style="border:1px solid #ddd; border-radius:10px; padding:10px; margin-bottom:10px;">
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button id="adminSetActiveBtn" type="button" style="min-width:auto; padding:8px 10px; border-radius:999px; font-size:12px;">Set active</button>
      <button id="adminToggleHiddenBtn" type="button" style="min-width:auto; padding:8px 10px; border-radius:999px; font-size:12px;">Toggle hidden</button>
    </div>
  </div>

  <!-- Weeks list -->
  <div style="border:1px solid #ddd; border-radius:10px; padding:10px;">
    <div style="font-weight:800; margin-bottom:6px;">Weeks</div>
    <div id="adminWeeksList" class="subtitle">Pick a period…</div>
  </div>

</div>

    <!-- TAB: GENERATE -->
    <div id="adminViewGenerate" style="display:none;">
      <div style="border:1px solid #ddd; border-radius:10px; padding:10px;">
        <div style="font-weight:700; margin-bottom:6px;">Generate next 5-week period</div>
        <div class="subtitle" id="adminGeneratePreview">Preview will appear here.</div>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button id="adminGenerateBtn" class="primary" type="button">Generate</button>
        </div>
      </div>
    </div>
<!-- TAB: USERS -->
<div id="adminViewUsers" style="display:none;">

  <div style="border:1px solid #ddd; border-radius:10px; padding:10px; margin-bottom:10px;">
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
      <div style="font-weight:800;">Users</div>

      <label class="subtitle" style="display:flex; gap:6px; align-items:center;">
        <input type="checkbox" id="adminShowInactiveUsers" />
        Show inactive
      </label>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
      <input id="adminUserSearch" placeholder="Search name…"
        style="flex:1; min-width:180px; padding:8px 10px; border-radius:10px; border:1px solid #ccc; font-size:12px;" />

      <button id="adminAddUserBtn" class="primary" type="button"
        style="min-width:auto; padding:8px 12px; border-radius:999px; font-size:12px;">
        + Add user
      </button>
    </div>

    <div id="adminUsersList" style="margin-top:10px;"></div>
  </div>

  <div style="border:1px solid #ddd; border-radius:10px; padding:10px;">
    <div style="font-weight:800; margin-bottom:6px;">Add / Edit</div>

    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <input id="adminEditUserName" placeholder="Name"
        style="flex:1; min-width:180px; padding:8px 10px; border-radius:10px; border:1px solid #ccc; font-size:12px;" />

      <select id="adminEditUserRole"
        style="min-width:160px; padding:8px 10px; border-radius:10px; border:1px solid #ccc; font-size:12px;">
        <option value="1">Charge Nurse</option>
        <option value="2">Staff Nurse</option>
        <option value="3">Nursing Assistant</option>
      </select>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
      <input id="adminEditUserPin" placeholder="New PIN (4 digits)" inputmode="numeric" maxlength="4"
        style="flex:1; min-width:180px; padding:8px 10px; border-radius:10px; border:1px solid #ccc; font-size:12px;" />

      <button id="adminSaveUserBtn" class="primary" type="button"
        style="min-width:auto; padding:8px 12px; border-radius:999px; font-size:12px;">
        Save
      </button>

      <button id="adminCancelUserEditBtn" type="button"
        style="min-width:auto; padding:8px 12px; border-radius:999px; font-size:12px;">
        Cancel
      </button>
    </div>

    <div class="subtitle" id="adminUserEditHelp" style="margin-top:8px;"></div>
  </div>

</div>
    <div class="btns" style="margin-top:12px;">
      <button id="adminClose" type="button">Close</button>
    </div>
  </div>
</div>

  <!-- =========================
     USER MENU MODAL (Account)
     ========================= -->
<div class="modal-backdrop" id="userModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="userTitle">
    <h2 id="userTitle">Your account</h2>
    <p class="subtitle" id="userMeta">—</p>

    <div style="border:1px solid #ddd; border-radius:10px; padding:10px; margin:10px 0;">
      <div style="font-weight:800; margin-bottom:6px;">Change PIN</div>

      <div class="row" style="gap:8px;">
        <input id="userOldPin" class="pin" inputmode="numeric" maxlength="4" placeholder="Current PIN" style="letter-spacing:8px; min-width:160px;" />
        <input id="userNewPin" class="pin" inputmode="numeric" maxlength="4" placeholder="New PIN" style="letter-spacing:8px; min-width:160px;" />
        <input id="userNewPin2" class="pin" inputmode="numeric" maxlength="4" placeholder="Repeat new PIN" style="letter-spacing:8px; min-width:160px;" />
      </div>

      <div class="btns" style="margin-top:10px;">
        <button id="userSavePin" class="primary" type="button">Save new PIN</button>
      </div>

      <div class="err" id="userPinErr">Error.</div>
      <div class="subtitle" id="userPinOk" style="display:none; margin-top:8px; color:#0b6b2b; font-weight:700;">
        PIN updated.
      </div>
    </div>

    <div class="btns" style="margin-top:12px;">
      <button id="userLogout" type="button">Log out</button>
      <button id="userClose" type="button">Close</button>
    </div>
  </div>
</div>


  <script>
    /* =========================================================
       1) CONFIG
       ========================================================= */
    const SUPABASE_URL = "https://tbclufdtyefexwwitfsz.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiY2x1ZmR0eWVmZXh3d2l0ZnN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwODA4ODksImV4cCI6MjA4MjY1Njg4OX0.OYnj44QQCTD-5tqR2XSVt4oQso9Ol8ZLH2tLsRGIreA";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    const STORAGE_KEY = "calpeward.loggedInUserId";
    const MAX_REQUESTS_PER_WEEK = 5;

    /* =========================================================
       2) HELPERS (dates, formatting)
       ========================================================= */
    const fmt = (d) => d.toLocaleDateString("en-GB", { day: "numeric", month: "short" });
    
   function isoDate(d){
  const x = new Date(d);
  x.setHours(12,0,0,0); // pin to midday to avoid timezone rollover
  const y = x.getFullYear();
  const m = String(x.getMonth()+1).padStart(2,"0");
  const da = String(x.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
    
function effectiveOpenForWeek(w){
  if (!activePeriodObj) return !!w.open; // fallback
  return isPeriodClosed(activePeriodObj)
    ? !!w.openAfterClose
    : !!w.open;
}

    function startOfWeekSunday(dateObj){
      const d = new Date(dateObj);
      const day = d.getDay();
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() - day);
      return d;
    }
    function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }

function groupDatesIntoWeeks(dates){
  const map = new Map();

  for (const item of dates){
    const d = new Date(item.date);
    const ws = startOfWeekSunday(d);
    const key = isoDate(ws);

    const rowWeekId = item.week_id ?? item.rota_weeks?.id ?? null;

    // Interpret flags ONLY if rota_weeks exists; otherwise don't "invent" openness
    const rowOpen = (item.rota_weeks?.open);
    const rowOpenAfterClose = (item.rota_weeks?.open_after_close);

    if (!map.has(key)) {
      map.set(key, {
        weekStart: ws,
        days: [],
        weekId: rowWeekId,

        // Start with "unknown" until we see real flags
        open: null,
        openAfterClose: null
      });
    }

    const weekObj = map.get(key);

    // Capture weekId if we didn't have it yet
    if (!weekObj.weekId && rowWeekId) weekObj.weekId = rowWeekId;

    // Aggregate open flags (AND), but only when we have real values
    if (typeof rowOpen === "boolean") {
      weekObj.open = (weekObj.open === null) ? rowOpen : (weekObj.open && rowOpen);
    }
    if (typeof rowOpenAfterClose === "boolean") {
      weekObj.openAfterClose = (weekObj.openAfterClose === null)
        ? rowOpenAfterClose
        : (weekObj.openAfterClose && rowOpenAfterClose);
    }

    weekObj.days.push(item);
  }

  const weeks = [];

  for (const w of map.values()){
    const dayLookup = new Map(w.days.map(x => [x.date, x]));
    const ordered = [];

    for (let i = 0; i < 7; i++){
      const dd = addDays(w.weekStart, i);
      const ds = isoDate(dd);

      const row = dayLookup.get(ds) || {
        date: ds,
        week_id: w.weekId,
        rota_weeks: (w.weekId ? {
          id: w.weekId,
          open: w.open,
          open_after_close: w.openAfterClose
        } : null)
      };

      ordered.push(row);
    }

    // If still null (never saw rota_weeks), be conservative:
    // treat as CLOSED so editing/comments don't misbehave.
    const finalOpen = (w.open === null) ? false : w.open;
    const finalAfter = (w.openAfterClose === null) ? false : w.openAfterClose;

    weeks.push({
      weekStart: w.weekStart,
      weekEnd: addDays(w.weekStart, 6),
      weekId: w.weekId,
      open: finalOpen,
      openAfterClose: finalAfter,
      days: ordered
    });
  }

  weeks.sort((a,b) => a.weekStart - b.weekStart);
  return weeks;
}
    function groupUsers(users){
      const buckets = { charge_nurse: [], staff_nurse: [], nursing_assistant: [] };

      for(const u of users){
        const label =
          u.roles?.name ||
          (u.role_id === 1 ? "charge_nurse" :
           u.role_id === 2 ? "staff_nurse" :
           u.role_id === 3 ? "nursing_assistant" : "staff_nurse");

        (buckets[label] || buckets.staff_nurse).push(u);
      }

      return [
        { title: "Charge Nurses",      className: "section-cn", items: buckets.charge_nurse },
        { title: "Staff Nurses",       className: "section-sn", items: buckets.staff_nurse },
        { title: "Nursing Assistants", className: "section-na", items: buckets.nursing_assistant }
      ].filter(g => g.items.length > 0);
    }
function getWeekStart(dateStr){
  const d = new Date(dateStr);
  const day = d.getDay(); // 0 = Sunday
  d.setDate(d.getDate() - day);
  d.setHours(0,0,0,0);
  return isoDate(d);
}

function countUserRequestsThisWeek(userId, dateStr){
  const weekStart = getWeekStart(dateStr);
  let count = 0;

  for (const r of requestsCache.values()){
    if (r.user_id !== userId) continue;
    if (getWeekStart(r.date) === weekStart) count++;
  }

  return count;
}

function getSessionPinOrThrow(){
  if (!currentUser) throw new Error("Not logged in.");
  const pin = sessionStorage.getItem(pinKey(currentUser.id));
  if (!pin) throw new Error("Missing session PIN. Log in again.");
  return pin;
}
    
function nextOffPrioritySmart(currentRank, taken){
  // Cycle intent: null -> 1 -> 2 -> 3 -> null
  let desired =
    (currentRank == null) ? 1 :
    (currentRank === 1) ? 2 :
    (currentRank === 2) ? 3 :
    null;

  // If desired is taken elsewhere, pick the next available in order 1,2,3.
  if (desired != null && taken.has(desired)) {
    if (!taken.has(1)) desired = 1;
    else if (!taken.has(2)) desired = 2;
    else if (!taken.has(3)) desired = 3;
    else desired = null; // all used, must be normal O
  }

  return desired;
}
    
function getTakenOffRanksThisWeek(userId, dateStr, excludeKey){
  const ws = getWeekStart(dateStr);
  const taken = new Set();

  // include saved rows
  for (const [k, r] of requestsCache.entries()){
    if (k === excludeKey) continue;
    if (r.user_id !== userId) continue;
    if (getWeekStart(r.date) !== ws) continue;
    if (r.value !== "O") continue;
    if (r.important_rank === 1 || r.important_rank === 2 || r.important_rank === 3) {
      taken.add(r.important_rank);
    }
  }

  // include pending edits
  for (const [k, pe] of Object.entries(pendingEdits)){
    if (k === excludeKey) continue;
    if (pe.userId !== userId) continue;
    if (getWeekStart(pe.date) !== ws) continue;
    if (pe.shift !== "O") continue;
    if (pe.important_rank === 1 || pe.important_rank === 2 || pe.important_rank === 3) {
      taken.add(pe.important_rank);
    }
  }

  return taken;
}
async function fetchWeekComments(weekId){
  const pin = getSessionPinOrThrow();

  const { data, error } = await supabaseClient.rpc("get_week_comments", {
    p_week_id: weekId,
    p_user_id: currentUser.id,
    p_pin: pin
  });

  if (error) throw error;
  return data || [];
}


async function upsertWeekComment(weekId, userId, comment){
  if (!currentUser) throw new Error("Not logged in.");

  const pin = sessionStorage.getItem(pinKey(currentUser.id));
  if (!pin) throw new Error("Missing session PIN. Log in again.");

  const { data, error } = await supabaseClient.rpc("upsert_week_comment", {
    p_week_id: weekId,
    p_user_id: userId,
    p_pin: pin,
    p_comment: comment ?? ""
  });

  if (error) throw error;

  // Depending on how your SQL function is written, data may be:
  // - the row object, OR
  // - an array with one row (common in PostgREST)
  return Array.isArray(data) ? data[0] : data;
}

async function resetWeeksFullyOpen(periodId){
  if (!currentUser?.is_admin) { alert("Admin only."); return; }

  const { data: wkRows, error: wkErr } = await supabaseClient
    .from("rota_dates")
    .select("week_id")
    .eq("period_id", periodId);

  if (wkErr) throw wkErr;

  const weekIds = [...new Set((wkRows || []).map(r => r.week_id).filter(Boolean))];
  if (!weekIds.length) return;

  const { error: resetErr } = await supabaseClient
    .from("rota_weeks")
    .update({ open: true, open_after_close: true })
    .in("id", weekIds);

  if (resetErr) throw resetErr;
}

async function resetWeeksFullyClosed(periodId){
  if (!currentUser?.is_admin) { alert("Admin only."); return; }

  const { data: wkRows, error: wkErr } = await supabaseClient
    .from("rota_dates")
    .select("week_id")
    .eq("period_id", periodId);

  if (wkErr) throw wkErr;

  const weekIds = [...new Set((wkRows || []).map(r => r.week_id).filter(Boolean))];
  if (!weekIds.length) return;

  const { error: resetErr } = await supabaseClient
    .from("rota_weeks")
    .update({ open: false, open_after_close: false })
    .in("id", weekIds);

  if (resetErr) throw resetErr;
}

    
  async function fetchRotaPeriods(){
  let q = supabaseClient
    .from("rota_periods")
    .select("id, name, start_date, end_date, is_hidden, is_active, closes_at")
    .order("start_date", { ascending: true });

  // Staff: show active + non-hidden. Admin: show all.
  if (!currentUser?.is_admin) {
    q = q.or("is_hidden.eq.false,is_active.eq.true");
  }

  const { data, error } = await q;
  if (error) throw error;
  return data || [];
}

function roleLabel(u){
  return u.roles?.name ||
    (u.role_id === 1 ? "charge_nurse" :
     u.role_id === 2 ? "staff_nurse" :
     u.role_id === 3 ? "nursing_assistant" : "staff_nurse");
}


function populatePeriodDropdown(periods){
  periodSelect.innerHTML = "";

  for (const p of periods){
    const opt = document.createElement("option");
    opt.value = p.id;

    const s = new Date(p.start_date);
    const e = new Date(p.end_date);

    const hiddenTag = (currentUser?.is_admin && p.is_hidden) ? " (hidden)" : "";
    const activeTag = p.is_active ? " ★" : "";

    opt.textContent = `${fmt(s)} – ${fmt(e)}${activeTag}${hiddenTag}`;
    periodSelect.appendChild(opt);
  }

  // ✅ ensure dropdown always reflects activePeriodId
  if (activePeriodId != null) {
    periodSelect.value = String(activePeriodId);
  }
}

function getPeriodCloseDate(period){
  if (!period?.closes_at) return null;
  return new Date(period.closes_at);
}

function isPeriodClosed(period){
  const closeAt = getPeriodCloseDate(period);
  if (!closeAt) return false; // no deadline = open forever
  return new Date() >= closeAt;
}

    function isAdminWeekToggleAllowed(){
  return !!currentUser?.is_admin;
}
/* =========================================================
   3) STATE (who is logged in / what is unlocked)
   ========================================================= */
let currentUser = null;      // user object when logged in (by PIN)
let selectedUser = null;     // user you clicked before PIN entry
    let usersById = new Map();
let sessionPin = null; // store PIN in memory only (not localStorage)


    function pinKey(userId){ return `calpeward.pin.${userId}`; }

function setSessionPin(userId, pin){
  sessionPin = pin;
  sessionStorage.setItem(pinKey(userId), pin);
}

function clearSessionPin(userId){
  sessionPin = null;
  if (userId) sessionStorage.removeItem(pinKey(userId));
}
    
/* =========================================================
   3b) STATE (editing + requests)
   ========================================================= */
let activeCell = null;           // { td, userId, date }
const pendingEdits = {};         // key -> { userId, date, shift }
const requestsCache = new Map(); // key -> { id, user_id, date, value, important_rank }
 let periodsCache = [];
let activePeriodId = null;
    let activePeriodObj = null; // ← the actual period object
    let closeTriggeredReload = false;
    
// ===== 5-week window navigation =====
const WINDOW_WEEKS = 5;
let allWeeks = [];
let weekWindowStart = 0; // index into allWeeks

    

// key: `${user_id}_${date}` -> { id, user_id, date, value, important_rank }

    /* =========================================================
       4) DOM REFERENCES
       ========================================================= */
    const modal = document.getElementById("pinModal");
    const pinInput = document.getElementById("pinInput");
    const pinErr = document.getElementById("pinErr");
    const pinTitle = document.getElementById("pinTitle");
    const pinDesc = document.getElementById("pinDesc");
    const pinConfirmBtn = document.getElementById("pinConfirm");
    const pinCancelBtn = document.getElementById("pinCancel");
    const loginBadge = document.getElementById("loginBadge");
    const adminBadge = document.getElementById("adminBadge");
    
const periodSelect = document.getElementById("periodSelect");


    const adminPeriodSelect = document.getElementById("adminPeriodSelect");
const adminPeriodMeta = document.getElementById("adminPeriodMeta");
const adminSetActiveBtn = document.getElementById("adminSetActiveBtn");
const adminToggleHiddenBtn = document.getElementById("adminToggleHiddenBtn");
const adminWeeksList = document.getElementById("adminWeeksList");
    const closeLabel = document.getElementById("closeLabel");
    const adminClosesAtInput = document.getElementById("adminClosesAtInput");
const adminClosesAtSaveBtn = document.getElementById("adminClosesAtSaveBtn");
const adminClosesAtClearBtn = document.getElementById("adminClosesAtClearBtn");
const adminClosesAtHelp = document.getElementById("adminClosesAtHelp");



let adminSelectedPeriodId = null;
    
    const adminTabUsers = document.getElementById("adminTabUsers");
const adminViewUsers = document.getElementById("adminViewUsers");

const adminUsersList = document.getElementById("adminUsersList");
const adminAddUserBtn = document.getElementById("adminAddUserBtn");
const adminUserSearch = document.getElementById("adminUserSearch");
const adminShowInactiveUsers = document.getElementById("adminShowInactiveUsers");

const adminEditUserName = document.getElementById("adminEditUserName");
const adminEditUserRole = document.getElementById("adminEditUserRole");
const adminEditUserPin  = document.getElementById("adminEditUserPin");
const adminSaveUserBtn  = document.getElementById("adminSaveUserBtn");
const adminCancelUserEditBtn = document.getElementById("adminCancelUserEditBtn");
const adminUserEditHelp = document.getElementById("adminUserEditHelp");

// User modal refs
const userModal = document.getElementById("userModal");
const userCloseBtn = document.getElementById("userClose");
const userLogoutBtn = document.getElementById("userLogout");

const userMeta = document.getElementById("userMeta");
const userOldPin = document.getElementById("userOldPin");
const userNewPin = document.getElementById("userNewPin");
const userNewPin2 = document.getElementById("userNewPin2");
const userSavePin = document.getElementById("userSavePin");
const userPinErr = document.getElementById("userPinErr");
const userPinOk = document.getElementById("userPinOk");


    // Shift modal refs
    const shiftModal = document.getElementById("shiftModal");
    const shiftCancelBtn = document.getElementById("shiftCancel");


    
// Week comment modal refs
const weekCommentModal = document.getElementById("weekCommentModal");
const weekCommentCancel = document.getElementById("weekCommentCancel");
const weekCommentSave = document.getElementById("weekCommentSave");
const weekCommentInput = document.getElementById("weekCommentInput");
const weekCommentAdminList = document.getElementById("weekCommentAdminList");

let activeWeekIdForComment = null;
    function toDatetimeLocalValue(dateObj){
  // returns "YYYY-MM-DDTHH:MM" in local time
  const pad = (n) => String(n).padStart(2, "0");
  const y = dateObj.getFullYear();
  const m = pad(dateObj.getMonth() + 1);
  const d = pad(dateObj.getDate());
  const h = pad(dateObj.getHours());
  const mi = pad(dateObj.getMinutes());
  return `${y}-${m}-${d}T${h}:${mi}`;
}

function datetimeLocalToISOString(value){
  // value is "YYYY-MM-DDTHH:MM" interpreted as LOCAL time
  // Convert to a Date then ISO (UTC). Works cleanly with timestamptz in Supabase.
  const dt = new Date(value);
  return dt.toISOString();
}

function renderAdminCloseTime(periodId){
  const p = periodsCache.find(x => String(x.id) === String(periodId));
  if (!p) return;

  if (adminClosesAtInput){
    adminClosesAtInput.value = p.closes_at ? toDatetimeLocalValue(new Date(p.closes_at)) : "";
  }

  if (adminClosesAtHelp){
    if (!p.closes_at){
      adminClosesAtHelp.textContent = "No close time set (requests stay open).";
    } else {
      const d = new Date(p.closes_at);
      adminClosesAtHelp.textContent =
        `Currently closes at: ${d.toLocaleString("en-GB")}`;
    }
  }
}

    
  let closeCountdownTimer = null;

function formatTimeLeft(ms){
  if (ms <= 0) return "0m";

  const totalMins = Math.floor(ms / 60000);
  const days = Math.floor(totalMins / (60 * 24));
  const hours = Math.floor((totalMins % (60 * 24)) / 60);
  const mins = totalMins % 60;

  const parts = [];
  if (days) parts.push(`${days}d`);
  if (days || hours) parts.push(`${hours}h`);
  parts.push(`${mins}m`);

  return parts.join(" ");
}

function updateCloseLabel(period){
  if (!closeLabel) return;

  if (closeCountdownTimer){
    clearInterval(closeCountdownTimer);
    closeCountdownTimer = null;
  }

  const closeAt = getPeriodCloseDate(period);

if (!closeAt){
  closeLabel.innerHTML = `
    <span class="close-pill">
      <span class="dot"></span>
      <span class="msg">Requests are open</span>
    </span>
  `;
  return;
}

const renderCloseLabel = () => {
  const now = new Date();
  const msLeft = closeAt - now;

if (msLeft <= 0){
  closeLabel.innerHTML = `
    <span class="close-pill is-closed">
      <span class="dot"></span>
      <span class="msg">Requests closed</span>
      <span class="mini">Closed at ${closeAt.toLocaleString("en-GB")}</span>
    </span>
  `;

  clearInterval(closeCountdownTimer);
  closeCountdownTimer = null;

  // ✅ FIX 3: force UI to re-render locked state once
  if (!closeTriggeredReload) {
    closeTriggeredReload = true;
    loadRota(); // re-fetch + redraw so cells become locked
  }

  return;
}

  const soon = msLeft <= 24 * 60 * 60 * 1000;

  closeLabel.innerHTML = `
    <span class="close-pill ${soon ? "is-soon" : ""}">
      <span class="dot"></span>
      <span class="msg">Requests close${soon ? " soon" : ""}</span>
      <span class="mini">${closeAt.toLocaleString("en-GB")}</span>
      <span class="timeleft">${formatTimeLeft(msLeft)} left</span>
    </span>
  `;
};


renderCloseLabel();
closeCountdownTimer = setInterval(renderCloseLabel, 30000);
}

function openUserModal(){
  if (!currentUser) return;

  userMeta.textContent = `${currentUser.name}${currentUser.is_admin ? " (admin)" : ""}`;
  userOldPin.value = "";
  userNewPin.value = "";
  userNewPin2.value = "";

  userPinErr.style.display = "none";
  userPinOk.style.display = "none";

  document.body.classList.add("modal-open");
  userModal.style.display = "flex";
  userModal.setAttribute("aria-hidden", "false");

  setTimeout(() => userOldPin.focus(), 50);
}

function closeUserModal(){
  userModal.style.display = "none";
  userModal.setAttribute("aria-hidden", "true");
  document.body.classList.remove("modal-open");
}

function logout(){
  if (!currentUser) return;

  // clear stored login + pin
  localStorage.removeItem(STORAGE_KEY);
  clearSessionPin(currentUser.id);

  // clear state
  currentUser = null;
  selectedUser = null;
  sessionPin = null;

  closeUserModal();
  updateBadges();
  applyUnlockState();

  // refresh UI (so any "editable" disappears + dropdown filtering updates)
  loadRota();
}

// Wire badge click
loginBadge.style.cursor = "pointer";
loginBadge.addEventListener("click", () => {
  if (!currentUser) return;        // don’t open it when not logged in
  openUserModal();
});

// Close actions
userCloseBtn?.addEventListener("click", closeUserModal);
userLogoutBtn?.addEventListener("click", logout);
userModal?.addEventListener("click", (e) => {
  if (e.target === userModal) closeUserModal();
});

// Save PIN
userSavePin?.addEventListener("click", async () => {
  if (!currentUser) return;

  userPinErr.style.display = "none";
  userPinOk.style.display = "none";

  const oldPin = userOldPin.value.trim();
  const newPin = userNewPin.value.trim();
  const newPin2 = userNewPin2.value.trim();

  if (!/^\d{4}$/.test(oldPin)) return showUserPinErr("Current PIN must be 4 digits.");
  if (!/^\d{4}$/.test(newPin)) return showUserPinErr("New PIN must be 4 digits.");
  if (newPin !== newPin2) return showUserPinErr("New PINs do not match.");
  if (oldPin === newPin) return showUserPinErr("New PIN must be different.");

  userSavePin.disabled = true;

  try {
    // OPTIONAL: verify old pin first (you already have this RPC)
    const { data: ok, error: vErr } = await supabaseClient.rpc("verify_user_pin", {
      p_user_id: currentUser.id,
      p_pin: oldPin
    });
    if (vErr) throw vErr;
    if (ok !== true) return showUserPinErr("Current PIN is incorrect.");

    // Change pin (YOU need this RPC - see SQL below)
    const { error: cErr } = await supabaseClient.rpc("change_user_pin", {
      p_user_id: currentUser.id,
      p_old_pin: oldPin,
      p_new_pin: newPin
    });
    if (cErr) throw cErr;

    // Update session pin to the new one so their session keeps working
    setSessionPin(currentUser.id, newPin);

    userPinOk.style.display = "block";
    userOldPin.value = "";
    userNewPin.value = "";
    userNewPin2.value = "";

  } catch (e) {
    console.error(e);
    showUserPinErr("Failed to update PIN. Check console.");
  } finally {
    userSavePin.disabled = false;
  }
});

function showUserPinErr(msg){
  userPinErr.textContent = msg;
  userPinErr.style.display = "block";
}

    
function openWeekCommentModal(){
  if (!activeWeekIdForComment) return;
  document.body.classList.add("modal-open");  // ✅
  weekCommentModal.style.display = "flex";
  weekCommentModal.setAttribute("aria-hidden","false");
}

function closeWeekCommentModal(){
  document.body.classList.remove("modal-open"); // ✅
  weekCommentModal.style.display = "none";
  weekCommentModal.setAttribute("aria-hidden","true");
  activeWeekIdForComment = null;
  weekCommentInput.value = "";
  weekCommentAdminList.innerHTML = "";
  weekCommentAdminList.style.display = "none";
}

weekCommentCancel.addEventListener("click", closeWeekCommentModal);
weekCommentModal.addEventListener("click", (e) => {
  if (e.target === weekCommentModal) closeWeekCommentModal();
});

if (adminBadge) {
  adminBadge.addEventListener("click", () => {
    if (!currentUser?.is_admin) return;
    openAdminConsole();
  });
}
 

// Click handler for 💬 buttons (event delegation)
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".week-comment-btn");
  if (!btn) return;

  e.preventDefault();
  e.stopPropagation();

  const weekId = (btn.dataset.weekId || "").trim();
  if (!weekId) {
    alert("Week ID missing (data-week-id is empty). Fix rota_weeks(id,open) select.");
    return;
  }

  if (!currentUser) {
    alert("Log in first to add comments.");
    return;
  }

  activeWeekIdForComment = weekId;

  try {
    const rows = await fetchWeekComments(weekId);

    // ---- My comment (normal user + admin)
    const myId = String(currentUser.id);
    const mine = (rows || []).find(r => String(r.user_id) === myId);
    weekCommentInput.value = mine?.comment || "";

    // ---- Admin list (all staff comments)
    if (currentUser.is_admin) {
      weekCommentAdminList.style.display = "block";

      if (!rows || rows.length === 0) {
        weekCommentAdminList.innerHTML = `<div class="subtitle">No comments yet.</div>`;
      } else {
        weekCommentAdminList.innerHTML = rows.map(r => {
          const uid = String(r.user_id);
          const name = usersById.get(uid) || uid;
          const when = r.updated_at ? new Date(r.updated_at).toLocaleString("en-GB") : "";
          const commentSafe = escapeHtml(r.comment || "");

          return `
            <div style="padding:6px 0; border-bottom:1px solid #eee;">
              <div style="font-weight:700;">${escapeHtml(name)}</div>
              <div style="font-size:11px; color:#777;">${when}</div>
              <div style="white-space:pre-wrap;">${commentSafe}</div>
            </div>
          `;
        }).join("");
      }
    } else {
      weekCommentAdminList.style.display = "none";
      weekCommentAdminList.innerHTML = "";
    }

    // ---- Bubble indicator: mark if ANY comment exists
    btn.classList.toggle("has-comment", (rows || []).length > 0);

    openWeekCommentModal();
  } catch (err) {
    console.error("Week comment load failed:", err);
    alert("Failed to load week comments. Check console.");
  }
});

// Save handler
weekCommentSave.addEventListener("click", async () => {
  if (!activeWeekIdForComment || !currentUser) return;

  try {
    await upsertWeekComment(
      activeWeekIdForComment,
      currentUser.id,
      weekCommentInput.value
    );

    // Re-fetch so bubble reflects whether ANY comment exists (not just yours)
    const rows = await fetchWeekComments(activeWeekIdForComment);

    // Update the bubble indicator for this week header button
    const selector = `.week-comment-btn[data-week-id="${CSS.escape(String(activeWeekIdForComment))}"]`;
    const btn = document.querySelector(selector);
    if (btn) {
      btn.classList.toggle("has-comment", (rows || []).length > 0);
    }

    // If admin, refresh the visible comment list too
    if (currentUser.is_admin) {
      weekCommentAdminList.style.display = "block";
      if (!rows || rows.length === 0) {
        weekCommentAdminList.innerHTML = `<div class="subtitle">No comments yet.</div>`;
      } else {
        weekCommentAdminList.innerHTML = rows.map(r => {
          const uid = String(r.user_id);
          const name = usersById.get(uid) || uid;
          const when = r.updated_at ? new Date(r.updated_at).toLocaleString("en-GB") : "";
          const commentSafe = escapeHtml(r.comment || "");
          return `
            <div style="padding:6px 0; border-bottom:1px solid #eee;">
              <div style="font-weight:700;">${escapeHtml(name)}</div>
              <div style="font-size:11px; color:#777;">${when}</div>
              <div style="white-space:pre-wrap;">${commentSafe}</div>
            </div>
          `;
        }).join("");
      }
    }

    closeWeekCommentModal();
  } catch (err) {
    console.error("Week comment save failed:", err);
    alert("Failed to save comment. Check console.");
  }
});
    

/* =========================================================
   6) PERIOD DROPDOWN HANDLER
   ========================================================= */
if (periodSelect) {
  periodSelect.addEventListener("change", async () => {
    closeTriggeredReload = false; // ✅ reset for new period
    activePeriodId = periodSelect.value;

    const selected = periodsCache.find(p => String(p.id) === String(activePeriodId));
    activePeriodObj = selected;

    updateCloseLabel(selected);
    applyUnlockState();
    await loadRota();
  });
}

/* =========================
   ADMIN PANEL (v1)
   ========================= */
const adminModal = document.getElementById("adminModal");
const adminCloseBtn = document.getElementById("adminClose");
const adminTabPeriods = document.getElementById("adminTabPeriods");
const adminTabGenerate = document.getElementById("adminTabGenerate");
const adminViewPeriods = document.getElementById("adminViewPeriods");
const adminViewGenerate = document.getElementById("adminViewGenerate");

const adminGeneratePreview = document.getElementById("adminGeneratePreview");
const adminGenerateBtn = document.getElementById("adminGenerateBtn");

function openAdminConsole(){
  if (!currentUser?.is_admin) return;
  document.body.classList.add("modal-open");
  adminModal.style.display = "flex";
  adminModal.setAttribute("aria-hidden","false");
  showAdminTab("periods");
  loadAdminPeriodsForDropdown();
  refreshGeneratePreview();
}

function closeAdminConsole(){
  document.body.classList.remove("modal-open");
  adminModal.style.display = "none";
  adminModal.setAttribute("aria-hidden","true");
}


if (adminCloseBtn) adminCloseBtn.addEventListener("click", closeAdminConsole);
if (adminModal) adminModal.addEventListener("click", (e) => {
  if (e.target === adminModal) closeAdminConsole();
});

// [ADMIN-UI-1] Tab switching (Periods / Generate / Users)
function showAdminTab(which){
  const isPeriods  = (which === "periods");
  const isGenerate = (which === "generate");
  const isUsers    = (which === "users");

  adminViewPeriods.style.display  = isPeriods  ? "block" : "none";
  adminViewGenerate.style.display = isGenerate ? "block" : "none";
  adminViewUsers.style.display    = isUsers    ? "block" : "none";

adminTabPeriods.classList.toggle("is-active", isPeriods);
adminTabGenerate.classList.toggle("is-active", isGenerate);
adminTabUsers.classList.toggle("is-active", isUsers);
}

if (adminTabPeriods) adminTabPeriods.addEventListener("click", () => showAdminTab("periods"));
if (adminTabGenerate) adminTabGenerate.addEventListener("click", () => showAdminTab("generate"));

    // [ADMIN-UI-4] Users tab
if (adminTabUsers) {
  adminTabUsers.addEventListener("click", () => {
    showAdminTab("users");
    loadAdminUsers();
  });
}
/* =========================================================
   [ADMIN-USERS-1] ADMIN USERS CRUD (Add/Edit/Deactivate)
   ========================================================= */

let adminUsersCache = [];
let adminEditingUserId = null;

function escapeHtml(s){
  return String(s)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
async function loadAdminUsers(){
  if (!adminUsersList) return;

  adminUsersList.textContent = "Loading users…";

  const { data, error } = await supabaseClient
    .from("users")
    .select("id, name, role_id, is_admin, is_active, roles(name)")
  .order("created_at", { ascending: true })

  if (error) {
    console.error(error);
    adminUsersList.textContent = "Failed to load users.";
    return;
  }

  adminUsersCache = data || [];
  renderAdminUsers();
}

function renderAdminUsers(){
  if (!adminUsersList) return;

  const q = (adminUserSearch?.value || "").trim().toLowerCase();
  const showInactive = !!adminShowInactiveUsers?.checked;

  let rows = adminUsersCache.slice();
  if (!showInactive) rows = rows.filter(u => u.is_active !== false);
  if (q) rows = rows.filter(u => (u.name || "").toLowerCase().includes(q));

  if (!rows.length){
    adminUsersList.innerHTML = `<div class="subtitle" style="margin-top:8px;">No users.</div>`;
    return;
  }

  const groups = [
    { title: "Charge Nurses", role_id: 1 },
    { title: "Staff Nurses", role_id: 2 },
    { title: "Nursing Assistants", role_id: 3 },
  ];

  const html = [];

  for (const g of groups){
    const members = rows.filter(u => Number(u.role_id) === g.role_id);
    if (!members.length) continue;

    html.push(`<div class="user-group-title">${g.title}</div>`);

    html.push(members.map(u => {
      return `
        <div class="user-row">
          <div class="user-meta">
            <div class="user-name">
              ${escapeHtml(u.name || "")}
              ${u.is_admin ? `<span class="user-tag admin">admin</span>` : ""}
              ${u.is_active === false ? `<span class="user-tag inactive">inactive</span>` : ""}
            </div>
          </div>

          <div class="user-actions">
            <button type="button" data-act="edit" data-id="${u.id}">Edit</button>
            <button type="button" data-act="toggle" data-id="${u.id}">
              ${u.is_active === false ? "Reactivate" : "Deactivate"}
            </button>
          </div>
        </div>
      `;
    }).join(""));
  }

  adminUsersList.innerHTML = html.join("");
}
function clearUserEditor(){
  adminEditingUserId = null;
  if (adminEditUserName) adminEditUserName.value = "";
  if (adminEditUserRole) adminEditUserRole.value = "2";
  if (adminEditUserPin)  adminEditUserPin.value = "";
  if (adminUserEditHelp) adminUserEditHelp.textContent = "Fill details and click Save.";
}

function startEditUser(userId){
  const u = adminUsersCache.find(x => x.id === userId);
  if (!u) return;

  adminEditingUserId = u.id;
  adminEditUserName.value = u.name || "";
  adminEditUserRole.value = String(u.role_id || 2);
  adminEditUserPin.value = "";
  adminUserEditHelp.textContent = "Leave PIN blank to keep current PIN.";
}

async function toggleUserActive(userId){
  const u = adminUsersCache.find(x => x.id === userId);
  if (!u) return;

  const next = (u.is_active === false) ? true : false;
  const ok = confirm(`${next ? "Reactivate" : "Deactivate"} ${u.name}?`);
  if (!ok) return;

  const pin = getSessionPinOrThrow(); // 🔑 THIS WAS MISSING

  const { error } = await supabaseClient.rpc("set_user_active", {
    p_admin_id: currentUser.id,
    p_pin: pin,
    p_user_id: userId,
    p_active: next
  });

  if (error){
    console.error(error);
    alert("Update failed.");
    return;
  }

  await loadRota();
  await loadAdminUsers();
}


/* =========================================================
   [ADMIN-USERS-2] Wire UI events for Users tab
   ========================================================= */

adminUserSearch?.addEventListener("input", renderAdminUsers);
adminShowInactiveUsers?.addEventListener("change", renderAdminUsers);

adminUsersList?.addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-act]");
  if (!btn) return;

  const id = btn.dataset.id;
  const act = btn.dataset.act;

  if (act === "edit") startEditUser(id);
  if (act === "toggle") toggleUserActive(id);
});

adminAddUserBtn?.addEventListener("click", clearUserEditor);
adminCancelUserEditBtn?.addEventListener("click", clearUserEditor);

/* =========================================================
   [ADMIN-USERS-3] Save user (insert/update + optional PIN)
   ========================================================= */

adminSaveUserBtn?.addEventListener("click", async () => {
  const name = adminEditUserName.value.trim();
  const role_id = Number(adminEditUserRole.value);
  const pin = (adminEditUserPin.value || "").trim();

  if (!name) return alert("Name is required.");
  if (![1,2,3].includes(role_id)) return alert("Role invalid.");
  if (pin && !/^\d{4}$/.test(pin)) return alert("PIN must be 4 digits.");

  try {
    const { data: userId, error } = await supabaseClient.rpc("admin_upsert_user", {
      p_user_id: adminEditingUserId, // null = add
      p_name: name,
      p_role_id: role_id
    });
    if (error) throw error;

    if (pin) await adminSetUserPin(userId, pin);

    await loadRota();
    await loadAdminUsers();
    clearUserEditor();
    alert("Saved.");
  } catch (e) {
    console.error(e);
    alert("Save failed. Check console.");
  }
});

/* =========================================================
   [ADMIN-USERS-4] PIN setter via RPC (recommended)
   ========================================================= */
async function adminSetUserPin(userId, pin){
  const { error } = await supabaseClient.rpc("set_user_pin", {
    p_user_id: userId,
    p_pin: pin
  });
  if (error) throw error;
}

/* =========================
   ADMIN PERIODS (v2 dropdown)
   ========================= */

if (adminPeriodSelect) {
  adminPeriodSelect.addEventListener("change", async () => {
    adminSelectedPeriodId = adminPeriodSelect.value;
    renderAdminPeriodMeta(adminSelectedPeriodId);
    renderAdminCloseTime(adminSelectedPeriodId); 
    await loadAdminWeeks(adminSelectedPeriodId);
  });
}

if (adminSetActiveBtn) {
  adminSetActiveBtn.addEventListener("click", async () => {
    if (!adminSelectedPeriodId) return;
    try {
      await setActivePeriod(adminSelectedPeriodId);
      await loadRota(); // refresh main view
      await loadAdminPeriodsForDropdown(); // refresh admin UI
      renderAdminCloseTime(adminSelectedPeriodId)
    } catch (e) {
      console.error(e);
      alert("Set active failed. Check console.");
    }
  });
}

if (adminToggleHiddenBtn) {
  adminToggleHiddenBtn.addEventListener("click", async () => {
    if (!adminSelectedPeriodId) return;
    try {
      await toggleHiddenPeriod(adminSelectedPeriodId);
      await loadRota(); // refresh main view
      await loadAdminPeriodsForDropdown(); // refresh admin UI
    } catch (e) {
      console.error(e);
      alert("Toggle hidden failed. Check console.");
    }
  });
}

async function loadAdminPeriodsForDropdown(){
  if (!adminPeriodSelect) return;

  adminPeriodMeta.textContent = "Loading…";
  adminWeeksList.textContent = "Loading…";

  let periods;
  try {
    periods = await fetchRotaPeriods(); // admin sees all
  } catch (e) {
    console.error(e);
    adminPeriodMeta.textContent = "Failed to load periods.";
    adminWeeksList.textContent = "Failed to load weeks.";
    return;
  }

  periodsCache = periods;

  // Fill dropdown
  adminPeriodSelect.innerHTML = "";
  for (const p of periods){
    const opt = document.createElement("option");
    opt.value = p.id;
    const s = fmt(new Date(p.start_date));
    const e = fmt(new Date(p.end_date));
    opt.textContent = `${s} – ${e}${p.is_active ? " ★" : ""}${p.is_hidden ? " (hidden)" : ""}`;
    adminPeriodSelect.appendChild(opt);
  }

  // Default selection
  if (!adminSelectedPeriodId) {
    const active = periods.find(p => p.is_active) || periods[periods.length - 1];
    adminSelectedPeriodId = active?.id || periods[0]?.id;
  }

  adminPeriodSelect.value = String(adminSelectedPeriodId);

  renderAdminPeriodMeta(adminSelectedPeriodId);
  await loadAdminWeeks(adminSelectedPeriodId);
  renderAdminCloseTime(adminSelectedPeriodId);
}

function renderAdminPeriodMeta(periodId){
  const p = periodsCache.find(x => String(x.id) === String(periodId));
  if (!p){
    adminPeriodMeta.textContent = "";
    return;
  }

  const bits = [];
  if (p.is_active) bits.push("✅ Active");
  if (p.is_hidden) bits.push("🙈 Hidden");
  adminPeriodMeta.textContent = bits.join(" · ") || "—";
}

async function loadAdminWeeks(periodId){
  adminWeeksList.textContent = "Loading weeks…";

  // Pull all dates for the period, but we only need them to discover the weeks + open state
  const { data, error } = await supabaseClient
    .from("rota_dates")
.select("date, week_id, period_id, rota_weeks(id, open, open_after_close)")
    .eq("period_id", periodId)
    .order("date");

  if (error) {
    console.error(error);
    adminWeeksList.textContent = "Failed to load weeks.";
    return;
  }

  // Build unique weeks list from rota_dates (because rota_weeks doesn't have period_id)
const weekMap = new Map();

for (const row of (data || [])) {
  const w = row.rota_weeks;
  if (!w?.id) continue;

  // Compute week start/end from the date in rota_dates
  const ws = startOfWeekSunday(new Date(row.date));
  const we = addDays(ws, 6);

  if (!weekMap.has(w.id)) {
    weekMap.set(w.id, {
      weekId: w.id,
      open: !!w.open,
      openAfterClose: !!w.open_after_close,
      weekStart: ws,
      weekEnd: we
    });
  } else {
    const existing = weekMap.get(w.id);

    // Keep flags consistent (safety: if any row says closed, treat as closed)
    existing.open = existing.open && !!w.open;
    existing.openAfterClose = existing.openAfterClose && !!w.open_after_close;

    // Expand bounds in case of weird data ordering
    if (ws < existing.weekStart) existing.weekStart = ws;
    if (we > existing.weekEnd) existing.weekEnd = we;
  }
}

const weeks = [...weekMap.values()].sort((a,b) => a.weekStart - b.weekStart);


  if (!weeks.length){
    adminWeeksList.textContent = "No weeks found for this period.";
    return;
  }

  // Period lock (deadline)
  const p = periodsCache.find(x => String(x.id) === String(periodId));
  const periodClosed = isPeriodClosed(p);

  adminWeeksList.innerHTML = weeks.map(w => {
    const s = fmt(w.weekStart);
    const e = fmt(w.weekEnd);
   const isOpen = periodClosed ? !!w.openAfterClose : !!w.open;


    const pill = isOpen
      ? `<span style="display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:800; background:#e9fff0; border:1px solid #9fe0b1; color:#0b6b2b;">OPEN</span>`
      : `<span style="display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:800; background:#ffecec; border:1px solid #ffb3b3; color:#8a1f1f;">CLOSED</span>`;

const lockNote = `
  <div style="margin-top:4px; font-size:11px; color:#666;">
   ${isOpen ? "Requests open for staff" : "Requests locked for staff"} 
${periodClosed ? "(after close time)" : "(before close time)"}
  </div>
`;


    const btnText = isOpen ? "Close week" : "Open week";

    return `
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid #eee;">
        <div>
          <div style="font-weight:800;">${s} – ${e}</div>
          <div style="margin-top:4px;">${pill}</div>
          ${lockNote}
        </div>

        <button type="button"
  class="week-toggle-btn"
  data-week-id="${w.weekId}"
  data-open="${w.open ? "1" : "0"}"
  data-open-after-close="${w.openAfterClose ? "1" : "0"}"
  data-period-closed="${periodClosed ? "1" : "0"}"
>
          ${btnText}
        </button>
      </div>
    `;
  }).join("");

// Bind toggles (admins can still manage weeks regardless of period close)
adminWeeksList.querySelectorAll("button[data-week-id]").forEach(btn => {
  btn.addEventListener("click", async () => {
    if (!currentUser?.is_admin) return;

    const pin = getSessionPinOrThrow();
    const weekId = btn.dataset.weekId;

    const open = btn.dataset.open === "1";
    const openAfterClose = btn.dataset.openAfterClose === "1";
    const periodClosed = btn.dataset.periodClosed === "1";

// ✅ Toggle the correct flag depending on whether period is closed
let nextOpen = open;
let nextOpenAfterClose = openAfterClose;

if (periodClosed) {
  nextOpenAfterClose = !openAfterClose;  // after deadline behavior
} else {
  nextOpen = !open;                      // normal behavior
}
    try {
      const { error } = await supabaseClient.rpc("admin_set_week_open_flags", {
        p_admin_id: currentUser.id,
        p_pin: pin,
        p_week_id: weekId,
        p_open: nextOpen,
        p_open_after_close: nextOpenAfterClose
      });
      if (error) throw error;

      await loadRota();
      await loadAdminWeeks(periodId); 
    } catch (e) {
      console.error(e);
      alert("Failed to toggle week. Check console.");
    }
  });
});
 }
/* =========================
   ADMIN PERIOD ACTIONS (v1)
   ========================= */
  
async function setActivePeriod(periodId){
  const pin = getSessionPinOrThrow();

  const { error } = await supabaseClient.rpc("admin_set_active_period", {
    p_admin_id: currentUser.id,
    p_pin: pin,
    p_period_id: periodId
  });

  if (error) throw error;
  activePeriodId = periodId;
}
    
async function toggleHiddenPeriod(periodId){
  if (!currentUser?.is_admin) throw new Error("Admin only.");
  const pin = getSessionPinOrThrow();

  const { error } = await supabaseClient.rpc("admin_toggle_hidden_period", {
    p_admin_id: currentUser.id,
    p_pin: pin,
    p_period_id: periodId
  });

  if (error) throw error;
}
// create 5 week period 

async function generateNextFiveWeekPeriod(){
  if (!currentUser?.is_admin) throw new Error("Admin only.");

  const pin = getSessionPinOrThrow();
  const r = computeNextPeriodRange();
  if (!r) throw new Error("No existing periods.");

  const startStr = isoDate(r.start);
  const endStr   = isoDate(r.end);
  const periodName = `${fmt(r.start)} – ${fmt(r.end)}`;

  // 1️⃣ create period + weeks + dates server-side
  const { data: periodId, error } = await supabaseClient.rpc(
    "admin_create_five_week_period",
    {
      p_admin_id: currentUser.id,
      p_pin: pin,
      p_name: periodName,
      p_start_date: startStr,
      p_end_date: endStr
    }
  );

  if (error) throw error;

  // ✅ return UUID only
  return periodId;
}



/* =========================
   ADMIN GENERATE PREVIEW
   ========================= */
function computeNextPeriodRange(){
  if (!periodsCache?.length) return null;

  const latest = [...periodsCache]
    .sort((a,b) => new Date(a.end_date) - new Date(b.end_date))
    .at(-1);

  if (!latest?.end_date) return null;

  const lastEnd = new Date(latest.end_date);

  let start = addDays(lastEnd, 1);
  while (start.getDay() !== 0) start = addDays(start, 1);

  const end = addDays(start, 34);
  return { start, end, latest };
}

function refreshGeneratePreview(){
  const r = computeNextPeriodRange();
  if (!r){
    adminGeneratePreview.textContent = "Cannot preview. No periods loaded.";
    return;
  }

  adminGeneratePreview.textContent =
    `Next period: ${fmt(r.start)} – ${fmt(r.end)} (5 weeks, Sun–Sat).`;
}

if (adminGenerateBtn) {
  adminGenerateBtn.addEventListener("click", async () => {
    try {
      const r = computeNextPeriodRange();
      if (!r) {
        alert("Cannot generate: no periods loaded.");
        return;
      }

      const ok = confirm(`Generate new 5-week period:\n${fmt(r.start)} – ${fmt(r.end)} ?`);
      if (!ok) return;

      adminGenerateBtn.disabled = true;
      adminGeneratePreview.textContent = "Generating…";

      // ✅ RPC returns a UUID (string), not a period object
      const newPeriodId = await generateNextFiveWeekPeriod();

      // Refresh caches + UI
      await loadRota();
      await loadAdminPeriodsForDropdown();
      refreshGeneratePreview();

      // Select the new period everywhere
      adminSelectedPeriodId = newPeriodId;
      activePeriodId = newPeriodId;

      // Optional: auto-set active so staff see it immediately
  // await setActivePeriod(newPeriodId); // only activate when ready

      // Refresh again so ★ active + dropdown state update
      await loadRota();
      await loadAdminPeriodsForDropdown();

      alert("Generated new 5-week period.");
    } catch (e) {
      console.error(e);

      const msg =
        e?.message ||
        e?.details ||
        e?.hint ||
        (e?.error && (e.error.message || e.error.details)) ||
        JSON.stringify(e, null, 2);

      alert("Generate failed:\n\n" + msg);
    } finally {
      adminGenerateBtn.disabled = false;
      // nice-to-have: restore preview if generation failed
      refreshGeneratePreview();
    }
  });
}


async function setPeriodCloseTime(periodId, closesAtIsoOrNull){
  const pin = getSessionPinOrThrow();

  const { error } = await supabaseClient.rpc("admin_set_period_closes_at", {
    p_admin_id: currentUser.id,
    p_pin: pin,
    p_period_id: periodId,
    p_closes_at: closesAtIsoOrNull
  });

  if (error) throw error;
}

    // OPTIONAL BASELINE RESET HELPERS

async function resetWeeksAfterClose(periodId){
  if (!currentUser?.is_admin) { alert("Admin only."); return; }
  const { data: wkRows, error: wkErr } = await supabaseClient
    .from("rota_dates")
    .select("week_id")
    .eq("period_id", periodId);

  if (wkErr) throw wkErr;

  const weekIds = [...new Set((wkRows || []).map(r => r.week_id).filter(Boolean))];
  if (!weekIds.length) return;

  const { error: resetErr } = await supabaseClient
    .from("rota_weeks")
    .update({ open_after_close: false })
    .in("id", weekIds);

  if (resetErr) throw resetErr;
}
    async function resetWeeksOpen(periodId){
  if (!currentUser?.is_admin) { alert("Admin only."); return; }

  const { data: wkRows, error: wkErr } = await supabaseClient
    .from("rota_dates")
    .select("week_id")
    .eq("period_id", periodId);

  if (wkErr) throw wkErr;

  const weekIds = [...new Set((wkRows || []).map(r => r.week_id).filter(Boolean))];
  if (!weekIds.length) return;

  const { error: resetErr } = await supabaseClient
    .from("rota_weeks")
    .update({ open: true })
    .in("id", weekIds);

  if (resetErr) throw resetErr;
}

async function resetWeeksDefaultForPeriod(periodId){
  if (!currentUser?.is_admin) { alert("Admin only."); return; }
  const { data: wkRows, error: wkErr } = await supabaseClient
    .from("rota_dates")
    .select("week_id")
    .eq("period_id", periodId);

  if (wkErr) throw wkErr;

  const weekIds = [...new Set((wkRows || []).map(r => r.week_id).filter(Boolean))];
  if (!weekIds.length) return;

  const { error: resetErr } = await supabaseClient
    .from("rota_weeks")
    .update({ open: true, open_after_close: false })
    .in("id", weekIds);

  if (resetErr) throw resetErr;
}

if (adminClosesAtSaveBtn) {
  adminClosesAtSaveBtn.addEventListener("click", async () => {
    if (!adminSelectedPeriodId) return alert("Pick a rota period first.");
    if (!adminClosesAtInput?.value) return alert("Pick a date/time first.");

    try {
      const iso = datetimeLocalToISOString(adminClosesAtInput.value);

      await setPeriodCloseTime(adminSelectedPeriodId, iso);

      // ✅ close time should slam all 5 weeks shut by default
      await resetWeeksAfterClose(adminSelectedPeriodId);

      await loadRota(); // refresh main
      await loadAdminPeriodsForDropdown(); // refresh admin cache + UI
      alert("Close time saved.");
    } catch (e) {
      console.error(e);
      alert("Failed to save close time. Check console.");
    }
  });
}

if (adminClosesAtClearBtn) {
  adminClosesAtClearBtn.addEventListener("click", async () => {
    if (!adminSelectedPeriodId) return alert("Pick a rota period first.");

    try {
      await setPeriodCloseTime(adminSelectedPeriodId, null);

      // Optional: when you clear the close time, reopen everything by default
      
 await resetWeeksAfterClose(adminSelectedPeriodId);
await resetWeeksOpen(adminSelectedPeriodId);
      await loadRota();
      await loadAdminPeriodsForDropdown();
      alert("Close time cleared.");
    } catch (e) {
      console.error(e);
      alert("Failed to clear close time. Check console.");
    }
  });
}

    /* =========================================================
       5) PIN MODAL (open/close)
       ========================================================= */
function openPinModal(user){
  selectedUser = user;

  pinTitle.textContent = `PIN for ${user.name}`;
  pinDesc.textContent = "Enter your 4-digit PIN to unlock editing.";
  pinErr.style.display = "none";
  pinInput.value = "";

  document.body.classList.add("modal-open");   // ✅ lock background scroll

  modal.style.display = "flex";
  modal.setAttribute("aria-hidden", "false");

  setTimeout(() => pinInput.focus(), 50);
}

function closePinModal(){
  modal.style.display = "none";
  modal.setAttribute("aria-hidden", "true");

  document.body.classList.remove("modal-open"); // ✅ unlock background scroll

  selectedUser = null;
  pinConfirmBtn.disabled = false;
}
    
pinCancelBtn.addEventListener("click", closePinModal);
modal.addEventListener("click", (e) => { if(e.target === modal) closePinModal(); });

pinInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    pinConfirmBtn.click();
  }
});

    /* =========================================================
       6) AUTH (verify PIN via RPC)
       ========================================================= */
    pinConfirmBtn.addEventListener("click", async () => {
      const pin = pinInput.value.trim();
      if(!selectedUser) return;

      if(!/^\d{4}$/.test(pin)){
        pinErr.textContent = "PIN must be 4 digits.";
        pinErr.style.display = "block";
        return;
      }

      pinConfirmBtn.disabled = true;
      pinErr.style.display = "none";

      try{
        const { data: ok, error } = await supabaseClient.rpc("verify_user_pin", {
          p_user_id: selectedUser.id,
          p_pin: pin
        });

        if(error){
          console.error("RPC error:", error);
          pinErr.textContent = "Server error (RPC).";
          pinErr.style.display = "block";
          pinConfirmBtn.disabled = false;
          return;
        }

        if(ok !== true){
          pinErr.textContent = "Wrong PIN.";
          pinErr.style.display = "block";
          pinConfirmBtn.disabled = false;
          return;
        }

  currentUser = selectedUser;
setSessionPin(selectedUser.id, pin); // ✅ critical (used for saving requests)
localStorage.setItem(STORAGE_KEY, currentUser.id);

closePinModal();
applyUnlockState();
updateBadges();
updateCloseLabel(activePeriodObj);

      }catch(err){
        console.error("Login exception:", err);
        pinErr.textContent = "Login error. Try again.";
        pinErr.style.display = "block";
        pinConfirmBtn.disabled = false;
      }
    });
function updateBadges(){
  if(!currentUser){
    loginBadge.textContent = "Not logged in";
    loginBadge.style.cursor = "default";
    adminBadge.style.display = "none";
    sessionPin = null;
    if (adminTabUsers) adminTabUsers.style.display = "none";
    return;
  }

  loginBadge.textContent = `Logged in: ${currentUser.name}`;
  loginBadge.style.cursor = "pointer";
  adminBadge.style.display = currentUser.is_admin ? "inline-block" : "none";
  if (adminTabUsers) adminTabUsers.style.display = currentUser.is_admin ? "" : "none";
}

  // DO NOT touch adminViewUsers here.
  // Tab visibility is handled by showAdminTab().


/* =========================================================
   PATCH 2) SHIFT PICKER LOGIC (with OFF priority)
   ========================================================= */

function openShiftModal(){
  if (!activeCell) return;

  document.body.classList.add("modal-open");   // ✅ lock background scroll

  shiftModal.style.display = "flex";
  shiftModal.setAttribute("aria-hidden", "false");
}

function closeShiftModal(){
  document.activeElement?.blur?.(); // ✅ helps on mobile + prevents stuck focus
  shiftModal.style.display = "none";
  shiftModal.setAttribute("aria-hidden", "true");
  document.body.classList.remove("modal-open");
  activeCell = null;
}
// ===============================
// FIX 1: Shift modal close actions
// ===============================

// Cancel button closes
if (shiftCancelBtn) shiftCancelBtn.addEventListener("click", closeShiftModal);

// Clicking the backdrop closes (only if you clicked the overlay itself)
if (shiftModal) {
  shiftModal.addEventListener("click", (e) => {
    if (e.target === shiftModal) closeShiftModal();
  });
}

// Escape closes (only add ONCE globally)
document.addEventListener("keydown", (e) => {
  if (e.key !== "Escape") return;

  if (shiftModal && shiftModal.style.display === "flex") closeShiftModal();
  if (modal && modal.style.display === "flex") closePinModal();
  if (weekCommentModal && weekCommentModal.style.display === "flex") closeWeekCommentModal();
  if (adminModal && adminModal.style.display === "flex") closeAdminConsole();
  if (userModal && userModal.style.display === "flex") closeUserModal(); // ← THIS
});


    
document.querySelectorAll(".shift-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    if (!activeCell) return;

    const td = activeCell.td;
    const userId = activeCell.userId;
    const date = activeCell.date;
const shift = btn.dataset.shift;
const key = `${userId}_${date}`;
const existing = requestsCache.get(key);

// Special handling for OFF: cycle priority
let rankToSave = null;

if (shift === "O") {
  const pe = pendingEdits[key];
  const existing = requestsCache.get(key);

  const currentRank =
    (pe && pe.shift === "O") ? (pe.important_rank ?? null) :
    (existing?.value === "O") ? (existing.important_rank ?? null) :
    null;

  const taken = getTakenOffRanksThisWeek(userId, date, key);
  rankToSave = nextOffPrioritySmart(currentRank, taken);
}
 

    /* -----------------------------
       STEP 1: Max 5 per week guard
       ----------------------------- */
    if (shift !== "CLEAR") {
      const currentCount = countUserRequestsThisWeek(userId, date);
      const alreadyExists = requestsCache.has(key);

      if (!alreadyExists && currentCount >= MAX_REQUESTS_PER_WEEK) {
        alert("You can only enter 5 requests per week.");
        closeShiftModal();
        return;
      }
    }


    /* -----------------------------
       Optimistic UI update
       ----------------------------- */
 if (shift === "CLEAR") {
  td.textContent = "";
  delete pendingEdits[key];
} else if (shift === "O") {
  if (rankToSave === 1) td.textContent = "O¹";
else if (rankToSave === 2) td.textContent = "O²";
else if (rankToSave === 3) td.textContent = "O³";
else td.textContent = "O";

  pendingEdits[key] = { userId, date, shift, important_rank: rankToSave };
} else {
  td.textContent = shift;
  pendingEdits[key] = { userId, date, shift, important_rank: null };
}

    closeShiftModal();
/* -----------------------------
   Auto-save to Supabase
   ----------------------------- */
try {
  if (shift === "CLEAR") {
    await deleteRequestCell(userId, date);
    requestsCache.delete(key);
    delete pendingEdits[key];
    toast(`Cleared + saved (${key})`);
  } else {
    const saved = await upsertRequestCell(
      userId,
      date,
      shift,
      rankToSave
    );

    requestsCache.set(key, saved);
    delete pendingEdits[key];
    toast(`Saved (${key}) = ${shift}`);
  }
} catch (err) {
  console.error("Auto-save failed:", err);

  const msg =
    err?.message ||
    err?.error?.message ||
    err?.details ||
    JSON.stringify(err);

// Revert UI to last known good state (pendingEdits first, then saved)
const pe = pendingEdits[key];
const existing = requestsCache.get(key);

const row = pe ? { value: pe.shift, important_rank: pe.important_rank } : existing;
if (row?.value === "O") {
  if (row.important_rank === 1) td.textContent = "O¹";
  else if (row.important_rank === 2) td.textContent = "O²";
  else if (row.important_rank === 3) td.textContent = "O³";
  else td.textContent = "O";
} else {
  td.textContent = row?.value || "";
}



  delete pendingEdits[key];

  if ((msg || "").toLowerCase().includes("max 5")) {
    alert("Max 5 requests per week. Clear one day to pick another.");
    return;
  }

  if ((msg || "").toLowerCase().includes("priority") ||
      (msg || "").toLowerCase().includes("max 2")) {
    alert("You can only have 2 priority OFF requests per week.");
    return;
  }

  alert("Save failed. Check console.");
}
  });
});


    /* =========================================================
   PATCH 2B) AUTO-SAVE (write to Supabase after each selection)
   ========================================================= */

function toast(msg){
  // tiny, non-annoying feedback. If you hate it, delete it.
  console.log(msg);
}

// Upsert a single cell to Supabase
async function upsertRequestCell(userId, date, value, importantRank){
  if (!currentUser) throw new Error("Not logged in.");

  const pin = sessionStorage.getItem(pinKey(currentUser.id));
  if (!pin) throw new Error("Missing session PIN. Log in again.");

  // Admin editing someone else -> admin RPC
  if (currentUser.is_admin && String(userId) !== String(currentUser.id)) {
    const { data, error } = await supabaseClient.rpc("admin_set_request_cell", {
      p_admin_id: currentUser.id,
      p_pin: pin,
      p_target_user_id: userId,
      p_date: date,
      p_value: value,
      p_important_rank: importantRank ?? null
    });
    if (error) throw error;
    return data;
  }

  // Normal -> user RPC
  const { data, error } = await supabaseClient.rpc("set_request_cell", {
    p_user_id: userId,
    p_pin: pin,
    p_date: date,
    p_value: value,
    p_important_rank: importantRank ?? null
  });
  if (error) throw error;
  return data;
}



// Delete a cell completely (optional, but nice for CLEAR)
async function deleteRequestCell(userId, date){
  if (!currentUser) throw new Error("Not logged in.");

  const pin = sessionStorage.getItem(pinKey(currentUser.id));
  if (!pin) throw new Error("Missing session PIN. Log in again.");

  // Admin editing someone else -> admin RPC
  if (currentUser.is_admin && String(userId) !== String(currentUser.id)) {
    const { error } = await supabaseClient.rpc("admin_clear_request_cell", {
      p_admin_id: currentUser.id,
      p_pin: pin,
      p_target_user_id: userId,
      p_date: date
    });
    if (error) throw error;
    return;
  }

  // Normal -> user RPC
  const { error } = await supabaseClient.rpc("clear_request_cell", {
    p_user_id: userId,
    p_pin: pin,
    p_date: date
  });
  if (error) throw error;
}

    
async function loadRota() {
  // -----------------------------
  // 7A) Load users
  // -----------------------------
  const { data: users, error: userError } = await supabaseClient
    .from("users")
    .select("id, name, role_id, is_admin, is_active, roles(name)")
    .order("created_at", { ascending: true })

  if (userError) {
    console.error("Users load error:", userError);
    alert("Failed to load users.");
    return;
  }

  // Build helper map
  usersById = new Map((users || []).map(u => [u.id, u.name]));

  // 🔐 Restore logged-in user from localStorage (ONE TIME LOGIN)
const savedId = localStorage.getItem(STORAGE_KEY);
if (savedId && !currentUser) {
  const restored = (users || []).find(u => String(u.id) === String(savedId));
  const restoredPin = restored ? sessionStorage.getItem(pinKey(restored.id)) : null;

  if (restored && restoredPin) {
    currentUser = restored;
    updateBadges();
    applyUnlockState();
  } else {
    localStorage.removeItem(STORAGE_KEY);
  }
}




// -----------------------------
// 7C) Load rota periods (dropdown + active)
// -----------------------------
let periods;
try {
  periods = await fetchRotaPeriods();
} catch (e) {
  console.error("Period load error:", e);
  alert("Failed to load rota periods.");
  return;
}

if (!periods.length) {
  alert("No rota periods available.");
  return;
}

periodsCache = periods;

// choose active by default, else latest
const active = periods.find(p => p.is_active);
const latest = periods[periods.length - 1];

// Only choose default if user hasn't picked one yet
if (activePeriodId == null) {
  activePeriodId = active ? active.id : latest.id;
}

// populate dropdown + label
populatePeriodDropdown(periods);
periodSelect.value = String(activePeriodId);

const selected = periods.find(p => String(p.id) === String(activePeriodId));
activePeriodObj = selected;   // ← THIS is 5A in action
updateCloseLabel(selected);
  
// -----------------------------
// 7D) Load rota dates FOR SELECTED PERIOD
// -----------------------------
const { data: dates, error: dateError } = await supabaseClient
  .from("rota_dates")
 .select("date, week_id, period_id, rota_weeks(id, open, open_after_close)")
  .eq("period_id", activePeriodId)
  .order("date");

if (dateError) {
  console.error("Dates load error:", dateError);
  alert("Failed to load dates for this period.");
  return;
}

// -----------------------------
// 7D.5) Load requests for this period (so saved cells show up)
// -----------------------------
const selectedPeriod = periods.find(p => String(p.id) === String(activePeriodId));
const start = selectedPeriod?.start_date;
const end = selectedPeriod?.end_date;

if (start && end) {
  const { data: reqs, error: reqErr } = await supabaseClient
    .from("requests")
    .select("id, user_id, date, value, important_rank")
    .gte("date", start)
    .lte("date", end);

  if (reqErr) {
    console.error("Requests load error:", reqErr);
    alert("Failed to load requests.");
    return;
  }

  requestsCache.clear();
  for (const r of (reqs || [])) {
    requestsCache.set(`${r.user_id}_${r.date}`, r);
  }
} else {
  console.warn("No period dates found for requests fetch.");
  requestsCache.clear();
}

// -----------------------------
// 7E) Render table (weeks + users)
// -----------------------------
const weeks = groupDatesIntoWeeks(dates);


// Hide inactive users from the rota table (for everyone)
// (Admins can still view/manage them in Admin → Users with "Show inactive")
const visibleUsers = users.filter(u => u.is_active !== false);

render(visibleUsers, weeks);

  
// Period label
if (weeks.length) {
document.getElementById("periodLabel").textContent =
  `${fmt(weeks[0].weekStart)} – ${fmt(weeks[weeks.length - 1].weekEnd)} · 5-week period`;

}

// Apply locks + badges
applyUnlockState();
updateBadges();
  }

    /* =========================================================
   8) RENDER (table header + grouped rows)
   ========================================================= */
function render(users, weeks){
  const table = document.getElementById("rota");
  table.innerHTML = "";

  // Debug guard: ensure every week has an ID
  weeks.forEach(w => {
    if (!w.weekId) {
      console.warn("Missing weekId for week:", w.weekStart, w);
    }
  });


  const thead = document.createElement("thead");
  const tbody = document.createElement("tbody");
  table.appendChild(thead);
  table.appendChild(tbody);

  // ----- Header row 1: week labels
  const r1 = document.createElement("tr");
  const hName = document.createElement("th");
  hName.className = "name-col";
  hName.textContent = "Name";
  r1.appendChild(hName);

  weeks.forEach((w, idx) => {
    const th = document.createElement("th");
    th.className = "week-head " + (effectiveOpenForWeek(w) ? "" : "closed");


    th.colSpan = 7;
    th.innerHTML = `
  <span class="week-label">${fmt(w.weekStart)} – ${fmt(w.weekEnd)}</span>
${w.weekId ? `
  <button
    class="week-comment-btn"
    type="button"
    data-week-id="${String(w.weekId)}"
    title="Week comment"
  >💬</button>
` : `
  <span
    style="opacity:0.35; margin-left:6px;"
    title="Week has no ID (rota_dates.week_id missing)"
  >💬</span>
`}
`;
r1.appendChild(th);

    if(idx !== weeks.length - 1){
      const sep = document.createElement("th");
      sep.className = "week-sep";
      r1.appendChild(sep);
    }
  });
  thead.appendChild(r1);

  // ----- Header row 2: day letters
  const r2 = document.createElement("tr");
  const blank2 = document.createElement("th");
  blank2.className = "name-col";
  blank2.textContent = "";
  r2.appendChild(blank2);

  const dayLetters = ["S","M","T","W","T","F","S"];
  weeks.forEach((w, idx) => {
    for(let i=0;i<7;i++){
      const th = document.createElement("th");
     th.className = "day " + (effectiveOpenForWeek(w) ? "" : "closed");

      th.textContent = dayLetters[i];
      r2.appendChild(th);
    }
    if(idx !== weeks.length - 1){
      const sep = document.createElement("th");
      sep.className = "week-sep";
      r2.appendChild(sep);
    }
  });
  thead.appendChild(r2);

  // ----- Header row 3: date numbers
  const r3 = document.createElement("tr");
  const blank3 = document.createElement("th");
  blank3.className = "name-col";
  blank3.textContent = "";
  r3.appendChild(blank3);

  weeks.forEach((w, idx) => {
    for(let i=0;i<7;i++){
      const d = new Date(w.days[i].date);
      const isWeekend = (i === 0 || i === 6);
      const th = document.createElement("th");
     th.className = "date " + (effectiveOpenForWeek(w) ? "" : "closed") + (isWeekend ? " weekend" : "");

      th.textContent = d.getDate();
      r3.appendChild(th);
    }
    if(idx !== weeks.length - 1){
      const sep = document.createElement("th");
      sep.className = "week-sep";
      r3.appendChild(sep);
    }
  });
  thead.appendChild(r3);

  // ----- Body grouped by role
  const groups = groupUsers(users);

  for(const g of groups){
    // section header row
    const sectionTr = document.createElement("tr");
    sectionTr.className = "section-row";

    const sectionTd = document.createElement("td");
    sectionTd.className = `name-col ${g.className}`;
    sectionTd.colSpan = 1 + (weeks.length * 7) + (weeks.length - 1);
    sectionTd.innerHTML = `<span>${g.title}</span>`;
    sectionTr.appendChild(sectionTd);
    tbody.appendChild(sectionTr);

    // user rows
    for(const u of g.items){
      const tr = document.createElement("tr");
      tr.dataset.userId = u.id;

      // name cell (PIN login)
      const nameTd = document.createElement("td");
      nameTd.className = "name-col";
      nameTd.textContent = u.name;
      nameTd.title = u.name;
      nameTd.addEventListener("click", () => openPinModal(u));
      tr.appendChild(nameTd);

      // date cells
      weeks.forEach((w, idx) => {
        for(let i=0;i<7;i++){
          const isWeekend = (i === 0 || i === 6);
          const dateStr = w.days[i].date;

          const td = document.createElement("td");
          td.className = "cell" + (effectiveOpenForWeek(w) ? "" : " closed") + (isWeekend ? " weekend" : "");

          td.dataset.userId = u.id;
          td.dataset.date = dateStr;

          // ✅ Fill from cache / pending edits
          const key = `${u.id}_${dateStr}`;

          // Pending edits override everything visually
if (pendingEdits[key]) {
  const pe = pendingEdits[key];

if (pe.shift === "O") {
  if (pe.important_rank === 1) td.textContent = "O¹";
  else if (pe.important_rank === 2) td.textContent = "O²";
  else if (pe.important_rank === 3) td.textContent = "O³";
  else td.textContent = "O";
} else {
  td.textContent = pe.shift || "";
}

} else {
  const r = requestsCache.get(key);

  if (r?.value === "O") {
    if (r.important_rank === 1) td.textContent = "O¹";
    else if (r.important_rank === 2) td.textContent = "O²";
    else if (r.important_rank === 3) td.textContent = "O³";
    else td.textContent = "O";
  } else {
    td.textContent = r?.value || "";
  }
}
          

          tr.appendChild(td);
        }

        if(idx !== weeks.length - 1){
          const sep = document.createElement("td");
          sep.className = "week-sep";
          tr.appendChild(sep);
        }
      });

      tbody.appendChild(tr);
    }
  }

  // Keep your existing logic
  applyUnlockState();
  updateBadges();
}


    /* =========================================================
   9) UNLOCK LOGIC (who can edit which row)
   ========================================================= */
function applyUnlockState(){
  const rows = document.querySelectorAll("#rota tbody tr");

  rows.forEach(r => {
    if (r.classList.contains("section-row")) return;

    const userId = r.dataset.userId;

  const isUnlocked =
  currentUser && (
    currentUser.is_admin ||
    String(currentUser.id) === String(userId)
  );

    r.classList.toggle("unlocked", !!isUnlocked);
    r.classList.toggle("locked", !isUnlocked);

    r.querySelectorAll("td.cell").forEach(td => {
      const isClosedWeek = td.classList.contains("closed");

      // ✅ FINAL rule:
      // - must be your row (or admin)
      // - week must be open (closed class blocks)
      // periodClosed is NOT a blocker: week toggle overrides it
      const canEdit = !!isUnlocked && !isClosedWeek;

      td.classList.toggle("editable", canEdit);

      if (!td.dataset.bound) {
        td.dataset.bound = "1";
        td.addEventListener("click", () => {
          if (!td.classList.contains("editable")) return;

          activeCell = {
            td,
            userId: td.dataset.userId,
            date: td.dataset.date
          };

          openShiftModal();
        });
      }
    });
  });
}


    /* =========================================================
       10) BOOT
       ========================================================= */
    loadRota();
    

  </script>
</body>
</html>





















































































































































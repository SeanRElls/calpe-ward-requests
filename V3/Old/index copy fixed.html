<!DOCTYPE html>
<html lang="en">
<head>
  <!-- PWA / iOS Home Screen -->
<link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180.png">

<link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-192.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-192.png">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Calpe Ward Requests">

<link rel="manifest" href="/manifest.webmanifest">
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calpe Ward Off Duty Requests</title>

  <!-- Supabase JS (v2) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Quill Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- =========================
       STYLES
       ========================= -->

  <style>
 :root{
  --grid: #d9d9d9;
  --grid-soft: #ececec;
  --text: #111;
  --muted: #6b6b6b;
  --header: #f4f4f4;
  --sheet-bg: #ffffff;
  --sep: #c0c0c0;
  --sep-fill: #e3e3e3;

  --closed-fill: #f0f0f0;
  --weekend-fill: #fafafa;

  --cn-band: #a8e6a1;
  --sn-band: #9fd0ff;
  --na-band: #ffd18a;

  /* ‚úÖ shared modal/admin theme vars (so userModal doesn't rely on later CSS order) */
  --accent: #4F8DF7;
  --accent-hover: #2F6FEA;
  --accent-weak: rgba(79,141,247,0.16);
  --accent-weak-hover: rgba(79,141,247,0.24);

  --ink: #0f172a;
  --card: #ffffff;
  --line: #e6e8ee;
  --soft: #f6f7fb;
}


    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 18px;
      color: var(--text);
      background: #f7f7f7;
    }

.wrap{
  background: var(--sheet-bg);
  border: 1px solid var(--grid);
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  padding: 10px;
  overflow: hidden;
  
}
/* Scroll container for the whole rota */
.rota-scroll{
  width: 100%;
  overflow: auto;                 /* both x + y */
  max-height: calc(100vh - 220px);/* adjust this number */
  -webkit-overflow-scrolling: touch;
  touch-action: pan-x pan-y;
}


/* ===== nice status pill for closeLabel ===== */
#closeLabel{
  margin-top: 6px;
}
.close-pill .msg{ font-weight: 650; }

    .close-pill{
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 999px;
  background: #f2f4f7;
  border: 1px solid #d7dbe0;
  color: #222;
  font-size: 12px;
  line-height: 1;
  white-space: nowrap;
}

    body.modal-open{
  overflow: hidden;
  
}
    
.close-pill .dot{
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: #2e7d32; /* green */
  flex: 0 0 auto;
}

.close-pill.is-soon{
  background: #fff4e5;
  border-color: #ffd59a;
}
.close-pill.is-soon .dot{ background:#d97706; } /* amber */

.close-pill.is-closed{
  background: #f3f3f3;
  border-color: #d0d0d0;
  color: #666;
}
.close-pill.is-closed .dot{ background:#888; }

.close-pill strong{
  font-weight: 750;
}

.close-pill .mini{
  opacity: 0.85;
}
.week-toggle-btn{
  min-height: 40px;
  padding: 10px 14px;
}
.close-pill .timeleft{
  font-variant-numeric: tabular-nums;
  font-weight: 750;
  padding: 4px 8px;
  border-radius: 999px;
  background: rgba(0,0,0,0.06);
}

#adminPeriodSelect{
  min-height: 40px;
}
    .titlebar{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin: 2px 2px 12px;
    }

    h1{
      font-size: 22px;
      margin: 0;
      font-weight: 750;
      letter-spacing: 0.2px;
    }

    .subtitle{
      font-size: 13px;
      color: var(--muted);
    }

    .rightbits{
      display:flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .badge{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background:#eee;
      color:#222;
      white-space: nowrap;
    }

    .badge.admin{
      background:#222;
      color:#fff;
    }

  .week-toggle-btn{
  flex: 0 0 auto;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: fit-content;
  padding: 6px 10px;
  min-width: 0;
  border-radius: 999px;
  font-size: 12px;
  line-height: 1;
}

    table{
      border-collapse: separate;
      border-spacing: 0;
      width: max-content;
      min-width: 100%;
      font-size: 12px;
    }

    th, td{
      border-right: 1px solid var(--grid-soft);
      border-bottom: 1px solid var(--grid-soft);
      text-align: center;
      vertical-align: middle;
      padding: 0;
      height: 24px;
      background: #fff;
      min-width: 34px;
    }

    table tr:first-child th{ border-top: 1px solid var(--grid); }
    table tr th:first-child, table tr td:first-child{ border-left: 1px solid var(--grid); }
    table tr:last-child td{ border-bottom: 1px solid var(--grid); }
    table tr th{ border-bottom: 1px solid var(--grid); }

/* =========================================================
   STICKY HEADER (single source of truth)
   Fixes iOS "see-through" + keeps your old look
   ========================================================= */

:root{
  --h-week: 28px; /* row 1 height */
  --h-day:  22px; /* row 2 height */
  --h-date: 22px; /* row 3 height */
}

/* Make sure the scroll container forms a stacking context */
.rota-scroll{
  position: relative;
  isolation: isolate; /* stops weird bleed-through compositing */
}

/* Header cells: force truly opaque paint on iOS */
thead th{
  position: sticky;
  background: var(--header) !important;
  background-clip: padding-box;
  opacity: 1;

  /* force its own composited layer */
  transform: translateZ(0);
  -webkit-transform: translateZ(0);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;

  /* crucial: always above tbody */
  z-index: 100;
}

/* Exact heights so Safari can‚Äôt invent half-pixel gaps */
thead tr:nth-child(1) th{ height: var(--h-week); top: 0; z-index: 130; background:#ededed !important; }
thead tr:nth-child(2) th{ height: var(--h-day);  top: calc(var(--h-week) - 1px); z-index: 120; }
thead tr:nth-child(3) th{ height: var(--h-date); top: calc(var(--h-week) + var(--h-day) - 2px); z-index: 110; }

/* Draw the bottom line once */
thead tr:nth-child(3) th{
  box-shadow: inset 0 -1px 0 var(--grid);
}

/* Keep the pinned name header above everything */
thead .name-col{
  z-index: 200 !important;
  background: #ededed !important;
}
/* Rota name cells (tbody) */
tbody td.name-col{
  font-weight: 600;   /* 500 if you want softer */
  background: #fff;
}

    thead th.name-col{
  font-weight: 750;
}

    
/* Keep body cells below header no matter what Safari feels like */
tbody td{
  position: relative;
  z-index: 1;
}

    

    
@media (max-width: 480px){
  .name-col{
    font-size: 12px;
  }
}

  .week-comment-btn{
  flex: 0 0 auto;          /* stop flex stretching */
  min-width: 0 !important; /* override global min-width:110px */
  width: 22px;
  height: 22px;
  padding: 0;
  margin-left: 6px;

  display: inline-flex;
  align-items: center;
  justify-content: center;

  border: 1px solid #ccc;
  border-radius: 999px;
  background: #fff;
  cursor: pointer;
  font-size: 12px;
  line-height: 1;
}
.week-comment-btn.has-comment{
  border-color:#111;
  font-weight:700;
}
    
.week-label { font-weight: 600; }

    .header-subrow{
  display:flex;
  flex-wrap:wrap;
  gap: 8px;              /* <-- this is your "space after the badge" */
  align-items:center;
}
#periodLabel{ margin: 0; }
#closeLabel{ margin: 0; }
    th.week-label{
      font-weight: 800;
      font-size: 12px;
      letter-spacing: 0.2px;
      color: #222;
      height: 28px;
      background: #ededed;
    }

    th.day{
      font-weight: 800;
      height: 22px;
      color: #222;
    }

    th.date{
      font-weight: 700;
      height: 22px;
      color: #222;
    }

    .week-sep{
      min-width: 14px;
      width: 14px;
      background: var(--sep-fill) !important;
      border-right: 2px solid var(--sep) !important;
      border-left: 0 !important;
    }

    .closed{
      background: var(--closed-fill) !important;
      color: #9b9b9b;
    }

    .weekend{
      background: var(--weekend-fill);
    }
    
.badge.admin{
  cursor: pointer;
  user-select: none;
}

.badge.admin:hover{
  filter: brightness(0.9);
}

.badge.admin:active{
  transform: scale(0.97);
}
    tr.section-row td{
      height: 22px;
      font-weight: 850;
      text-align: left;
      padding: 0 10px;
      border-top: 2px solid #9a9a9a;
      border-bottom: 2px solid #9a9a9a;
    }

    tr.section-row td span{
      color: #1b1b1b;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    td.section-cn { background: var(--cn-band) !important; }
    td.section-sn { background: var(--sn-band) !important; }
    td.section-na { background: var(--na-band) !important; }

    td.cell{
      font-size: 12px;
      color: #111;
    }

    td.cell:hover{
      background: #f6fbff;
    }

    /* Locked vs unlocked rows (admin-only highlight) */
    /* Locked cells get a faint warm background and subtle left accent when
       viewed by admins so staff-visible locked slots are obvious at a glance. */
    /* Make the selector specific and use !important so it overrides the
       `.closed` rule (which uses !important) when admins view the rota. */
    body.admin-view tr.locked td.cell,
    body.admin-view tr.locked td.cell.closed,
    body.admin-view td.cell.locked-admin {
      background-color: #fff7e0 !important; /* faint warm yellow/gold */
      box-shadow: inset 4px 0 0 rgba(255, 183, 0, 0.12) !important; /* subtle left accent */
      opacity: 1 !important; /* keep text legible */
      color: inherit !important;
    }

    body.admin-view tr.locked td.cell:hover,
    body.admin-view td.cell.locked-admin:hover{
      background-color: #fff7e0 !important; /* keep hover from reverting to white */
    }

    tr.unlocked td.cell{ opacity: 1; }
    tr.unlocked td.cell.editable{ outline: 2px solid rgba(0,0,0,0.08); cursor: pointer; }

    /* ===== MODALS (shared) ===== */
.modal-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.28);
  backdrop-filter: blur(3px);
  display: none;
  z-index: 1000;

  padding: 14px;
  padding-bottom: calc(14px + env(safe-area-inset-bottom));

  overflow: hidden;
  align-items: flex-start;
  justify-content: center;
}

/* ‚úÖ When any modal backdrop is opened (including userModal) */
.modal-backdrop[aria-hidden="false"]{
  display: flex;
}


.modal{
  width: min(520px, 100%);
  background: linear-gradient(180deg, #ffffff 0%, #f6f8fc 100%);
  border-radius: 22px;
  border: 1px solid rgba(15,23,42,0.05);
  box-shadow: var(--modal-shadow);
  padding: 18px;
  font-family: "Manrope", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: var(--ink);

  /* ‚úÖ scrolling */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;

  /* ‚úÖ REAL viewport height on modern mobile */
  max-height: calc(100dvh - 28px);

  /* ‚úÖ keep last content reachable above iPhone home bar */
  padding-bottom: calc(18px + env(safe-area-inset-bottom));
}

/* ‚úÖ fallback for older iOS that doesn't support dvh properly */
@supports not (height: 100dvh){
  .modal{ max-height: calc(100vh - 28px); }
}


    .modal h2{
      margin: 0 0 8px 0;
      font-size: 17px;
      font-weight: 700;
      letter-spacing: 0.1px;
    }

    .modal p{
      margin: 0 0 12px 0;
      font-size: 12.5px;
      color: #6b7387;
      line-height: 1.35;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items: stretch;
      flex-wrap: wrap;
    }

    input.pin{
      flex: 1 1 220px;
      font-size: 18px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid #ccc;
      letter-spacing: 10px;
      text-align: center;
      min-width: 220px;
    }

    .btns{
      display:flex;
      gap: 10px;
      flex: 1 1 200px;
      justify-content: flex-end;
      min-width: 200px;
    }

    button{
      font-size: 14px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #ccc;
      background: #f7f7f7;
      cursor: pointer;
      flex: 1;
      min-width: 110px;

      
    }
/* =========================
   HEADER BUTTON FIX
   ========================= */
.rightbits button{
  flex: 0 0 auto !important;
  min-width: 0 !important;
  width: auto;
  padding: 4px 10px !important;
  border-radius: 999px !important;
  font-size: 12px !important;
  line-height: 1 !important;
  height: 28px;
}

#noticeBell{
  width: 36px;
  padding: 0 !important;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

#noticeBellDot{
  position: absolute;
  right: 6px;
  top: 3px;
}



    
    button.primary{
      background:#111;
      border-color:#111;
      color:#fff;
    }

    button:disabled{
      opacity: 0.6;
      cursor: not-allowed;
    }

    .err{
      margin-top: 10px;
      font-size: 12px;
      color: #b00020;
      display:none;
    }

    @media (max-width: 480px){
      body{ margin: 12px; }
      .wrap{ padding: 12px; }
      .titlebar{ flex-direction: column; align-items: flex-start; }
      .rightbits{ justify-content: flex-start; }
      input.pin{ flex: 1 1 100%; min-width: 0; }
      .btns{ flex: 1 1 100%; min-width: 0; }
      button{ min-width: 0; }
    }


#adminUsersList{
  border: 1px solid #eceef2;
  border-radius: 14px;
  overflow: hidden;
  background: #fff;
}

.user-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  cursor: grab;
}

.user-row:active {
  cursor: grabbing;
}

.user-row.dragging {
  opacity: 0.5;
}

.user-row.drag-over {
  border-top: 2px solid #4A90E2;
}

.drag-handle {
  cursor: grab;
  user-select: none;
  font-size: 14px;
  color: #ccc;
  padding: 2px 4px;
  margin-left: -4px;
  margin-right: 4px;
}

.drag-handle:hover {
  color: #999;
}

.drag-handle:active {
  cursor: grabbing;
}

.user-meta{ min-width:0; }              /* allows name to shrink */
.user-name{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}



.user-actions button{
  white-space: nowrap;                  /* ‚úÖ prevents button text wrapping */
}

.user-meta{
  min-width:0;
}

.user-name{
  font-weight: 600;           /* or 500 if you want even quieter */
  font-size: 13px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}




.user-actions{
  display:flex;
  gap: 6px;
  flex: 0 0 auto;
}

.user-tag{
  display:inline-block;
  margin-left: 6px;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 800;
  border: 1px solid #ddd;
  background: #f7f7f7;
  color: #333;
}

.user-tag.admin{
  background:#111;
  border-color:#111;
  color:#fff;
}

.user-tag.inactive{
  background:#f3f3f3;
  color:#666;
}

    #adminViewUsers #adminSaveUserBtn,
#adminViewUsers #adminCancelUserEditBtn{
  height: 36px;
  border-radius: 999px;
}

    /* ===== SHIFT PICKER ===== */
    .shift-grid{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 12px 0 16px;
    }

    .shift-btn{
      padding: 14px 0;
      font-size: 14px;
      border-radius: 12px;
      border: 1px solid #ccc;
      background: #f7f7f7;
      cursor: pointer;
      font-weight: 700;
    }

    .shift-btn:hover{
      background: #e9f2ff;
    }

    .shift-btn.off{
      background: #ffecec;
      border-color: #ffb3b3;
    }
    
#periodSelect{
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid #ccc;
  background: #fff;
  font-size: 12px;
  min-width: 220px;
  flex: 0 0 auto;
}

.week-head{ z-index: 35; }
.week-comment-btn{ position: relative; z-index: 60; }

    
  @media (max-width: 480px){
  .shift-grid{
    grid-template-columns: repeat(2, 1fr);
  }
}

/* =========================
   USER MODAL - match ADMIN
   ========================= */

#userModal .modal{
  padding: 18px;
  border-radius: 22px;
  background: linear-gradient(180deg, #ffffff 0%, #f6f8fc 100%);
  border: 1px solid rgba(15,23,42,0.05);
  color: var(--ink);
  font-family: "Manrope", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

#userModal h2{
  font-size: 17px;
  font-weight: 700;
  letter-spacing: 0.2px;
  margin: 0 0 6px;
}

#userModal .subtitle{
  font-size: 12px;
  color: #667085;
}

/* card block */
/* Only make actual ‚Äúcards‚Äù look like cards */
#userModal .card{
  border: 1px solid #e7ebf3;
  border-radius: 16px;
  background: #fff;
  box-shadow: 0 8px 20px rgba(15,23,42,0.06);
}


/* stack the 3 inputs */
#userModal .row{
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* compact inputs */
#userModal input.user-pin{
  height: 32px;
  padding: 4px 12px;
  border-radius: 10px;
  border: 1px solid #e5eaf3;
  font-size: 12.5px;
  background: #fff;
  letter-spacing: 2px;
  text-align: center;
  box-sizing: border-box;
}

/* buttons like admin */
#userModal button{
  height: 32px;
  padding: 0 14px;
  border-radius: 12px;
  font-size: 12.5px;
  border: 1px solid #e5eaf3;
  background: #fff;
  color: var(--ink);
  min-width: auto;
  flex: 0 0 auto;
}

#userModal button.primary{
  background: linear-gradient(180deg, #6f8bff 0%, #5472f2 100%);
  border: 1px solid rgba(84,114,242,0.5);
  color: #fff;
}

#userModal button.primary:hover{
  background: linear-gradient(180deg, #6382ff 0%, #4a67e2 100%);
  border-color: rgba(74,103,226,0.6);
}

/* save button right aligned */
#userModal #userSavePin{
  align-self: flex-end;
}

/* bottom row: logout left, close right */
#userModal .btns:last-of-type{
  display: flex;
  justify-content: space-between;
  gap: 8px;
}

/* ===== User modal header with FLAGS ===== */
#userModal .user-head{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 10px;
  margin-bottom: 6px;
}

#userModal .user-flags{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap: 6px;
}

#userModal .flags-label{
  font-size: 11px;
  font-weight: 500;
  color: #667085;
}

#userModal .flags-buttons{
  display:flex;
  gap: 6px;
}

#userModal .flag-btn{
  width: 38px;
  height: 30px;
  padding: 0;
  border-radius: 999px;
  border: 1px solid #d6dbe4;
  background: #fff;
  font-size: 14px;
  line-height: 1;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

#userModal .flag-img{
  width: 20px;
  height: 20px;
  display: block;
  border-radius: 4px;
}

/* =========================
   USER MODAL (clean header)
   ========================= */

#userModal .user-head{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 12px;
  margin-bottom: 10px;
}

#userModal .user-head-left{ min-width:0; }

#userModal .user-flags{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap: 6px;
  flex: 0 0 auto;
}

#userModal .flags-label{
  font-size: 12px;
  font-weight: 600;        /* not shouty, not ‚ÄúFLAGS‚Äù energy */
  color: #667085;
}

#userModal .flags-buttons{
  display:flex;
  gap: 8px;
}

#userModal .flag-btn{
  font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji", system-ui, sans-serif;
  font-size: 18px;
  line-height: 1;

  width: 38px;
  height: 34px;
  padding: 0;

  border-radius: 999px;
  border: 1px solid #d6dbe4;
  background: #fff;

  display: inline-flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
  user-select: none;
}

#userModal .flag-btn.is-active{
  border-color: rgba(79,141,247,0.45);
  background: rgba(79,141,247,0.10);
  opacity: 1;
}

#userModal .flag-btn:not(.is-active){
  opacity: 0.7;
}

#userModal .user-footer{
  display:flex;
  justify-content: space-between;
  gap: 8px;
  margin-top: 12px;
}

/* =========================
   WEEK COMMENT MODAL
   ========================= */
#weekCommentModal #weekCommentAdminList{
  border: 1px solid #e7ebf3 !important;
  border-radius: 16px !important;
  padding: 12px !important;
  background: #ffffff !important;
  box-shadow: inset 0 1px 2px rgba(15,23,42,0.06);
}

#weekCommentModal .week-comment-row{
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid #eef1f6;
  background: #f9fafc;
}

#weekCommentModal .week-comment-row + .week-comment-row{
  margin-top: 10px;
}

#weekCommentModal .week-comment-name{
  font-weight: 700;
}

#weekCommentModal .week-comment-meta{
  font-size: 11px;
  color: #6b7387;
  margin-top: 2px;
}

#weekCommentModal .week-comment-text{
  margin-top: 6px;
  white-space: pre-wrap;
}

#weekCommentModal #weekCommentYourLabel{
  font-size: 12.5px;
  color: #6b7387;
}

#weekCommentModal #weekCommentInput{
  width: 100%;
  min-height: 110px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid #e5eaf3;
  background: #ffffff;
  font-size: 12.5px;
  line-height: 1.4;
  box-shadow: inset 0 1px 2px rgba(15,23,42,0.06);
  box-sizing: border-box;
}

#weekCommentModal .btns{
  justify-content: flex-end;
  gap: 10px;
  min-width: 0;
}

#weekCommentModal button{
  height: 32px !important;
  padding: 0 14px !important;
  border-radius: 12px !important;
  font-size: 12.5px !important;
  min-width: auto !important;
  flex: 0 0 auto !important;
}

/* =========================
   PRINT MODAL
   ========================= */
#printModal .card{
  border: 1px solid #e7ebf3;
  border-radius: 16px;
  background: #ffffff;
  box-shadow: 0 8px 20px rgba(15,23,42,0.06);
}

#printModal #printCloseX{
  width: 28px;
  height: 28px;
  padding: 0;
  border-radius: 999px;
  border: 1px solid #e5eaf3 !important;
  background: #ffffff !important;
  color: #64748b !important;
  box-shadow: none;
  flex: 0 0 auto;
  min-width: 0 !important;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 16px !important;
}

#printModal button{
  height: 32px !important;
  padding: 0 14px !important;
  border-radius: 12px !important;
  font-size: 12.5px !important;
  border: 1px solid #e5eaf3 !important;
  background: #ffffff !important;
  color: var(--ink) !important;
  box-shadow: 0 3px 8px rgba(15,23,42,0.05) !important;
  min-width: 0 !important;
}

#printModal button{
  box-sizing: border-box !important;
  height: 32px !important;
  padding: 0 14px !important;
  border-radius: 12px !important;
  font-size: 12.5px !important;
  min-width: auto !important;
  flex: 0 0 auto !important;
  background: #ffffff !important;
  border: 1px solid #e5eaf3 !important;
  color: var(--ink) !important;
  box-shadow: 0 2px 6px rgba(15,23,42,0.05) !important;
}

#printModal button.primary,
#printModal #printAdminOptions button[onclick]{
  background: #eaf0ff !important;
  border: 1px solid #c6d4ff !important;
  color: #2e50d6 !important;
  box-shadow: 0 4px 10px rgba(46,80,214,0.12) !important;
}

#printModal button.primary:hover,
#printModal #printAdminOptions button[onclick]:hover{
  background: #e0e9ff !important;
  border-color: #b6c7ff !important;
}

     /* =========================
   MOBILE HEADER LAYOUT (FINAL)
   ========================= */
@media (max-width: 520px){

  /* Title area tighter */
  .titlebar{
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
    margin: 0 0 10px;
  }

  h1{
    font-size: 20px;
    line-height: 1.1;
  }

  /* Space under Requests closed/open pill */
  #closeLabel{
    margin-top: 4px;
    margin-bottom: 8px;
  }

  .close-pill{
    padding: 6px 10px;
    gap: 8px;
    font-size: 11px;
  }

  .close-pill .timeleft{
    padding: 3px 7px;
    font-size: 11px;
  }

  .close-pill .mini{
    display: none;
  }

  /* RIGHT SIDE CONTROLS */
  .rightbits{
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: flex-start;
  }

  /* Dropdown takes full row */
  #periodSelect{
    flex: 1 1 100%;
    width: 100%;
    height: 34px;
    font-size: 12px;
    border-radius: 999px;
  }

  /* Logged-in + ADMIN sit together underneath */
  #loginBadge,
  #adminBadge{
    flex: 0 0 auto;
    font-size: 11px;
    padding: 6px 10px;
    white-space: nowrap;
  }
}
/* =========================================================
   ADMIN UI PATCH: compact, colored, tabs sticky
   ========================================================= */
:root{
  --accent: #5b7cfa;
  --accent-hover: #4f6df0;
  --accent-weak: rgba(91,124,250,0.12);
  --accent-weak-hover: rgba(91,124,250,0.18);

  --ink: #0f172a;
  --card: #ffffff;
  --line: #eef1f6;
  --soft: #f7f9fc;
  --modal-card: #ffffff;
  --modal-shadow: 0 28px 80px rgba(15,23,42,0.14);
}

/* Make ADMIN badge not "villain mode" */
.badge.admin{
  background: var(--accent);
  border: 1px solid rgba(0,0,0,0.06);
  color: #fff;
}

    
/* Admin modal container tighter + nicer */
#adminModal{
  background: rgba(15,23,42,0.28);
  backdrop-filter: blur(3px);
}

#adminModal .modal h2{
  margin: 2px 0 4px;
  line-height: 1.15;
}

#adminModal .modal p.subtitle{
  margin: 0 0 8px;
}

#adminModal .modal{
  padding: 18px;
  border-radius: 22px;
  background: linear-gradient(180deg, #ffffff 0%, #f6f8fc 100%);
  border: 1px solid rgba(15,23,42,0.05);
  box-shadow: var(--modal-shadow);
}

/* Sticky tab row (so it doesn't "disappear" when you scroll) */
#adminModal .modal > div:first-of-type{
  position: sticky;
  top: 0;
  z-index: 5;
  background: linear-gradient(180deg, #ffffff 0%, #f7f9fc 100%);
  padding-top: 4px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--line);
}

/* Tabs container */
.admin-tabs{
  display: inline-flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 4px 6px;
  margin: 6px 0 16px;
  border-radius: 14px;
  background: #f5f7fb;
  border: 1px solid #e7ecf4;
  box-shadow: none;
  justify-content: flex-start;
  align-items: center;
  width: fit-content;
}

/* Tabs: compact segmented control style */
#adminTabPeriods,
#adminTabGenerate,
#adminTabUsers,
#adminTabNotices {
  height: 28px;
  padding: 0 10px;
  border-radius: 12px;
  border: 1px solid transparent;
  background: transparent;
  font-size: 12.5px;
  font-weight: 600;
  color: #6b7387;
  min-width: 0;
  flex: 0 0 auto;
}
#adminModal .admin-tab{
  background: transparent !important;
  border: 1px solid transparent !important;
  border-radius: 12px !important;
  height: 28px !important;
  padding: 0 10px !important;
  line-height: 28px !important;
}
#adminModal .admin-tab:hover{
  color: var(--ink);
  background: rgba(15,23,42,0.04) !important;
}
#adminTabPeriods.is-active,
#adminTabGenerate.is-active,
#adminTabUsers.is-active,
#adminTabNotices.is-active{
  background: #ffffff;
  color: var(--ink);
  border: 1px solid #e4e9f2;
  box-shadow: 0 4px 10px rgba(15,23,42,0.08);
}

/* Buttons inside admin: smaller by default */
#adminModal button{
  box-sizing: border-box !important;
  height: 32px !important;
  padding: 0 14px !important;
  border-radius: 12px !important;
  font-size: 12.5px !important;
  min-width: auto !important;
  flex: 0 0 auto !important;  /* stops the "stretch to huge" look */
  background: #ffffff !important;
  border: 1px solid #e5eaf3 !important;
  color: var(--ink) !important;
  box-shadow: 0 3px 8px rgba(15,23,42,0.05) !important;
}

/* Primary action buttons: colored, not black */
#adminModal button.primary{
  background: linear-gradient(180deg, #6f8bff 0%, #5472f2 100%) !important;
  border: 1px solid rgba(84,114,242,0.5) !important;
  color: #fff !important;
  box-shadow: 0 6px 14px rgba(66,95,210,0.25) !important;
}
#adminModal button.primary:hover{
  background: linear-gradient(180deg, #6382ff 0%, #4a67e2 100%) !important;
  border-color: rgba(74,103,226,0.6) !important;
}

/* keep ADMIN badge readable but not ‚Äúvillain button‚Äù */
.badge.admin{
  background: var(--accent-weak);
  border: 1px solid rgba(91,124,250,0.25);
  color: var(--accent);
  box-shadow: none;
}
.badge.admin:hover{
  background: var(--accent-weak-hover);
  border-color: rgba(91,124,250,0.35);
}
    
/* Cards inside admin: softer */
#adminViewUsers > div,
#adminViewPeriods > div,
#adminViewGenerate > div,
#adminViewNotices > div{
  border: 1px solid #e7ebf3 !important;
  border-radius: 16px !important;
  background: var(--modal-card) !important;
  box-shadow: 0 8px 20px rgba(15,23,42,0.06);
  padding: 14px !important;
}



/* Inputs/selects: compact + clean */
#adminModal input,
#adminModal select{
  box-sizing: border-box !important;
  height: 32px !important;
  padding: 4px 12px !important;
  border-radius: 10px !important;
  border: 1px solid #e5eaf3 !important;
  font-size: 12.5px !important;
  background: #ffffff !important;
}

#adminViewNotices #adminNoticeSearch{
  border-color: #e2e8f0 !important;
  background: #ffffff !important;
  box-shadow: inset 0 1px 2px rgba(15,23,42,0.06);
}

#adminViewNotices label.subtitle{
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

#adminModal input:focus,
#adminModal select:focus{
  outline: none;
  border-color: rgba(47,91,255,0.5) !important;
  box-shadow: 0 0 0 3px rgba(47,91,255,0.12);
}

/* Users list rows: tighter */
.user-row{
  padding: 8px 10px;
}
.user-name{
  font-size: 13px;
}
.user-role{
  font-size: 11px;
  color: #6b7280;
}

/* User action buttons: small and subtle */
.user-actions button{
  height: 30px !important;
  padding: 0 10px !important;
  border-radius: 999px !important;
  font-size: 12px !important;
  background: #fff !important;
  border: 1px solid #d6dbe4 !important;
  color: #0f172a !important;
}
.user-actions button:hover{
  background: #f8fafc !important;
}

/* Tags */
.user-tag.admin{
  background: var(--accent-weak);
  border-color: rgba(90,121,201,0.32);
  color: var(--accent);
}
.user-tag.inactive{
  background: #f1f2f6;
  border-color: #e2e5ee;
  color: #6b7280;
}
#adminModal .modal{
  font-family: "Manrope", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: var(--ink);
  font-size: 13px;
}

#adminModal h2{
  font-size: 17px;
  font-weight: 700;
  letter-spacing: 0.1px;
}

#adminModal .subtitle{
  font-size: 12.5px;
  color: #6b7387;
}
  
    .user-group-title{
  padding: 10px 12px;
  font-weight: 800;
  font-size: 12px;
  color: #64748b;
  background: #f8fafc;
  border-top: 1px solid #eef2f7;
}



/* Account badge: make the badge a real button without button ugliness */
button.badge{
  appearance: none;
  -webkit-appearance: none;
  border: 1px solid var(--grid, #d9d9d9);
  background: #fff;
  cursor: pointer;
}

.account-badge{
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.account-badge .acc-ic{
  font-size: 13px;
  line-height: 1;
}

.account-badge .acc-txt{
  white-space: nowrap;
}

/* Shift modal title bar */
.shift-titlebar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  width:100%;
  margin: 0 0 6px 0;
}

.help-badge{
  /* override your global button flex/min-width */
  flex: 0 0 auto !important;
  min-width: 0 !important;
  width: 34px;                 /* small pill button */
  height: 30px;
  padding: 0;

  font-size: 12px;
  font-weight: 800;
  line-height: 1;
  border-radius: 999px;
  background: #fff;
  border: 1px solid var(--grid);
  cursor: pointer;

  display: inline-flex;
  align-items: center;
  justify-content: center;
}


.help-badge:hover{
  background: var(--accent-weak);
  border-color: rgba(37,99,235,0.28);
}

.help-badge:active{
  transform: scale(0.96);
}

.notice-card{
  border: 1px solid var(--line, #e6e8ee);
  border-radius: 14px;
  padding: 14px;
  background: #fff;
  margin-bottom: 12px;
  box-shadow: 0 6px 16px rgba(16,24,40,0.06);
}
.notice-title{ font-weight: 900; margin-bottom: 6px; }
.notice-meta{ font-size: 11px; color: #667085; margin-bottom: 8px; }
.notice-body{ white-space: pre-wrap; line-height: 1.45; font-size: 13px; color: #334155; }
.notice-pill{
  display:inline-block; font-size:11px; font-weight:800;
  padding:2px 8px; border-radius:999px; border:1px solid #d6dbe4; background:#f8fafc;
}
.notice-pill.unread{ border-color:#ffb3b3; background:#ffecec; color:#8a1f1f; }

/* Expandable "Acknowledged by" */
.notice-acks{
  margin-top: 10px;
  border-top: 1px dashed #e6e8ee;
  padding-top: 8px;
}

.notice-acks summary{
  cursor: pointer;
  font-weight: 800;
  font-size: 12px;
  color: #334155;
  list-style: none;
}

.notice-acks summary::-webkit-details-marker{ display:none; }

.notice-acks .ack-grid{
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
  margin-top: 8px;
}

.notice-acks .ack-pill{
  display:inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 800;
  border: 1px solid #d6dbe4;
  background: #f8fafc;
  color:#334155;
  margin: 2px 6px 0 0;
}

.notice-acks .ack-title{
  font-weight: 900;
  font-size: 11px;
  color:#667085;
  margin-bottom: 4px;
}

.notice-acks .ack-list{
  max-height: 160px;       /* keeps it sane */
  overflow: auto;
  border: 1px solid #eef2f7;
  border-radius: 10px;
  padding: 8px;
  background: #fff;
}

/* Quill editor styles */
.ql-toolbar.ql-snow {
  border-top-left-radius: 10px !important;
  border-top-right-radius: 10px !important;
  border: 1px solid #ccc !important;
  background: #f9fafb !important;
  padding: 10px !important;
  margin: 0 !important;
}

.ql-toolbar.ql-snow .ql-formats {
  margin-right: 20px !important;
}

.ql-toolbar.ql-snow .ql-stroke {
  stroke: #667085 !important;
}

.ql-toolbar.ql-snow .ql-fill {
  fill: #667085 !important;
}

.ql-toolbar.ql-snow .ql-picker-label {
  color: #667085 !important;
}

.ql-toolbar.ql-snow button:hover,
.ql-toolbar.ql-snow button.ql-active,
.ql-toolbar.ql-snow .ql-picker-label:hover,
.ql-toolbar.ql-snow .ql-picker-item:hover,
.ql-toolbar.ql-snow .ql-picker-item.ql-selected {
  color: #2F6FEA !important;
}

.ql-toolbar.ql-snow button:hover .ql-stroke,
.ql-toolbar.ql-snow button.ql-active .ql-stroke,
.ql-toolbar.ql-snow .ql-picker-label:hover .ql-stroke,
.ql-toolbar.ql-snow .ql-picker-item:hover .ql-stroke,
.ql-toolbar.ql-snow .ql-picker-item.ql-selected .ql-stroke {
  stroke: #2F6FEA !important;
}

.ql-toolbar.ql-snow button:hover .ql-fill,
.ql-toolbar.ql-snow button.ql-active .ql-fill,
.ql-toolbar.ql-snow .ql-picker-label:hover .ql-fill,
.ql-toolbar.ql-snow .ql-picker-item:hover .ql-fill,
.ql-toolbar.ql-snow .ql-picker-item.ql-selected .ql-fill {
  fill: #2F6FEA !important;
}

.ql-container.ql-snow {
  border-bottom-left-radius: 10px !important;
  border-bottom-right-radius: 10px !important;
  border: 1px solid #ccc !important;
  border-top: none !important;
  margin: 0 !important;
}

.ql-editor {
  min-height: 180px;
  padding: 12px;
  font-size: 13px;
  line-height: 1.6;
}

.ql-editor.ql-blank::before {
  color: #aaa;
  font-style: italic;
}

.ql-editor h2 {
  font-size: 20px;
  font-weight: 700;
  margin: 12px 0 8px 0;
}

.ql-editor h3 {
  font-size: 17px;
  font-weight: 700;
  margin: 10px 0 6px 0;
}

.ql-editor ul, .ql-editor ol {
  margin: 8px 0;
  padding-left: 24px;
}

.ql-editor li {
  margin: 4px 0;
}

.ql-editor blockquote {
  border-left: 4px solid #ccc;
  margin: 8px 0;
  padding-left: 12px;
  color: #667085;
}

/* =========================================================================
   PRINT STYLES
   ========================================================================= */

/**
 * Print-specific styles for landscape A4 printing
 * Optimized for fitting 5-week rota on a single page
 */
@media print {
  /* Hide all UI chrome - only show the rota table and print header */
  .titlebar, 
  .rightbits, 
  select, 
  button, 
  .modal-backdrop, 
  .badge, 
  .subtitle,
  .nav-arrows,
  #printBtn,
  #noticeBell,
  #loginBadge,
  #adminBadge,
  #periodSelect,
  .scroll-btn { 
    display: none !important; 
  }
  
  /* Show week separators in print */
  .week-sep {
    display: table-cell !important;
    background: #bbb !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    border-left: 2pt solid #333 !important;
    border-right: 2pt solid #333 !important;
    width: 2pt !important;
    min-width: 2pt !important;
    padding: 0 !important;
  }
  
  /* Page setup for landscape A4 */
  @page { 
    size: landscape; 
    margin: 2mm; 
  }
  
  /* Reset body and container */
  body { 
    margin: 0; 
    padding: 0; 
    background: #fff; 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  
  .wrap { 
    width: 100%; 
    max-width: none; 
    margin: 0; 
    padding: 0; 
    box-shadow: none; 
    border-radius: 0;
    background: #fff;
    overflow: visible;
  }
  
  /* Show the rota table without scroll container constraints */
  .rota-scroll { 
    overflow: visible !important; 
    max-height: none !important; 
    height: auto !important; 
    width: 100%;
  }
  
  /* Rota table formatting */
  #rota { 
    width: 100%; 
    font-size: 5.5pt; 
    page-break-inside: avoid;
    border-collapse: collapse;
    table-layout: auto;
    max-width: 100%;
  }
  
  /* Header cells - remove sticky positioning for print */
  #rota thead th { 
    position: static !important; 
    background: #e8e8e8 !important; 
    -webkit-print-color-adjust: exact; 
    print-color-adjust: exact;
    font-size: 5.5pt;
    padding: 2px 1px;
    font-weight: 700;
    border: 0.5pt solid #666 !important;
    line-height: 1.2;
  }
  
  /* All borders */
  #rota, 
  #rota th, 
  #rota td { 
    border: 0.5pt solid #666 !important; 
    -webkit-print-color-adjust: exact; 
    print-color-adjust: exact; 
  }
  
  /* Section headers - preserve role colors */
  .section-row td { 
    font-size: 5.5pt;
    font-weight: 800;
    padding: 2px 3px;
    line-height: 1.2;
  }
  
  .section-cn { 
    background: #E3F2FD !important; 
    -webkit-print-color-adjust: exact; 
    print-color-adjust: exact;
  }
  
  .section-sn { 
    background: #F3E5F5 !important; 
    -webkit-print-color-adjust: exact; 
    print-color-adjust: exact;
  }
  
  .section-na { 
    background: #FFF3E0 !important; 
    -webkit-print-color-adjust: exact; 
    print-color-adjust: exact;
  }
  
  /* Cell content */
  .cell { 
    min-height: 11px; 
    font-size: 5.5pt;
    padding: 2px 1px;
    text-align: center;
    line-height: 1.1;
  }
  
  /* Name column */
  #rota tbody th {
    font-size: 5.5pt;
    padding: 2px 4px;
    text-align: left;
    font-weight: 600;
    white-space: normal;
    line-height: 1.2;
    min-width: 85px;
  }
  
  .name-col {
    font-size: 5.5pt;
    white-space: normal;
    min-width: 85px;
  }
  
  /* Week labels */
  .week-label {
    font-size: 5pt;
    font-weight: 700;
    line-height: 1.2;
  }
  
  /* Day column headers */
  .day-header {
    font-size: 5pt;
    font-weight: 700;
    line-height: 1.2;
  }
  
  /* Print header that gets injected by JavaScript */
  .print-header { 
    display: block !important; 
    margin: 0 0 2mm 0; 
    padding: 0 0 1mm 0; 
    border-bottom: 0.75pt solid #333; 
  }
  
  .print-header h1 { 
    font-size: 10pt; 
    margin: 0 0 1mm 0; 
    font-weight: 700;
    color: #000;
    line-height: 1.1;
  }
  
  .print-header .print-meta { 
    font-size: 6.5pt; 
    color: #555; 
    -webkit-print-color-adjust: exact; 
    print-color-adjust: exact;
    line-height: 1.1;
  }
  
  /* Ensure proper spacing and no page breaks within table */
  tr { 
    page-break-inside: avoid; 
  }
  
  /* Compact table cells for better fit */
  #rota td {
    padding: 2px 1px;
  }
  
  /* Ensure table uses full page width */
  #rota {
    width: 100%;
    max-width: 100%;
  }
}

  </style>
</head>

<body>
  <div class="wrap">
    <div class="titlebar">
     <div style="display:flex; gap:12px; align-items:center;">
  <img
    src="logo.png"
    alt="Calpe Ward"
    style="height:44px; width:auto;"
  />

<div>
  <h1>Calpe Ward Requests</h1>

  <div class="header-subrow">
    <div class="subtitle" id="periodLabel"></div>
    <div class="subtitle" id="closeLabel"></div>
  </div>
</div>
</div>
<div class="rightbits">
  <select id="periodSelect"></select>

  <!-- üë§ Account badge -->
  <button class="badge account-badge" id="loginBadge" type="button">
    <span class="acc-ic">üë§</span>
    <span class="acc-txt">Not logged in</span>
  </button>

  <!-- üñ®Ô∏è Print/Export button (only for Sean Ells) -->
  <button class="badge" id="printBtn" type="button" title="Print & Export" style="display:none;">
    üñ®Ô∏è
  </button>

  <!-- üîî Bell is its own button -->
  <button class="badge" id="noticeBell" type="button" title="Notices">
    üîî <span id="noticeBellDot" style="display:none;">‚Ä¢</span>
  </button>

  <div class="badge admin" id="adminBadge" style="display:none;">ADMIN</div>
</div>
    </div>

   <div id="rotaScroll" class="rota-scroll">
  <table id="rota"></table>
</div>
  </div>

  <!-- =========================
       PIN MODAL (login)
       ========================= -->
  <div class="modal-backdrop" id="pinModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pinTitle">
      <h2 id="pinTitle">Enter PIN</h2>
      <p id="pinDesc">Enter your 4-digit PIN to unlock editing.</p>

      <div class="row">
        <input class="pin" id="pinInput" inputmode="numeric" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <div class="btns">
          <button id="pinCancel" type="button">Cancel</button>
          <button class="primary" id="pinConfirm" type="button">Unlock</button>
        </div>
      </div>

      <div class="err" id="pinErr">Wrong PIN.</div>
    </div>
  </div>

  <!-- =========================
       SHIFT PICKER MODAL (Patch 2)
       ========================= -->
  <div class="modal-backdrop" id="shiftModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="shiftTitle">
      
<div class="shift-titlebar">
  <h2 id="shiftTitle">Select shift</h2>

  <div style="display:flex; gap:8px; align-items:center;">
    <button
      id="shiftLockBtn"
      type="button"
      class="badge help-badge"
      aria-label="Lock"
      title="Lock this cell"
      style="display:none;"
    >
      üîí
    </button>

    <button
      id="shiftHelpBtn"
      type="button"
      class="badge help-badge"
      aria-label="Help"
      title="Shift request guidelines"
    >
      ?
    </button>
  </div>
</div>



      <p id="shiftDesc">
  Choose a <strong>preference</strong> for this day.
</p>


      <div class="shift-grid" id="shiftGridContainer">
        <button class="shift-btn" data-shift="LD" type="button">LD</button>
        <button class="shift-btn" data-shift="8-8" type="button">8‚Äì8</button>
        <button class="shift-btn" data-shift="N" type="button">N</button>
        <button class="shift-btn" data-shift="W" type="button">W</button>
        <button class="shift-btn" data-shift="O" type="button">O</button>
        <button class="shift-btn off" data-shift="O*" type="button">O*</button>
        <button class="shift-btn admin-only" id="shiftBtnL" data-shift="L" type="button" style="display:none; background:#e3f2fd; border-color:#90caf9;">L</button>
        <button class="shift-btn" data-shift="CLEAR" type="button">Clear</button>
      </div>

      <div class="btns">
        <button id="shiftCancel" type="button">Cancel</button>
      </div>
    </div>
  </div>
 <!-- =========================
      COMMENTS 
       ========================= -->
  
  <div class="modal-backdrop" id="weekCommentModal" aria-hidden="true" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="weekCommentTitle">
    <h2 id="weekCommentTitle">Week comments</h2>

    <div id="weekCommentAdminList"
         style="display:none; max-height:260px; overflow:auto; border:1px solid #ddd; border-radius:8px; padding:8px; margin-bottom:10px;">
    </div>

<label id="weekCommentYourLabel" style="display:block; font-weight:600; margin:8px 0 6px;">Your comment</label>
    <textarea id="weekCommentInput" rows="4" style="width:100%;"></textarea>

    <div class="btns" style="margin-top:10px;">
      <button id="weekCommentCancel" type="button">Close</button>
      <button id="weekCommentSave" class="primary" type="button">Save</button>
    </div>
  </div>
</div>

  <!-- =========================
     ADMIN PANEL (v1)
     ========================= -->
<div class="modal-backdrop" id="adminModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
    <h2 id="adminTitle">Admin Console</h2>
    <p class="subtitle">Manage rota periods and generate new weeks.</p>

<div class="admin-tabs">
  <button id="adminTabPeriods"  class="admin-tab is-active">Rota periods</button>
  <button id="adminTabGenerate" class="admin-tab">Generate</button>
  <button id="adminTabUsers"    class="admin-tab">Users</button>
  <button id="adminTabNotices"  class="admin-tab">Notices</button>
  <button class="admin-tab" onclick="goToFullAdmin()" style="cursor:pointer;">Full Admin</button>
</div>


 <!-- TAB: PERIODS -->
<div id="adminViewPeriods">

  <!-- Period picker -->
  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
    <div style="font-weight:800;">Rota period</div>
    <select id="adminPeriodSelect" style="padding:8px 10px; border-radius:999px; border:1px solid #ccc; font-size:12px; min-width:220px;"></select>
    <div class="subtitle" id="adminPeriodMeta"></div>
  </div>

  <!-- Requests close time -->
  <div style="border:1px solid #ddd; border-radius:10px; padding:10px; margin-bottom:10px;">
    <div style="font-weight:800; margin-bottom:6px;">Requests closing time</div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <input id="adminClosesAtInput" type="datetime-local"
        style="padding:8px 10px; border-radius:10px; border:1px solid #ccc; font-size:12px;" />

      <button id="adminClosesAtSaveBtn" type="button"
        style="min-width:auto; padding:8px 10px; border-radius:999px; font-size:12px;">
        Save close time
      </button>

      <button id="adminClosesAtClearBtn" type="button"
        style="min-width:auto; padding:8px 10px; border-radius:999px; font-size:12px;">
        Clear
      </button>
    </div>

    <div class="subtitle" id="adminClosesAtHelp" style="margin-top:8px;">
      Set when requests will lock for this whole 5-week period.
    </div>
  </div>

  <!-- Period controls -->
  <div style="border:1px solid #ddd; border-radius:10px; padding:10px; margin-bottom:10px;">
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button id="adminSetActiveBtn" type="button" style="min-width:auto; padding:8px 10px; border-radius:999px; font-size:12px;">Set active</button>
      <button id="adminToggleHiddenBtn" type="button" style="min-width:auto; padding:8px 10px; border-radius:999px; font-size:12px;">Toggle hidden</button>
    </div>
  </div>

  <!-- Weeks list -->
  <div style="border:1px solid #ddd; border-radius:10px; padding:10px;">
    <div style="font-weight:800; margin-bottom:6px;">Weeks</div>
    <div id="adminWeeksList" class="subtitle">Pick a period‚Ä¶</div>
  </div>

</div>

    <!-- TAB: GENERATE -->
    <div id="adminViewGenerate" style="display:none;">
      <div style="border:1px solid #ddd; border-radius:10px; padding:10px;">
        <div style="font-weight:700; margin-bottom:6px;">Generate next 5-week period</div>
        <div class="subtitle" id="adminGeneratePreview">Preview will appear here.</div>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button id="adminGenerateBtn" class="primary" type="button">Generate</button>
        </div>
      </div>
    </div>
<!-- =========================
     TAB: USERS
     ========================= -->
<div id="adminViewUsers" style="display:none;">

  <div style="border:1px solid #ddd; border-radius:10px; padding:10px; margin-bottom:10px;">
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
      <div style="font-weight:800;">Users</div>

      <label class="subtitle" style="display:flex; gap:6px; align-items:center;">
        <input type="checkbox" id="adminShowInactiveUsers" />
        Show inactive
      </label>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
      <input id="adminUserSearch" placeholder="Search name‚Ä¶"
        style="flex:1; min-width:180px; padding:8px 10px; border-radius:10px; border:1px solid #ccc; font-size:12px;" />

      <button id="adminAddUserBtn" class="primary" type="button"
        style="min-width:auto; padding:8px 12px; border-radius:999px; font-size:12px;">
        + Add user
      </button>
    </div>

    <div id="adminUsersList" style="margin-top:10px;"></div>
  </div>

  <div id="adminUserEditSection" style="border:1px solid #ddd; border-radius:10px; padding:10px;">
    <div style="font-weight:800; margin-bottom:6px;">Add / Edit</div>

    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <input id="adminEditUserName" placeholder="Name"
        style="flex:1; min-width:180px; padding:8px 10px; border-radius:10px; border:1px solid #ccc; font-size:12px;" />

      <select id="adminEditUserRole"
        style="min-width:160px; padding:8px 10px; border-radius:10px; border:1px solid #ccc; font-size:12px;">
        <option value="1">Charge Nurse</option>
        <option value="2">Staff Nurse</option>
        <option value="3">Nursing Assistant</option>
      </select>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
      <input id="adminEditUserPin" placeholder="New PIN (4 digits)" inputmode="numeric" maxlength="4"
        style="flex:1; min-width:180px; padding:8px 10px; border-radius:10px; border:1px solid #ccc; font-size:12px;" />

      <button id="adminSaveUserBtn" class="primary" type="button"
        style="min-width:auto; padding:8px 12px; border-radius:999px; font-size:12px;">
        Save
      </button>

      <button id="adminCancelUserEditBtn" type="button"
        style="min-width:auto; padding:8px 12px; border-radius:999px; font-size:12px;">
        Cancel
      </button>
    </div>

    <div class="subtitle" id="adminUserEditHelp" style="margin-top:8px;"></div>
  </div>

</div>

<!-- =========================
     TAB: NOTICES
     ========================= -->
<div id="adminViewNotices" style="display:none;">

  <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px;">
    <div style="font-weight:800;">Notices</div>

    <button
      id="adminAddNoticeBtn"
      class="primary"
      type="button"
      style="min-width:auto; padding:8px 12px; border-radius:999px; font-size:12px;"
    >
      + New notice
    </button>
  </div>

  <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
    <input
      id="adminNoticeSearch"
      placeholder="Search title‚Ä¶"
      style="flex:1; min-width:180px; padding:8px 10px; border-radius:10px; border:1px solid #ccc; font-size:12px;"
    />

    <label class="subtitle" style="display:flex; gap:6px; align-items:center;">
      <input type="checkbox" id="adminShowInactiveNotices" />
      Show inactive
    </label>
  </div>

  <div
    id="adminNoticesList"
    style="border:1px solid #ddd; border-radius:10px; overflow:hidden;">
    <!-- notices injected here -->
  </div>

</div>

    <div class="btns" style="margin-top:12px;">
      <button id="adminClose" type="button">Close</button>
    </div>
  </div>
</div>

<!-- =========================
     NOTICES (Blocking + History)
     ========================= -->

<!-- Blocking unread notices modal -->
<div class="modal-backdrop" id="noticeUnreadModal" aria-hidden="true" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="noticeUnreadTitle">
    <h2 id="noticeUnreadTitle">Notices</h2>
    <p class="subtitle" id="noticeUnreadSub">Please acknowledge all notices to continue.</p>

    <div id="noticeUnreadList" style="margin-top:10px;"></div>

    <div class="btns" style="margin-top:12px;">
      <button id="noticeUnreadAcknowledge" class="primary" type="button">Acknowledge & continue</button>
    </div>
  </div>
</div>

<!-- Non-blocking all notices modal (bell icon) -->
<div class="modal-backdrop" id="noticeAllModal" aria-hidden="true" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="noticeAllTitle">
    <h2 id="noticeAllTitle">All notices</h2>
    <p class="subtitle">You can re-read notices any time.</p>

    <div id="noticeAllList" style="margin-top:10px;"></div>

    <div class="btns" style="margin-top:12px;">
      <button id="noticeAllClose" type="button">Close</button>
    </div>
  </div>
</div>

<!-- =========================
     ADMIN NOTICE EDITOR
     ========================= -->
<div class="modal-backdrop" id="adminNoticeModal" aria-hidden="true" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true">
    <h2 id="adminNoticeTitle">New notice</h2>
    <p class="subtitle">Editing this notice will require staff to acknowledge it again.</p>

    <div class="card" style="padding:10px; margin-top:10px;">
      <div style="font-weight:800; margin-bottom:6px;">Title</div>
      <input id="adminNoticeTitleInput"
             style="width:100%; padding:8px 10px; border-radius:10px; border:1px solid #ccc;" />
    </div>

    <div class="card" style="padding:10px; margin-top:10px;">
      <div style="font-weight:800; margin-bottom:6px;">Body (English)</div>
      <div id="adminNoticeBodyEn" style="background:white; border-radius:10px; border:1px solid #ccc; min-height:200px;"></div>
    </div>

    <div class="card" style="padding:10px; margin-top:10px;">
      <div style="font-weight:800; margin-bottom:6px;">Body (Spanish ‚Äì optional)</div>
      <div id="adminNoticeBodyEs" style="background:white; border-radius:10px; border:1px solid #ccc; min-height:200px;"></div>
    </div>

    <div class="card" style="padding:10px; margin-top:10px;">
      <div style="font-weight:800; margin-bottom:6px;">Target audience</div>

      <label><input type="checkbox" id="noticeTargetAll" /> All users</label><br>
      <label><input type="checkbox" value="1" class="noticeRoleChk" /> Charge Nurses</label><br>
      <label><input type="checkbox" value="2" class="noticeRoleChk" /> Staff Nurses</label><br>
      <label><input type="checkbox" value="3" class="noticeRoleChk" /> Nursing Assistants</label>
    </div>

    <div class="btns" style="margin-top:12px;">
      <button id="adminNoticeCancel" type="button">Cancel</button>
      <button id="adminNoticeSave" class="primary" type="button">Save notice</button>
    </div>
  </div>
</div>


<!-- =========================
     SHIFT RULES / HELP MODAL
     ========================= -->
<div class="modal-backdrop" id="shiftHelpModal" aria-hidden="true" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="shiftHelpTitle">

    <div style="margin-bottom:10px;">
      <h2 id="shiftHelpTitle" style="margin:0 0 4px 0;">Shift request guidelines</h2>
      <p class="subtitle" id="shiftHelpSubtitle" style="margin:0;">
        How preferences are considered
      </p>
    </div>

    <!-- EN -->
    <div id="shiftHelpContentEn" class="card" style="padding:12px;">
      <div style="font-weight:900; margin-bottom:8px;">Shift request guidelines</div>

      <ul style="margin:0; padding-left:18px; line-height:1.45; font-size:13px; color:#334155;">
        <li>You can enter <strong>up to 5</strong> request entries per week (you do not need to use all of these).</li>

        <li>
          <strong>O*</strong> is a <strong>strong preference</strong> and is prioritised as
          <strong>O¬π first</strong> and then <strong>O¬≤</strong>.
        </li>

        <li>
          You can only have <strong>two strong preferences</strong>
          (<strong>O¬π</strong> and <strong>O¬≤</strong>) per week.
        </li>

        <li>
          <strong>Only O¬π is guaranteed</strong> at ward level.
        </li>

        <li>
          All other requests are <strong>preferences only</strong>. They are considered at ward level
          but are <strong>not guaranteed</strong>.
          <br>
          <strong>Choosing between days and nights (LD / 8‚Äì8 / N)</strong> is also a preference only.
          Night shifts, in particular, are more difficult to allocate and cannot always be accommodated.
        </li>

        <li>
          <strong>Use comments</strong> to explain your preferences more clearly
          (for example: context, patterns, flexibility). This helps us understand
          your requests and accommodate them where possible.
        </li>

        <li>
          Guidelines may change, and <strong>all preferences may be overridden by management</strong>
          when shifts are published.
        </li>
      </ul>

      <div style="margin-top:12px; font-weight:900;">Shift key (preferences)</div>
      <ul style="margin:6px 0 0; padding-left:18px; line-height:1.45; font-size:13px; color:#334155;">
        <li><strong>LD</strong> ‚Äì Long Day (08:00‚Äì20:30)</li>
        <li><strong>8‚Äì8</strong> ‚Äì Day shift (08:00‚Äì20:00)</li>
        <li><strong>W</strong> ‚Äì Happy to work days or nights</li>
        <li><strong>N</strong> ‚Äì Preference to work nights</li>
      </ul>
    </div>

    <!-- ES -->
    <div id="shiftHelpContentEs" class="card" style="padding:12px; display:none;">
      <div style="font-weight:900; margin-bottom:8px;">Gu√≠a de solicitudes de turnos</div>

      <ul style="margin:0; padding-left:18px; line-height:1.45; font-size:13px; color:#334155;">
        <li>
          Puedes introducir <strong>hasta 5</strong> solicitudes por semana
          (no es necesario usarlas todas).
        </li>

        <li>
          <strong>O*</strong> es una <strong>preferencia fuerte</strong> y se prioriza como
          <strong>O¬π primero</strong> y despu√©s <strong>O¬≤</strong>.
        </li>

        <li>
          Solo puedes tener <strong>dos preferencias fuertes</strong>
          (<strong>O¬π</strong> y <strong>O¬≤</strong>) por semana.
        </li>

        <li>
          <strong>Solo O¬π est√° garantizado</strong> a nivel de la unidad.
        </li>

        <li>
          El resto de solicitudes son <strong>preferencias</strong>. Se tendr√°n en cuenta,
          pero <strong>no est√°n garantizadas</strong>.
          <br>
          <strong>Elegir entre turnos de d√≠a y noche (LD / 8‚Äì8 / N)</strong> tambi√©n es solo
          una preferencia. Los turnos de noche, en particular, son m√°s dif√≠ciles de asignar
          y no siempre pueden acomodarse.
        </li>

        <li>
          <strong>Usa los comentarios</strong> para explicar mejor tus preferencias
          (por ejemplo: contexto, patrones o flexibilidad). Esto nos ayuda a entender
          tus solicitudes y tenerlas en cuenta cuando sea posible.
        </li>

        <li>
          Las gu√≠as pueden cambiar y <strong>todas las preferencias pueden ser modificadas
          por la direcci√≥n</strong> cuando se publiquen los turnos.
        </li>
      </ul>

      <div style="margin-top:12px; font-weight:900;">Leyenda (preferencias)</div>
      <ul style="margin:6px 0 0; padding-left:18px; line-height:1.45; font-size:13px; color:#334155;">
        <li><strong>LD</strong> ‚Äì Turno largo (08:00‚Äì20:30)</li>
        <li><strong>8‚Äì8</strong> ‚Äì Turno de d√≠a (08:00‚Äì20:00)</li>
        <li><strong>W</strong> ‚Äì Disponible para d√≠as o noches</li>
        <li><strong>N</strong> ‚Äì Preferencia por noches</li>
      </ul>
    </div>

    <div class="user-footer" style="margin-top:12px;">
      <button id="shiftHelpClose" type="button">Close</button>
      <button id="shiftHelpClose2" class="primary" type="button">OK</button>
    </div>

  </div>
</div>


   <!-- =========================
     USER MENU MODAL (Account)
     ========================= -->
  <div class="modal-backdrop" id="userModal" aria-hidden="true" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="userTitle">

      <!-- HEADER: title left, language right -->
      <div class="user-head">
        <div class="user-head-left">
          <h2 id="userTitle">Edit your account</h2>
          <p class="subtitle" id="userMeta">‚Äî</p>
        </div>

        <div class="user-flags" aria-label="Language">
          <div class="flags-label">Language</div>
          <div class="flags-buttons">
<button id="userLangEn" type="button" class="flag-btn" title="English" aria-label="English">
  <img class="flag-img" src="icons/gb.svg" alt="">
</button>
<button id="userLangEs" type="button" class="flag-btn" title="Espa√±ol" aria-label="Espa√±ol">
  <img class="flag-img" src="icons/es.svg" alt="">
</button>
          </div>
        </div>
      </div>

      <!-- CHANGE PIN CARD -->
     <div class="card" style="padding:10px; margin:10px 0;">
        <div style="font-weight:800; margin-bottom:6px;">Change PIN</div>

        <div class="row" style="gap:8px;">
          <input id="userOldPin" class="user-pin" inputmode="numeric" maxlength="4" placeholder="Current PIN" />
          <input id="userNewPin" class="user-pin" inputmode="numeric" maxlength="4" placeholder="New PIN" />
          <input id="userNewPin2" class="user-pin" inputmode="numeric" maxlength="4" placeholder="Repeat new PIN" />
        </div>

        <div class="btns" style="margin-top:10px; justify-content:flex-end;">
          <button id="userSavePin" class="primary" type="button">Save new PIN</button>
        </div>

        <div class="err" id="userPinErr">Error.</div>
        <div class="subtitle" id="userPinOk" style="display:none; margin-top:8px; color:#0b6b2b; font-weight:700;">
          PIN updated.
        </div>
      </div>

      <!-- BOTTOM BUTTONS -->
      <div class="user-footer">
        <button id="userLogout" type="button">Log out</button>
        <button id="userClose" type="button">Close</button>
      </div>

    </div>
  </div>


  <!-- =========================
       PRINT & EXPORT MODAL
       ========================= -->
  <div class="modal-backdrop" id="printModal" aria-hidden="true" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="printTitle">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 id="printTitle" style="margin:0;">Print & Export</h2>
        <button id="printCloseX" type="button" style="background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
      </div>
      <p class="subtitle">Generate printouts and reports</p>

      <!-- STAFF OPTIONS -->
      <div id="printStaffOptions" style="display:none;">
        <div class="card" style="padding:12px; margin-top:12px;">
          <div style="font-weight:800; margin-bottom:8px;">Print options</div>
          
          <button id="printAllRequests" class="primary" type="button" style="width:100%; margin-bottom:8px;">
            Print all requests
          </button>
          
          <div style="font-weight:600; margin:12px 0 6px;">Print by group:</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="printGroupCN" type="button" style="flex:1;">Charge Nurses</button>
            <button id="printGroupSN" type="button" style="flex:1;">Staff Nurses</button>
            <button id="printGroupNA" type="button" style="flex:1;">Nursing Assistants</button>
          </div>
          
          <button id="printOwnRow" type="button" style="width:100%; margin-top:8px;">
            Print my requests only
          </button>
        </div>
      </div>

      <!-- ADMIN OPTIONS -->
      <div id="printAdminOptions" style="display:none;">
        <div class="card" style="padding:12px; margin-top:12px;">
          <div style="font-weight:800; margin-bottom:12px;">Admin: Advanced Print Configuration</div>
          <p style="font-size:13px; color:#666; margin:0 0 12px;">Click below to open the advanced admin print dialog where you can select roles, users, and configure what to print (requests, comments, or both).</p>
          
          <button type="button" onclick="openAdminPrintConfig()" style="width:100%; padding:12px; background:#1976d2; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600; font-size:14px;">
            Open Advanced Print Configuration
          </button>
          
          <button id="exportExcel" class="primary" type="button" style="width:100%; margin-top:12px;">
            Export all to Excel (CSV)
          </button>
        </div>
      </div>

      <div class="btns" style="margin-top:12px;">
        <button id="printClose" type="button">Close</button>
      </div>
    </div>
  </div>


  <script>
    /* =========================================================
       1) CONFIG
       ========================================================= */
    const SUPABASE_URL = "https://tbclufdtyefexwwitfsz.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiY2x1ZmR0eWVmZXh3d2l0ZnN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwODA4ODksImV4cCI6MjA4MjY1Njg4OX0.OYnj44QQCTD-5tqR2XSVt4oQso9Ol8ZLH2tLsRGIreA";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    const STORAGE_KEY = "calpeward.loggedInUserId";
    const MAX_REQUESTS_PER_WEEK = 5;

    /* =========================================================
       2) HELPERS (dates, formatting)
       ========================================================= */
    const fmt = (d) => d.toLocaleDateString("en-GB", { day: "numeric", month: "short" });

    // =========================
// i18n (single source of truth)
// =========================
const I18N = {
  en: {
    // Generic
    close: "Close",
    cancel: "Cancel",
    ok: "OK",
    save: "Save",
    loadingUsers: "Loading users‚Ä¶",
    failedLoadUsers: "Failed to load users.",
    notLoggedIn: "Not logged in",
    loginFirst: "Log in first to add comments.",

    // PIN modal
    pinTitle: (name) => `PIN for ${name}`,
    pinDesc: "Enter your 4-digit PIN to unlock editing.",
    pinErrWrong: "Wrong PIN.",
    pinErrFormat: "PIN must be 4 digits.",
    unlock: "Unlock",

    // Shift modal
    shiftTitle: "Select shift",
    shiftDesc: "Choose a preference for this day.",
    shiftHelpTitle: "Shift request guidelines",
    shiftHelpSub: "How preferences are considered",

    // User modal
    accountEditTitle: "Edit your account",
    changePin: "Change PIN",
    currentPin: "Current PIN",
    newPin: "New PIN",
    repeatNewPin: "Repeat new PIN",
    saveNewPin: "Save new PIN",
    logout: "Log out",
    language: "Language",
    pinUpdated: "PIN updated.",

    // Requests close pill
    reqOpen: "Requests are open",
    reqCloseSoon: "Requests close soon",
    reqClose: "Requests close",
    reqClosed: "Requests closed",
    closedAt: (dt) => `Closed at ${dt}`,
    left: (t) => `${t} left`,

// Week comments
weekCommentsTitle: "Week comments",
yourCommentLabel: "Your comment",
noCommentsYet: "No comments yet.",
saveComment: "Save",
closeComment: "Close",
failedLoadWeekComments: "Failed to load week comments. Check console.",
failedSaveWeekComment: "Failed to save comment. Check console.",

    
  },

  es: {
    close: "Cerrar",
    cancel: "Cancelar",
    ok: "Vale",
    save: "Guardar",
    loadingUsers: "Cargando usuarios‚Ä¶",
    failedLoadUsers: "No se pudieron cargar los usuarios.",
    notLoggedIn: "Sin sesi√≥n",
    loginFirst: "Inicia sesi√≥n para a√±adir comentarios.",

    pinTitle: (name) => `PIN de ${name}`,
    pinDesc: "Introduce tu PIN de 4 d√≠gitos para desbloquear la edici√≥n.",
    pinErrWrong: "PIN incorrecto.",
    pinErrFormat: "El PIN debe tener 4 d√≠gitos.",
    unlock: "Desbloquear",

    shiftTitle: "Selecciona turno",
    shiftDesc: "Elige una preferencia para este d√≠a.",
    shiftHelpTitle: "Gu√≠a de solicitudes de turnos",
    shiftHelpSub: "C√≥mo se consideran las preferencias",

    accountEditTitle: "Editar tu cuenta",
    changePin: "Cambiar PIN",
    currentPin: "PIN actual",
    newPin: "Nuevo PIN",
    repeatNewPin: "Repite el nuevo PIN",
    saveNewPin: "Guardar nuevo PIN",
    logout: "Cerrar sesi√≥n",
    language: "Idioma",
    pinUpdated: "PIN actualizado.",

    reqOpen: "Solicitudes abiertas",
    reqCloseSoon: "Cierre pronto",
    reqClose: "Cierre de solicitudes",
    reqClosed: "Solicitudes cerradas",
    closedAt: (dt) => `Cerrado el ${dt}`,
    left: (t) => `Quedan ${t}`,

    // Week comments
weekCommentsTitle: "Comentarios de la semana",
yourCommentLabel: "Tu comentario",
noCommentsYet: "A√∫n no hay comentarios.",
saveComment: "Guardar",
closeComment: "Cerrar",
failedLoadWeekComments: "No se pudieron cargar los comentarios. Revisa la consola.",
failedSaveWeekComment: "No se pudo guardar el comentario. Revisa la consola.",

  }
};

let currentLang = "en";

function t(key, ...args){
  const pack = I18N[currentLang] || I18N.en;
  const val = pack[key] ?? I18N.en[key] ?? key;
  return (typeof val === "function") ? val(...args) : val;
}

// Use this anywhere you want to switch language
function setLang(lang){
  currentLang = (lang === "es") ? "es" : "en";
  applyLanguage();
}
function isOpenBackdrop(el){
  if (!el) return false;
  return el.getAttribute("aria-hidden") === "false";
}

function updateBodyModalOpen(){
  const anyOpen =
    isOpenBackdrop(shiftModal) ||
    isOpenBackdrop(modal) ||
    isOpenBackdrop(weekCommentModal) ||
    isOpenBackdrop(adminModal) ||
    isOpenBackdrop(userModal) ||
    isOpenBackdrop(shiftHelpModal) ||
    isOpenBackdrop(noticeUnreadModal) ||
    isOpenBackdrop(noticeAllModal);

  document.body.classList.toggle("modal-open", anyOpen);
}



   function isoDate(d){
  const x = new Date(d);
  x.setHours(12,0,0,0); // pin to midday to avoid timezone rollover
  const y = x.getFullYear();
  const m = String(x.getMonth()+1).padStart(2,"0");
  const da = String(x.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
    
function effectiveOpenForWeek(w){
  if (!activePeriodObj) return !!w.open; // fallback
  return isPeriodClosed(activePeriodObj)
    ? !!w.openAfterClose
    : !!w.open;
}

function applyLanguage(){
  // PIN modal
  const pinConfirm = document.getElementById("pinConfirm");
  const pinCancel  = document.getElementById("pinCancel");
  if (pinConfirm) pinConfirm.textContent = t("unlock");
  if (pinCancel)  pinCancel.textContent  = t("cancel");

  // Shift modal
  const shiftTitle = document.getElementById("shiftTitle");
  const shiftDesc  = document.getElementById("shiftDesc");
  const shiftCancel = document.getElementById("shiftCancel");
  if (shiftTitle) shiftTitle.textContent = t("shiftTitle");
if (shiftDesc) shiftDesc.innerHTML =
  currentLang === "en"
    ? 'Choose a <strong>preference</strong> for this day.'
    : 'Elige una <strong>preferencia</strong> para este d√≠a.';

  // ^ if you want markup, handle it intentionally like this, or just use textContent.

  if (shiftCancel) shiftCancel.textContent = t("cancel");

  // Shift help modal buttons (you already have setShiftHelpLanguage, you can keep it or unify it)
  if (shiftHelpClose)  shiftHelpClose.textContent  = t("close");
  if (shiftHelpClose2) shiftHelpClose2.textContent = t("ok");

  // User modal
  const userTitle = document.getElementById("userTitle");
  const savePinBtn = document.getElementById("userSavePin");
  const logoutBtn = document.getElementById("userLogout");
  const userClose = document.getElementById("userClose");
  const flagsLabel = document.querySelector("#userModal .flags-label");
  if (userTitle) userTitle.textContent = t("accountEditTitle");
  if (savePinBtn) savePinBtn.textContent = t("saveNewPin");
  if (logoutBtn) logoutBtn.textContent = t("logout");
  if (userClose) userClose.textContent = t("close");
  if (flagsLabel) flagsLabel.textContent = t("language");

    // Week comment modal
  const weekTitle = document.getElementById("weekCommentTitle");
  if (weekTitle) weekTitle.textContent = t("weekCommentsTitle");

  if (weekCommentYourLabel) weekCommentYourLabel.textContent = t("yourCommentLabel");
  if (weekCommentCancel) weekCommentCancel.textContent = t("closeComment");
  if (weekCommentSave) weekCommentSave.textContent = t("saveComment");


  // Placeholders
  if (userOldPin) userOldPin.placeholder = t("currentPin");
  if (userNewPin) userNewPin.placeholder = t("newPin");
  if (userNewPin2) userNewPin2.placeholder = t("repeatNewPin");
}

function escapeHtml(s){
  return String(s)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

    function startOfWeekSunday(dateObj){
      const d = new Date(dateObj);
      const day = d.getDay();
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() - day);
      return d;
    }
    function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
    function daysInWeek(weekStartDate){ return Array.from({length:7}, (_,i) => addDays(new Date(weekStartDate), i)); }

function groupDatesIntoWeeks(dates){
  const map = new Map();

  for (const item of dates){
    const d = new Date(item.date);
    const ws = startOfWeekSunday(d);
    const key = isoDate(ws);

    const rowWeekId = item.week_id ?? item.rota_weeks?.id ?? null;

    // Interpret flags ONLY if rota_weeks exists; otherwise don't "invent" openness
    const rowOpen = (item.rota_weeks?.open);
    const rowOpenAfterClose = (item.rota_weeks?.open_after_close);

    if (!map.has(key)) {
      map.set(key, {
        weekStart: ws,
        days: [],
        weekId: rowWeekId,

        // Start with "unknown" until we see real flags
        open: null,
        openAfterClose: null
      });
    }

    const weekObj = map.get(key);

    // Capture weekId if we didn't have it yet
    if (!weekObj.weekId && rowWeekId) weekObj.weekId = rowWeekId;

    // Aggregate open flags (AND), but only when we have real values
    if (typeof rowOpen === "boolean") {
      weekObj.open = (weekObj.open === null) ? rowOpen : (weekObj.open && rowOpen);
    }
    if (typeof rowOpenAfterClose === "boolean") {
      weekObj.openAfterClose = (weekObj.openAfterClose === null)
        ? rowOpenAfterClose
        : (weekObj.openAfterClose && rowOpenAfterClose);
    }

    weekObj.days.push(item);
  }

  const weeks = [];

  for (const w of map.values()){
    const dayLookup = new Map(w.days.map(x => [x.date, x]));
    const ordered = [];

    for (let i = 0; i < 7; i++){
      const dd = addDays(w.weekStart, i);
      const ds = isoDate(dd);

      const row = dayLookup.get(ds) || {
        date: ds,
        week_id: w.weekId,
        rota_weeks: (w.weekId ? {
          id: w.weekId,
          open: w.open,
          open_after_close: w.openAfterClose
        } : null)
      };

      ordered.push(row);
    }

    // If still null (never saw rota_weeks), be conservative:
    // treat as CLOSED so editing/comments don't misbehave.
    const finalOpen = (w.open === null) ? false : w.open;
    const finalAfter = (w.openAfterClose === null) ? false : w.openAfterClose;

    weeks.push({
      weekStart: w.weekStart,
      weekEnd: addDays(w.weekStart, 6),
      weekId: w.weekId,
      open: finalOpen,
      openAfterClose: finalAfter,
      days: ordered
    });
  }

  weeks.sort((a,b) => a.weekStart - b.weekStart);
  return weeks;
}
    function groupUsers(users){
      const buckets = { charge_nurse: [], staff_nurse: [], nursing_assistant: [] };

      for(const u of users){
        const label =
          u.roles?.name ||
          (u.role_id === 1 ? "charge_nurse" :
           u.role_id === 2 ? "staff_nurse" :
           u.role_id === 3 ? "nursing_assistant" : "staff_nurse");

        (buckets[label] || buckets.staff_nurse).push(u);
      }

      return [
        { title: "Charge Nurses",      className: "section-cn", items: buckets.charge_nurse },
        { title: "Staff Nurses",       className: "section-sn", items: buckets.staff_nurse },
        { title: "Nursing Assistants", className: "section-na", items: buckets.nursing_assistant }
      ].filter(g => g.items.length > 0);
    }
function getWeekStart(dateStr){
  const d = new Date(dateStr);
  const day = d.getDay(); // 0 = Sunday
  d.setDate(d.getDate() - day);
  d.setHours(0,0,0,0);
  return isoDate(d);
}

function countUserRequestsThisWeek(userId, dateStr){
  const weekStart = getWeekStart(dateStr);
  let count = 0;

  for (const r of requestsCache.values()){
    if (r.user_id !== userId) continue;
    if (getWeekStart(r.date) === weekStart) count++;
  }

  return count;
}

function getSessionPinOrThrow(){
  if (!currentUser) throw new Error("Not logged in.");
  const pin = sessionStorage.getItem(pinKey(currentUser.id));
  if (!pin) throw new Error("Missing session PIN. Log in again.");
  return pin;
}
    
function nextOffPrioritySmart(currentRank, taken){
  // Cycle intent: null ‚Üí 1 ‚Üí 2 ‚Üí BLOCK
  let desired =
    (currentRank == null) ? 1 :
    (currentRank === 1) ? 2 :
    null;

  // If desired is taken, try the other one
  if (desired != null && taken.has(desired)) {
    if (!taken.has(1)) desired = 1;
    else if (!taken.has(2)) desired = 2;
    else desired = null; // both O1 and O2 used ‚Üí block
  }

  return desired;
}

function getTakenOffRanksThisWeek(userId, dateStr, excludeKey){
  const ws = getWeekStart(dateStr);
  const taken = new Set();

  // include saved rows
  for (const [k, r] of requestsCache.entries()){
    if (k === excludeKey) continue;
    if (r.user_id !== userId) continue;
    if (getWeekStart(r.date) !== ws) continue;
    if (r.value !== "O") continue;
 if (r.important_rank === 1 || r.important_rank === 2) {
  taken.add(r.important_rank);
}
  }

  // include pending edits
  for (const [k, pe] of Object.entries(pendingEdits)){
    if (k === excludeKey) continue;
    if (pe.userId !== userId) continue;
    if (getWeekStart(pe.date) !== ws) continue;
    if (pe.shift !== "O") continue;
    if (pe.important_rank === 1 || pe.important_rank === 2 || pe.important_rank === 3) {
      taken.add(pe.important_rank);
    }
  }

  return taken;
}
async function fetchWeekComments(weekId){
  const pin = getSessionPinOrThrow();

  const { data, error } = await supabaseClient.rpc("get_week_comments", {
    p_week_id: weekId,
    p_user_id: currentUser.id,
    p_pin: pin
  });

  if (error) throw error;
  return data || [];
}


async function upsertWeekComment(weekId, userId, comment){
  if (!currentUser) throw new Error("Not logged in.");

  const pin = sessionStorage.getItem(pinKey(currentUser.id));
  if (!pin) throw new Error("Missing session PIN. Log in again.");

  const { data, error } = await supabaseClient.rpc("upsert_week_comment", {
    p_week_id: weekId,
    p_user_id: userId,
    p_pin: pin,
    p_comment: comment ?? ""
  });

  if (error) throw error;

  // Depending on how your SQL function is written, data may be:
  // - the row object, OR
  // - an array with one row (common in PostgREST)
  return Array.isArray(data) ? data[0] : data;
}

async function resetWeeksFullyOpen(periodId){
  if (!currentUser?.is_admin) { alert("Admin only."); return; }

  const { data: wkRows, error: wkErr } = await supabaseClient
    .from("rota_dates")
    .select("week_id")
    .eq("period_id", periodId);

  if (wkErr) throw wkErr;

  const weekIds = [...new Set((wkRows || []).map(r => r.week_id).filter(Boolean))];
  if (!weekIds.length) return;

  const { error: resetErr } = await supabaseClient
    .from("rota_weeks")
    .update({ open: true, open_after_close: true })
    .in("id", weekIds);

  if (resetErr) throw resetErr;
}

async function resetWeeksFullyClosed(periodId){
  if (!currentUser?.is_admin) { alert("Admin only."); return; }

  const { data: wkRows, error: wkErr } = await supabaseClient
    .from("rota_dates")
    .select("week_id")
    .eq("period_id", periodId);

  if (wkErr) throw wkErr;

  const weekIds = [...new Set((wkRows || []).map(r => r.week_id).filter(Boolean))];
  if (!weekIds.length) return;

  const { error: resetErr } = await supabaseClient
    .from("rota_weeks")
    .update({ open: false, open_after_close: false })
    .in("id", weekIds);

  if (resetErr) throw resetErr;
}

    
  async function fetchRotaPeriods(){
  let q = supabaseClient
    .from("rota_periods")
    .select("id, name, start_date, end_date, is_hidden, is_active, closes_at")
    .order("start_date", { ascending: true });

  // Staff: show active + non-hidden. Admin: show all.
  if (!currentUser?.is_admin) {
    q = q.or("is_hidden.eq.false,is_active.eq.true");
  }

  const { data, error } = await q;
  if (error) throw error;
  return data || [];
}

function roleLabel(u){
  return u.roles?.name ||
    (u.role_id === 1 ? "charge_nurse" :
     u.role_id === 2 ? "staff_nurse" :
     u.role_id === 3 ? "nursing_assistant" : "staff_nurse");
}


function populatePeriodDropdown(periods){
  periodSelect.innerHTML = "";

  for (const p of periods){
    const opt = document.createElement("option");
    opt.value = p.id;

    const s = new Date(p.start_date);
    const e = new Date(p.end_date);

    const hiddenTag = (currentUser?.is_admin && p.is_hidden) ? " (hidden)" : "";
    const activeTag = p.is_active ? " ‚òÖ" : "";

    opt.textContent = `${fmt(s)} ‚Äì ${fmt(e)}${activeTag}${hiddenTag}`;
    periodSelect.appendChild(opt);
  }

  // ‚úÖ ensure dropdown always reflects activePeriodId
  if (activePeriodId != null) {
    periodSelect.value = String(activePeriodId);
  }
}

function getPeriodCloseDate(period){
  if (!period?.closes_at) return null;
  return new Date(period.closes_at);
}

function isPeriodClosed(period){
  const closeAt = getPeriodCloseDate(period);
  if (!closeAt) return false; // no deadline = open forever
  return new Date() >= closeAt;
}

    function isAdminWeekToggleAllowed(){
  return !!currentUser?.is_admin;
}
/* =========================================================
   3) STATE (who is logged in / what is unlocked)
   ========================================================= */
let currentUser = null;      // user object when logged in (by PIN)
let selectedUser = null;     // user you clicked before PIN entry
    let usersById = new Map();
    let allUsers = [];           // all users array (for print/export features)
let sessionPin = null; // store PIN in memory only (not localStorage)


    function pinKey(userId){ return `calpeward.pin.${userId}`; }

function setSessionPin(userId, pin){
  sessionPin = pin;
  sessionStorage.setItem(pinKey(userId), pin);
}

function clearSessionPin(userId){
  sessionPin = null;
  if (userId) sessionStorage.removeItem(pinKey(userId));
}

/* =========================================================
   3a) PERMISSIONS
   ========================================================= */
let userPermissions = new Set();

async function loadUserPermissions(){
  userPermissions = new Set();
  if (!currentUser) return;
  if (currentUser.is_admin) return;

  try {
    const { data: groups, error: gErr } = await supabaseClient
      .from("user_permission_groups")
      .select("group_id")
      .eq("user_id", currentUser.id);
    if (gErr) throw gErr;
    const groupIds = (groups || []).map(g => g.group_id).filter(Boolean);
    if (!groupIds.length) return;

    const { data: perms, error: pErr } = await supabaseClient
      .from("permission_group_permissions")
      .select("permission_key")
      .in("group_id", groupIds);
    if (pErr) throw pErr;
    (perms || []).forEach(p => userPermissions.add(p.permission_key));
  } catch (e) {
    console.warn("Failed to load permissions", e);
  }
}

function hasPermission(key){
  if (!currentUser) return false;
  if (currentUser.is_admin) return true;
  return userPermissions.has(key);
}
    
/* =========================================================
   3b) STATE (editing + requests)
   ========================================================= */
let activeCell = null;           // { td, userId, date }
const pendingEdits = {};         // key -> { userId, date, shift }
const requestsCache = new Map(); // key -> { id, user_id, date, value, important_rank }
 let periodsCache = [];
 const locksCache = new Map(); // key -> { user_id, date, reason_en, reason_es, locked_by, locked_at }
let activePeriodId = null;
    let activePeriodObj = null; // ‚Üê the actual period object
    let closeTriggeredReload = false;
    
// ===== 5-week window navigation =====
const WINDOW_WEEKS = 5;
let allWeeks = [];
let weekWindowStart = 0; // index into allWeeks

    

// key: `${user_id}_${date}` -> { id, user_id, date, value, important_rank }

    /* =========================================================
       4) DOM REFERENCES
       ========================================================= */
    const modal = document.getElementById("pinModal");
    const pinInput = document.getElementById("pinInput");
    const pinErr = document.getElementById("pinErr");
    const pinTitle = document.getElementById("pinTitle");
    const pinDesc = document.getElementById("pinDesc");
    const pinConfirmBtn = document.getElementById("pinConfirm");
    const pinCancelBtn = document.getElementById("pinCancel");
    const loginBadge = document.getElementById("loginBadge");
    const adminBadge = document.getElementById("adminBadge");
    
const periodSelect = document.getElementById("periodSelect");


    const adminPeriodSelect = document.getElementById("adminPeriodSelect");
const adminPeriodMeta = document.getElementById("adminPeriodMeta");
const adminSetActiveBtn = document.getElementById("adminSetActiveBtn");
const adminToggleHiddenBtn = document.getElementById("adminToggleHiddenBtn");
const adminWeeksList = document.getElementById("adminWeeksList");
    const closeLabel = document.getElementById("closeLabel");
    const adminClosesAtInput = document.getElementById("adminClosesAtInput");
const adminClosesAtSaveBtn = document.getElementById("adminClosesAtSaveBtn");
const adminClosesAtClearBtn = document.getElementById("adminClosesAtClearBtn");
const adminClosesAtHelp = document.getElementById("adminClosesAtHelp");



let adminSelectedPeriodId = null;
    
    const adminTabUsers = document.getElementById("adminTabUsers");
const adminViewUsers = document.getElementById("adminViewUsers");

const adminUsersList = document.getElementById("adminUsersList");
const adminAddUserBtn = document.getElementById("adminAddUserBtn");
const adminUserSearch = document.getElementById("adminUserSearch");
const adminShowInactiveUsers = document.getElementById("adminShowInactiveUsers");

const adminEditUserName = document.getElementById("adminEditUserName");
const adminEditUserRole = document.getElementById("adminEditUserRole");
const adminEditUserPin  = document.getElementById("adminEditUserPin");
const adminSaveUserBtn  = document.getElementById("adminSaveUserBtn");
const adminCancelUserEditBtn = document.getElementById("adminCancelUserEditBtn");
const adminUserEditHelp = document.getElementById("adminUserEditHelp");

// User modal refs
const userModal = document.getElementById("userModal");
const userCloseBtn = document.getElementById("userClose");
const userLogoutBtn = document.getElementById("userLogout");

const userMeta = document.getElementById("userMeta");
const userOldPin = document.getElementById("userOldPin");
const userNewPin = document.getElementById("userNewPin");
const userNewPin2 = document.getElementById("userNewPin2");
const userSavePin = document.getElementById("userSavePin");
const userPinErr = document.getElementById("userPinErr");
const userPinOk = document.getElementById("userPinOk");
const userLangEn = document.getElementById("userLangEn");
const userLangEs = document.getElementById("userLangEs");



    // Shift modal refs
    const shiftModal = document.getElementById("shiftModal");
    const shiftCancelBtn = document.getElementById("shiftCancel");
    const shiftLockBtn = document.getElementById("shiftLockBtn");


// Shift Help modal refs
const shiftHelpModal = document.getElementById("shiftHelpModal");
const shiftHelpBtn = document.getElementById("shiftHelpBtn");
const shiftHelpClose = document.getElementById("shiftHelpClose");
const shiftHelpClose2 = document.getElementById("shiftHelpClose2");

const shiftHelpContentEn = document.getElementById("shiftHelpContentEn");
const shiftHelpContentEs = document.getElementById("shiftHelpContentEs");

    
// Week comment modal refs
const weekCommentModal = document.getElementById("weekCommentModal");
const weekCommentCancel = document.getElementById("weekCommentCancel");
const weekCommentSave = document.getElementById("weekCommentSave");
const weekCommentInput = document.getElementById("weekCommentInput");
const weekCommentAdminList = document.getElementById("weekCommentAdminList");
const weekCommentYourLabel = document.getElementById("weekCommentYourLabel");


// Notices refs

const noticeBell = document.getElementById("noticeBell");
const noticeBellDot = document.getElementById("noticeBellDot");

// Admin notices refs
const adminTabNotices = document.getElementById("adminTabNotices");
const adminViewNotices = document.getElementById("adminViewNotices");
const adminNoticesList = document.getElementById("adminNoticesList");

const adminAddNoticeBtn = document.getElementById("adminAddNoticeBtn");
const adminNoticeSearch = document.getElementById("adminNoticeSearch");
const adminShowInactiveNotices = document.getElementById("adminShowInactiveNotices");

// Admin notice editor modal refs
const adminNoticeModal = document.getElementById("adminNoticeModal");
const adminNoticeTitle = document.getElementById("adminNoticeTitle");
const adminNoticeTitleInput = document.getElementById("adminNoticeTitleInput");
const adminNoticeBodyEn = document.getElementById("adminNoticeBodyEn");
const adminNoticeBodyEs = document.getElementById("adminNoticeBodyEs");

const noticeTargetAll = document.getElementById("noticeTargetAll");
const noticeRoleChks = Array.from(document.querySelectorAll(".noticeRoleChk"));

const adminNoticeCancel = document.getElementById("adminNoticeCancel");
const adminNoticeSave = document.getElementById("adminNoticeSave");

const noticeUnreadModal = document.getElementById("noticeUnreadModal");
const noticeUnreadList = document.getElementById("noticeUnreadList");
const noticeUnreadAcknowledge = document.getElementById("noticeUnreadAcknowledge");

const noticeAllModal = document.getElementById("noticeAllModal");
const noticeAllList = document.getElementById("noticeAllList");
const noticeAllClose = document.getElementById("noticeAllClose");

// Initialize Quill editors for notices
let quillEnglish, quillSpanish;
document.addEventListener("DOMContentLoaded", function() {
  quillEnglish = new Quill("#adminNoticeBodyEn", {
    theme: "snow",
    modules: {
      toolbar: [
        "bold", "italic", "underline",
        { list: "ordered" }, { list: "bullet" },
        "blockquote",
        "clean"
      ]
    },
    placeholder: "Enter notice content..."
  });

  quillSpanish = new Quill("#adminNoticeBodyEs", {
    theme: "snow",
    modules: {
      toolbar: [
        "bold", "italic", "underline",
        { list: "ordered" }, { list: "bullet" },
        "blockquote",
        "clean"
      ]
    },
    placeholder: "Enter notice content..."
  });
});

applyLanguage();

let activeWeekIdForComment = null;
    function toDatetimeLocalValue(dateObj){
  // returns "YYYY-MM-DDTHH:MM" in local time
  const pad = (n) => String(n).padStart(2, "0");
  const y = dateObj.getFullYear();
  const m = pad(dateObj.getMonth() + 1);
  const d = pad(dateObj.getDate());
  const h = pad(dateObj.getHours());
  const mi = pad(dateObj.getMinutes());
  return `${y}-${m}-${d}T${h}:${mi}`;
}

function datetimeLocalToISOString(value){
  // value is "YYYY-MM-DDTHH:MM" interpreted as LOCAL time
  // Convert to a Date then ISO (UTC). Works cleanly with timestamptz in Supabase.
  const dt = new Date(value);
  return dt.toISOString();
}

function renderAdminCloseTime(periodId){
  const p = periodsCache.find(x => String(x.id) === String(periodId));
  if (!p) return;

  if (adminClosesAtInput){
    adminClosesAtInput.value = p.closes_at ? toDatetimeLocalValue(new Date(p.closes_at)) : "";
  }

  if (adminClosesAtHelp){
    if (!p.closes_at){
      adminClosesAtHelp.textContent = "No close time set (requests stay open).";
    } else {
      const d = new Date(p.closes_at);
      adminClosesAtHelp.textContent =
        `Currently closes at: ${d.toLocaleString("en-GB")}`;
    }
  }
}

    
  let closeCountdownTimer = null;
function setShiftHelpLanguage(lang){
  const isEn = (lang !== "es");

  shiftHelpContentEn.style.display = isEn ? "block" : "none";
  shiftHelpContentEs.style.display = isEn ? "none" : "block";

  const title = document.getElementById("shiftHelpTitle");
  const sub = document.getElementById("shiftHelpSubtitle");
  if (title) title.textContent = isEn ? "Shift request guidelines" : "Gu√≠a de solicitudes de turnos";
  if (sub) sub.textContent = isEn
  ? "How preferences are considered"
  : "C√≥mo se consideran las preferencias";

  if (shiftHelpClose) shiftHelpClose.textContent = isEn ? "Close" : "Cerrar";
  if (shiftHelpClose2) shiftHelpClose2.textContent = isEn ? "OK" : "Vale";
}

function openShiftHelpModal(){
  // Respect saved preference if available
  const lang = currentUser?.preferred_lang || "en";
  setShiftHelpLanguage(lang);

  document.body.classList.add("modal-open");
  shiftHelpModal.style.display = "flex";
  shiftHelpModal.setAttribute("aria-hidden", "false");
}

function closeShiftHelpModal(){
  shiftHelpModal.style.display = "none";
  shiftHelpModal.setAttribute("aria-hidden", "true");
  updateBodyModalOpen();
}


shiftHelpBtn?.addEventListener("click", (e) => {
  e.preventDefault();
  e.stopPropagation();
  openShiftHelpModal();
});


/* =========================
   ADMIN LOCK TOGGLE (5B)
   ========================= */
shiftLockBtn?.addEventListener("click", async (e) => {
  e.preventDefault();
  e.stopPropagation();

  if (!currentUser?.is_admin) return;
  if (!activeCell) return;

  const pin = getSessionPinOrThrow();
  const targetUserId = activeCell.userId;
  const date = activeCell.date;
  const key = `${targetUserId}_${date}`;

  const existing = locksCache.get(key);

  try {
    if (existing) {
      // üîì UNLOCK
      const { error } = await supabaseClient.rpc(
        "admin_unlock_request_cell",
        {
          p_admin_id: currentUser.id,
          p_pin: pin,
          p_target_user_id: targetUserId,
          p_date: date
        }
      );
      if (error) throw error;

      locksCache.delete(key);
      shiftLockBtn.textContent = "üîì";

    } else {
      // üîí LOCK (optional reason)
      const reason = prompt(
        currentLang === "es"
          ? "Motivo (opcional). El usuario lo ver√° al pulsar este d√≠a:"
          : "Reason (optional). Staff will see this if they click this day:"
      );

      if (reason === null) return;

      const { data, error } = await supabaseClient.rpc(
        "admin_lock_request_cell",
        {
          p_admin_id: currentUser.id,
          p_pin: pin,
          p_target_user_id: targetUserId,
          p_date: date,
          p_reason_en: currentLang === "es" ? null : reason,
          p_reason_es: currentLang === "es" ? reason : null
        }
      );
      if (error) throw error;

      locksCache.set(key, data);
      shiftLockBtn.textContent = "üîí";
    }

    await loadRota(); // keep UI honest

    // Re-open the modal to show the updated lock icon (iOS fix)
    if (activeCell) {
      openShiftModal();
    }

  } catch (err) {
    console.error(err);
    alert("Lock action failed.");
  }
});


shiftHelpClose?.addEventListener("click", closeShiftHelpModal);
shiftHelpClose2?.addEventListener("click", closeShiftHelpModal);

shiftHelpModal?.addEventListener("click", (e) => {
  if (e.target === shiftHelpModal) closeShiftHelpModal();
});




function formatTimeLeft(ms){
  if (ms <= 0) return "0m";

  const totalMins = Math.floor(ms / 60000);
  const days = Math.floor(totalMins / (60 * 24));
  const hours = Math.floor((totalMins % (60 * 24)) / 60);
  const mins = totalMins % 60;

  const parts = [];
  if (days) parts.push(`${days}d`);
  if (days || hours) parts.push(`${hours}h`);
  parts.push(`${mins}m`);

  return parts.join(" ");
}

function updateCloseLabel(period){
  if (!closeLabel) return;

  if (closeCountdownTimer){
    clearInterval(closeCountdownTimer);
    closeCountdownTimer = null;
  }

  const closeAt = getPeriodCloseDate(period);

if (!closeAt){
closeLabel.innerHTML = `
  <span class="close-pill">
    <span class="dot"></span>
    <span class="msg">${t("reqOpen")}</span>
  </span>
`;
  return;
}

const renderCloseLabel = () => {
  const now = new Date();
  const msLeft = closeAt - now;

if (msLeft <= 0){
closeLabel.innerHTML = `
  <span class="close-pill is-closed">
    <span class="dot"></span>
    <span class="msg">${t("reqClosed")}</span>
    <span class="mini">${t("closedAt", closeAt.toLocaleString("en-GB"))}</span>
  </span>
`;


  clearInterval(closeCountdownTimer);
  closeCountdownTimer = null;

  // ‚úÖ FIX 3: force UI to re-render locked state once
  if (!closeTriggeredReload) {
    closeTriggeredReload = true;
    loadRota(); // re-fetch + redraw so cells become locked
  }

  return;
}

  const soon = msLeft <= 24 * 60 * 60 * 1000;

closeLabel.innerHTML = `
  <span class="close-pill ${soon ? "is-soon" : ""}">
    <span class="dot"></span>
    <span class="msg">${soon ? t("reqCloseSoon") : t("reqClose")}</span>
    <span class="mini">${closeAt.toLocaleString("en-GB")}</span>
    <span class="timeleft">${t("left", formatTimeLeft(msLeft))}</span>
  </span>
`;

};


renderCloseLabel();
closeCountdownTimer = setInterval(renderCloseLabel, 30000);
}

function openUserModal(){
  if (!currentUser) return;

  userMeta.textContent = `${currentUser.name}${currentUser.is_admin ? " (admin)" : ""}`;
  userOldPin.value = "";
  userNewPin.value = "";
  userNewPin2.value = "";

  userPinErr.style.display = "none";
  userPinOk.style.display = "none";


paintLangButtons();

  document.body.classList.add("modal-open");
  userModal.style.display = "flex";
  userModal.setAttribute("aria-hidden", "false");

  setTimeout(() => userOldPin.focus(), 50);
}

function closeUserModal(){
  userModal.style.display = "none";
  userModal.setAttribute("aria-hidden", "true");
  updateBodyModalOpen();
}


function logout(){
  if (!currentUser) return;

  // clear stored login + pin
  localStorage.removeItem(STORAGE_KEY);
  clearSessionPin(currentUser.id);

  // clear state
  currentUser = null;
  selectedUser = null;
  sessionPin = null;

  closeUserModal();
  updateBadges();
  applyUnlockState();

  // refresh UI (so any "editable" disappears + dropdown filtering updates)
  loadRota();
}

// Wire badge click
loginBadge.addEventListener("click", () => {
  if (!currentUser) return;        // don‚Äôt open it when not logged in
  openUserModal();
});

// Close actions
userCloseBtn?.addEventListener("click", closeUserModal);
userLogoutBtn?.addEventListener("click", logout);
userModal?.addEventListener("click", (e) => {
  if (e.target === userModal) closeUserModal();
});

async function setMyLanguage(lang){
  if (!currentUser) return;

  try {
    const pin = getSessionPinOrThrow();

    const { data, error } = await supabaseClient.rpc("set_user_language", {
      p_user_id: currentUser.id,
      p_pin: pin,
      p_lang: lang
    });

    if (error) throw error;

    currentUser.preferred_lang = data || lang;
    paintLangButtons();

  } catch (e) {
    console.error(e);
    alert("Failed to update language. Check console.");
  }
}

userLangEn?.addEventListener("click", () => setMyLanguage("en"));
userLangEs?.addEventListener("click", () => setMyLanguage("es"));


// Save PIN
userSavePin?.addEventListener("click", async () => {
  if (!currentUser) return;

  userPinErr.style.display = "none";
  userPinOk.style.display = "none";

  const oldPin = userOldPin.value.trim();
  const newPin = userNewPin.value.trim();
  const newPin2 = userNewPin2.value.trim();

  if (!/^\d{4}$/.test(oldPin)) return showUserPinErr("Current PIN must be 4 digits.");
  if (!/^\d{4}$/.test(newPin)) return showUserPinErr("New PIN must be 4 digits.");
  if (newPin !== newPin2) return showUserPinErr("New PINs do not match.");
  if (oldPin === newPin) return showUserPinErr("New PIN must be different.");

  userSavePin.disabled = true;

  try {
    // OPTIONAL: verify old pin first (you already have this RPC)
    const { data: ok, error: vErr } = await supabaseClient.rpc("verify_user_pin", {
      p_user_id: currentUser.id,
      p_pin: oldPin
    });
    if (vErr) throw vErr;
    if (ok !== true) return showUserPinErr("Current PIN is incorrect.");

    // Change pin (YOU need this RPC - see SQL below)
    const { error: cErr } = await supabaseClient.rpc("change_user_pin", {
      p_user_id: currentUser.id,
      p_old_pin: oldPin,
      p_new_pin: newPin
    });
    if (cErr) throw cErr;

    // Update session pin to the new one so their session keeps working
    setSessionPin(currentUser.id, newPin);

    userPinOk.style.display = "block";
    userOldPin.value = "";
    userNewPin.value = "";
    userNewPin2.value = "";

  } catch (e) {
    console.error(e);
    showUserPinErr("Failed to update PIN. Check console.");
  } finally {
    userSavePin.disabled = false;
  }
});

function paintLangButtons(){
  const lang = (currentUser?.preferred_lang || "en");

  userLangEn?.classList.toggle("is-active", lang === "en");
  userLangEs?.classList.toggle("is-active", lang === "es");
}

function showUserPinErr(msg){
  userPinErr.textContent = msg;
  userPinErr.style.display = "block";
}

    
function openWeekCommentModal(){
  if (!activeWeekIdForComment) return;
  document.body.classList.add("modal-open");  // ‚úÖ
  weekCommentModal.style.display = "flex";
  weekCommentModal.setAttribute("aria-hidden","false");
}

function closeWeekCommentModal(){
  weekCommentModal.style.display = "none";
  weekCommentModal.setAttribute("aria-hidden","true");

  activeWeekIdForComment = null;
  weekCommentInput.value = "";
  weekCommentAdminList.innerHTML = "";
  weekCommentAdminList.style.display = "none";

  updateBodyModalOpen();
}
weekCommentCancel.addEventListener("click", closeWeekCommentModal);
weekCommentModal.addEventListener("click", (e) => {
  if (e.target === weekCommentModal) closeWeekCommentModal();
});

if (adminBadge) {
  adminBadge.addEventListener("click", () => {
    if (!currentUser?.is_admin) return;
    openAdminConsole();
  });
}
 

// Click handler for üí¨ buttons (event delegation)
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".week-comment-btn");
  if (!btn) return;

  e.preventDefault();
  e.stopPropagation();

  const weekId = (btn.dataset.weekId || "").trim();
  if (!weekId) {
    alert("Week ID missing (data-week-id is empty). Fix rota_weeks(id,open) select.");
    return;
  }

  if (!currentUser) {
alert(t("loginFirst"));

    return;
  }

  activeWeekIdForComment = weekId;

  try {
    const rows = await fetchWeekComments(weekId);

    // ---- My comment (normal user + admin)
    const myId = String(currentUser.id);
    const mine = (rows || []).find(r => String(r.user_id) === myId);
    weekCommentInput.value = mine?.comment || "";

    // ---- Admin list (all staff comments)
    if (currentUser.is_admin) {
      weekCommentAdminList.style.display = "block";

      if (!rows || rows.length === 0) {
      weekCommentAdminList.innerHTML = `<div class="subtitle">${escapeHtml(t("noCommentsYet"))}</div>`;

      } else {
        weekCommentAdminList.innerHTML = rows.map(r => {
          const uid = String(r.user_id);
          const name = usersById.get(uid) || uid;
          const when = r.updated_at ? new Date(r.updated_at).toLocaleString("en-GB") : "";
          const commentSafe = escapeHtml(r.comment || "");

          return `
            <div class="week-comment-row">
              <div class="week-comment-name">${escapeHtml(name)}</div>
              <div class="week-comment-meta">${when}</div>
              <div class="week-comment-text">${commentSafe}</div>
            </div>
          `;
        }).join("");
      }
    } else {
      weekCommentAdminList.style.display = "none";
      weekCommentAdminList.innerHTML = "";
    }

    // ---- Bubble indicator: mark if ANY comment exists
    btn.classList.toggle("has-comment", (rows || []).length > 0);

applyLanguage();
openWeekCommentModal();

  } catch (err) {
    console.error("Week comment load failed:", err);
alert(t("failedLoadWeekComments"));

  }
});

// Save handler
weekCommentSave.addEventListener("click", async () => {
  if (!activeWeekIdForComment || !currentUser) return;

  try {
    await upsertWeekComment(
      activeWeekIdForComment,
      currentUser.id,
      weekCommentInput.value
    );

    // Re-fetch so bubble reflects whether ANY comment exists (not just yours)
    const rows = await fetchWeekComments(activeWeekIdForComment);

    // Update the bubble indicator for this week header button
    const selector = `.week-comment-btn[data-week-id="${CSS.escape(String(activeWeekIdForComment))}"]`;
    const btn = document.querySelector(selector);
    if (btn) {
      btn.classList.toggle("has-comment", (rows || []).length > 0);
    }

    // If admin, refresh the visible comment list too
    if (currentUser.is_admin) {
      weekCommentAdminList.style.display = "block";
      if (!rows || rows.length === 0) {
       weekCommentAdminList.innerHTML = `<div class="subtitle">${escapeHtml(t("noCommentsYet"))}</div>`;

      } else {
        weekCommentAdminList.innerHTML = rows.map(r => {
          const uid = String(r.user_id);
          const name = usersById.get(uid) || uid;
          const when = r.updated_at ? new Date(r.updated_at).toLocaleString("en-GB") : "";
          const commentSafe = escapeHtml(r.comment || "");
          return `
            <div style="padding:6px 0; border-bottom:1px solid #eee;">
              <div style="font-weight:700;">${escapeHtml(name)}</div>
              <div style="font-size:11px; color:#777;">${when}</div>
              <div style="white-space:pre-wrap;">${commentSafe}</div>
            </div>
          `;
        }).join("");
      }
    }

    closeWeekCommentModal();
  } catch (err) {
    console.error("Week comment save failed:", err);
 alert(t("failedSaveWeekComment"));

  }
});
    

/* =========================================================
   6) PERIOD DROPDOWN HANDLER
   ========================================================= */
if (periodSelect) {
  periodSelect.addEventListener("change", async () => {
    closeTriggeredReload = false; // ‚úÖ reset for new period
    activePeriodId = periodSelect.value;

    const selected = periodsCache.find(p => String(p.id) === String(activePeriodId));
    activePeriodObj = selected;

    updateCloseLabel(selected);
    applyUnlockState();
    await loadRota();
  });
}

/* =========================
   ADMIN PANEL (v1)
   ========================= */
const adminModal = document.getElementById("adminModal");
const adminCloseBtn = document.getElementById("adminClose");
const adminTabPeriods = document.getElementById("adminTabPeriods");
const adminTabGenerate = document.getElementById("adminTabGenerate");
const adminViewPeriods = document.getElementById("adminViewPeriods");
const adminViewGenerate = document.getElementById("adminViewGenerate");

const adminGeneratePreview = document.getElementById("adminGeneratePreview");
const adminGenerateBtn = document.getElementById("adminGenerateBtn");

function openAdminConsole(){
  if (!currentUser?.is_admin) return;
  document.body.classList.add("modal-open");
  adminModal.style.display = "flex";
  adminModal.setAttribute("aria-hidden","false");
  showAdminTab("periods");
  loadAdminPeriodsForDropdown();
  refreshGeneratePreview();
}

function closeAdminConsole(){
  adminModal.style.display = "none";
  adminModal.setAttribute("aria-hidden","true");
  updateBodyModalOpen();
}

function goToFullAdmin() {
  console.log("[DEBUG] goToFullAdmin called");
  if (!currentUser) {
    alert("Not logged in.");
    return;
  }
  const pin = sessionStorage.getItem(`calpeward.pin.${currentUser.id}`);
  if (!pin) {
    alert("No session PIN. Log in again.");
    return;
  }
  console.log("[DEBUG] Storing session and navigating to admin.html");
  const sessionData = { userId: currentUser.id, pin: pin };
  window.name = "calpeward:" + btoa(JSON.stringify(sessionData));
  window.location.href = "admin.html";
}



if (adminCloseBtn) adminCloseBtn.addEventListener("click", closeAdminConsole);
if (adminModal) adminModal.addEventListener("click", (e) => {
  if (e.target === adminModal) closeAdminConsole();
});

// [ADMIN-UI-1] Tab switching (Periods / Generate / Users)
function showAdminTab(which){
  const isPeriods  = (which === "periods");
  const isGenerate = (which === "generate");
  const isUsers    = (which === "users");
  const isNotices  = (which === "notices");

  adminViewPeriods.style.display  = isPeriods  ? "block" : "none";
  adminViewGenerate.style.display = isGenerate ? "block" : "none";
  adminViewUsers.style.display    = isUsers    ? "block" : "none";
  adminViewNotices.style.display  = isNotices  ? "block" : "none";

  adminTabPeriods.classList.toggle("is-active", isPeriods);
  adminTabGenerate.classList.toggle("is-active", isGenerate);
  adminTabUsers.classList.toggle("is-active", isUsers);
  adminTabNotices.classList.toggle("is-active", isNotices);

  if (isNotices) loadAdminNotices();
}

if (adminTabPeriods) adminTabPeriods.addEventListener("click", () => showAdminTab("periods"));
if (adminTabGenerate) adminTabGenerate.addEventListener("click", () => showAdminTab("generate"));

    // [ADMIN-UI-4] Users tab
if (adminTabUsers) {
  adminTabUsers.addEventListener("click", () => {
    showAdminTab("users");
    loadAdminUsers();
  });
}

if (adminTabNotices) {
  adminTabNotices.addEventListener("click", () => {
    showAdminTab("notices");
  });
}

/* =========================================================
   5B) NOTICES (blocking unread + bell history)
   Uses: #noticeUnreadModal, #noticeAllModal, #noticeBellDot
   ========================================================= */

let noticesCache = [];       // latest first
let blockingNoticeIds = [];  // ids of notices not acknowledged at current version
let unreadCount = 0;

function getNoticeBody(n){
  const wantEs = (currentLang === "es");
  if (wantEs && n.body_es && String(n.body_es).trim()) return n.body_es;
  return n.body_en || "";
}

function isNoticeAcked(n){
  // Must have an acknowledgement timestamp
  if (!n.acknowledged_at) return false;

  // If an ack version exists, it must match the notice version
  if (
    n.ack_version != null &&
    Number(n.ack_version) !== Number(n.version)
  ) {
    return false;
  }

  return true;
}

async function fetchNoticeAcksForAdmin(noticeId){
  const { data, error } = await supabaseClient
    .rpc("admin_get_notice_acks", { p_notice_id: noticeId });

  if (error) throw error;

  // Normalize the RPC result: the function returns a single row object
  // with { acked: [...], pending: [...] } -- sometimes Supabase returns
  // an array of rows, so handle both shapes and return the acked list.
  const res = Array.isArray(data) ? (data[0] || { acked: [], pending: [] }) : (data || { acked: [], pending: [] });
  try { console.debug('fetchNoticeAcksForAdmin -> noticeId', noticeId, 'res', res); } catch(e) {}
  return res.acked || [];
}


async function fetchNoticesForMe(){
  if (!currentUser) return [];

  const pin = getSessionPinOrThrow();

const { data, error } = await supabaseClient.rpc(
  "get_notices_for_user",
  {
    p_user_id: currentUser.id
  }
);
  if (error) throw error;

  // De-dupe by notice id
const map = new Map();
for (const row of (data || [])){
  const key = String(row.id);
  const prev = map.get(key);
  if (!prev) {
    map.set(key, row);
    continue;
  }

  // Prefer the row with the newest updated_at
  const prevT = prev.updated_at ? new Date(prev.updated_at).getTime() : 0;
  const rowT  = row.updated_at  ? new Date(row.updated_at).getTime()  : 0;

  if (rowT > prevT) map.set(key, row);
}


return [...map.values()].sort((a,b) => new Date(b.updated_at) - new Date(a.updated_at));
}

function computeNoticeState(list){
  noticesCache = Array.isArray(list) ? list : [];
  blockingNoticeIds = [];
  unreadCount = 0;

  for (const n of noticesCache){
    // Inactive notices never count
    if (n.is_active === false) continue;

    const acked = isNoticeAcked(n);

    if (!acked){
      unreadCount++;

      // Blocking notices MUST carry id + version
      blockingNoticeIds.push({
        id: n.id,
        version: n.version
      });
    }
  }
}
console.log("Blocking notices:", blockingNoticeIds);
console.log("Unread count:", unreadCount);

console.table(noticesCache.map(n => ({
  id: n.id,
  version: n.version,
  acked_at: n.acknowledged_at,
  acked: isNoticeAcked(n)
})));

function updateNoticeBell(){
  if (!noticeBell || !noticeBellDot) return;

  if (!currentUser){
    noticeBell.style.display = "none";
    noticeBellDot.style.display = "none";
    return;
  }

  noticeBell.style.display = "inline-flex";
  noticeBellDot.style.display = (unreadCount > 0) ? "inline" : "none";
}

function openUnreadModal(){
  if (!noticeUnreadModal) return;

  renderUnreadList();

  document.body.classList.add("modal-open");
  noticeUnreadModal.style.display = "flex";
  noticeUnreadModal.setAttribute("aria-hidden","false");
}

function closeUnreadModal(){
  if (!noticeUnreadModal) return;

  noticeUnreadModal.style.display = "none";
  noticeUnreadModal.setAttribute("aria-hidden","true");
  updateBodyModalOpen();
}

function openAllNoticesModal(){
  if (!noticeAllModal) return;

  renderAllNoticesList();

  document.body.classList.add("modal-open");
  noticeAllModal.style.display = "flex";
  noticeAllModal.setAttribute("aria-hidden","false");
}

function closeAllNoticesModal(){
  if (!noticeAllModal) return;

  noticeAllModal.style.display = "none";
  noticeAllModal.setAttribute("aria-hidden","true");
  updateBodyModalOpen();
}

function renderUnreadList(){
  if (!noticeUnreadList) return;

const unread = (noticesCache || []).filter(n => n.is_active !== false && !isNoticeAcked(n));

  if (!unread.length){
    noticeUnreadList.innerHTML = `<div class="subtitle">No unread notices.</div>`;
    return;
  }

  noticeUnreadList.innerHTML = unread.map(n => {
    const body = getNoticeBody(n); // Already formatted as HTML from Quill
    const when = n.updated_at ? new Date(n.updated_at).toLocaleString("en-GB") : "";
    const who = escapeHtml(n.created_by_name || "‚Äî");

    return `
      <div class="notice-card">
        <div class="notice-title">${escapeHtml(n.title || "Notice")}</div>
        <div class="notice-meta">By ${who} ¬∑ ${when} <span class="notice-pill unread" style="margin-left:6px;">NEW</span></div>
        <div class="notice-body" style="line-height: 1.6;">${body}</div>
      </div>
    `;
  }).join("");
}

function filterNoticesForUser(list){
  if (!currentUser) return [];

  // Your app uses role_id: 1/2/3
  const myRoleId = Number(currentUser.role_id);

  return (list || []).filter(n => {
    // If targeting is explicitly all, or targeting is not set, show it
    if (n.target_all === true || n.target_all == null) return true;

    // Parse target_roles in multiple possible shapes:
    // - array of ints (normal)
    // - Postgres array text like '{1,2}'
    // - JSON string like '[1,2]'
    // - a single numeric string '1'
    let roles = [];

    if (Array.isArray(n.target_roles)) {
      roles = n.target_roles.map(Number);
    } else if (typeof n.target_roles === 'string') {
      const s = n.target_roles.trim();
      // postgres array format {1,2}
      if (s.startsWith('{') && s.endsWith('}')) {
        roles = s.slice(1,-1).split(',').map(x => Number(x)).filter(Boolean);
      } else {
        // try JSON parse or comma-split
        try {
          const parsed = JSON.parse(s);
          if (Array.isArray(parsed)) roles = parsed.map(Number).filter(Boolean);
          else if (!isNaN(Number(parsed))) roles = [Number(parsed)];
        } catch (err) {
          roles = s.split(',').map(x => Number(x.trim())).filter(Boolean);
        }
      }
    }

    // If no roles specified, keep previous behavior and consider visible
    if (!roles.length) return true;

    // Debugging help: if current user's role is missing, log once
    if (isNaN(myRoleId)) {
      console.warn('filterNoticesForUser: currentUser.role_id is missing or invalid', currentUser);
      return false;
    }

    return roles.includes(myRoleId);
  });
}

function renderAllNoticesList(){
  if (!noticeAllList) return;

  // IMPORTANT: only show notices the current user is allowed to see
  const visible = filterNoticesForUser(noticesCache);

  // Debug: show why each notice is visible for current user
  try {
    console.debug('renderAllNoticesList - currentUser.role_id', currentUser?.role_id);
    console.table((visible || []).map(n => ({ id: n.id, title: n.title, target_all: n.target_all, target_roles: n.target_roles })));
  } catch (err) { /* ignore */ }

  if (!visible.length){
    noticeAllList.innerHTML = `<div class="subtitle">No notices.</div>`;
    return;
  }

  noticeAllList.innerHTML = visible.map(n => {
    const acked = isNoticeAcked(n);
    const body  = getNoticeBody(n); // Already formatted as HTML from Quill
    const when  = n.updated_at ? new Date(n.updated_at).toLocaleString("en-GB") : "";
    const who   = escapeHtml(n.created_by_name || "Unknown");

    const pill = acked
      ? `<span class="notice-pill">Acknowledged</span>`
      : `<span class="notice-pill unread">New</span>`;

    return `
      <div class="notice-card">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
          <div style="min-width:0;">
            <div class="notice-title">${escapeHtml(n.title || "Notice")}</div>
            <div class="notice-meta">By ${who}${when ? " ¬∑ " + when : ""}</div>
          </div>
          <div>${pill}</div>
        </div>

        <div class="notice-body" style="margin-top:8px; line-height: 1.6;">${body}</div>

        ${acked ? "" : `
          <div style="display:flex; justify-content:flex-end; margin-top:10px;">
            <button type="button" class="primary" data-ack="${n.id}" style="min-width:auto;">
              Acknowledge
            </button>
          </div>
        `}
      </div>
    `;
  }).join("");
}



async function adminFetchNoticeAcks(noticeId){
  const pin = getSessionPinOrThrow();

  const { data, error } = await supabaseClient.rpc("admin_get_notice_acks", {
    p_admin_id: currentUser.id,
    p_pin: pin,
    p_notice_id: noticeId
  });

  if (error) throw error;

  // Normalize response: Supabase may return an array (rows) or a single object
  const res = Array.isArray(data) ? (data[0] || { acked: [], pending: [] }) : (data || { acked: [], pending: [] });
  return res;
}

// Admin-only: fetch ack counts for a set of notices via RPC
async function adminFetchNoticeAckCounts(noticeIds){
  if (!Array.isArray(noticeIds) || noticeIds.length === 0) return [];

  const { data, error } = await supabaseClient.rpc("admin_notice_ack_counts", {
    p_notice_ids: noticeIds
  });

  if (error) throw error;

  // debug: log counts to help trace mismatches
  try { console.debug('adminFetchNoticeAckCounts -> raw data', data); } catch(e){}

  return data || [];
}

// Update admin cache and visible DOM for a single notice id
function updateAdminNoticeCountsForId(noticeId, counts){
  try {
    const idStr = String(noticeId);
    const noticeObj = adminNoticesCache.find(n => String(n.id) === idStr);

    const newAckCount = counts && typeof counts.ack_count !== 'undefined' ? Number(counts.ack_count) : NaN;
    const newAckTotal = counts && typeof counts.ack_total !== 'undefined' ? Number(counts.ack_total) : NaN;

    if (noticeObj){
      // Only overwrite ack_count if we have a valid new value
      if (!isNaN(newAckCount)) noticeObj.ack_count = newAckCount;
      // Never allow ack_total to decrease - prefer the larger known total
      if (!isNaN(newAckTotal)) noticeObj.ack_total = Math.max(Number(noticeObj.ack_total) || 0, newAckTotal);
    } else {
      // If notice isn't in cache, add a minimal entry (don't allow NaN)
      adminNoticesCache.push({
        id: noticeId,
        ack_count: !isNaN(newAckCount) ? newAckCount : 0,
        ack_total: !isNaN(newAckTotal) ? newAckTotal : 0
      });
    }

    const countSpan = document.querySelector(`[data-ack-count="${idStr}"]`);
    if (countSpan) countSpan.textContent = String(noticeObj?.ack_count ?? (isNaN(newAckCount) ? 0 : newAckCount));
    const totalSpan = document.querySelector(`[data-ack-total="${idStr}"]`);
    if (totalSpan) totalSpan.textContent = String(noticeObj?.ack_total ?? (isNaN(newAckTotal) ? 0 : newAckTotal));

    // Force a re-render of admin list if necessary
    if (typeof renderAdminNotices === 'function') renderAdminNotices();
  } catch (e) {
    console.warn('updateAdminNoticeCountsForId failed', noticeId, e);
  }
}

function renderAckList(container, list){
  if (!container) return;

  if (!list?.length){
    container.innerHTML = `<div class="subtitle">None</div>`;
    return;
  }

  container.innerHTML = list.map(x => {
    const nm = escapeHtml(x.name || "");
    const when = x.acknowledged_at ? ` <span class="subtitle">(${new Date(x.acknowledged_at).toLocaleString("en-GB")})</span>` : "";
    return `<div><span class="ack-pill">${nm}</span>${when}</div>`;
  }).join("");
}


async function refreshNotices(){
const list = await fetchNoticesForMe();
const visible = filterNoticesForUser(list);
computeNoticeState(visible);
  updateNoticeBell();
}

async function ackOneNotice(noticeId, noticeVersion){
  if (!currentUser) return;

  const { error } = await supabaseClient.rpc("ack_notice", {
    p_notice_id: noticeId,
    p_user_id: currentUser.id,
    p_version: noticeVersion
  });

  if (error) throw error;

  // Refresh local notices and, if viewing as admin, refresh the ack counts for this notice
  try {
    await refreshNotices();

    if (currentUser?.is_admin && typeof adminFetchNoticeAckCounts === 'function'){
      try {
        const counts = await adminFetchNoticeAckCounts([noticeId]);
        const c = Array.isArray(counts) && counts[0] ? counts[0] : null;
        if (c) updateAdminNoticeCountsForId(noticeId, c);
      } catch (e){
        console.warn('Failed to refresh admin ack counts for notice', noticeId, e);
      }
    }
  } catch (e) {
    console.warn('post-ack refresh failed', e);
  }
}




async function refreshNoticesAndMaybeBlock(){
  if (!currentUser){
    noticesCache = [];
    blockingNoticeIds = [];
    unreadCount = 0;
    updateNoticeBell();
    return;
  }

  try {
  await refreshNotices();

    // Block editing until unread are acknowledged
    if (blockingNoticeIds.length > 0){
      openUnreadModal();
    }
  } catch (e) {
    console.error("Notices load failed:", e);
    // Do not brick the app if notices fail
  }
}

/* ---- UI wiring ---- */

// Bell opens the history modal
noticeBell?.addEventListener("click", (e) => {
  e.preventDefault();
  e.stopPropagation();
  if (!currentUser) return;
  openAllNoticesModal();
});

// Admin-only: load ack lists when the "Acknowledged by" row is clicked.
// (toggle event doesn't bubble, so we use click delegation)
noticeAllList?.addEventListener("click", async (e) => {
  const summary = e.target.closest("summary");
  if (!summary) return;

  const details = summary.closest("details.notice-acks");
  if (!details) return;

  // Wait a tick so details.open reflects the new state after click
  setTimeout(async () => {
    if (!details.open) return;
    if (details.dataset.loaded === "1") return;

    const noticeId = details.dataset.ackId;
    const ackedBox = details.querySelector('[data-ack-list="acked"]');
    const pendBox  = details.querySelector('[data-ack-list="pending"]');

    try {
      details.dataset.loaded = "1";
      const { acked, pending } = await adminFetchNoticeAcks(noticeId);
      renderAckList(ackedBox, acked);
      renderAckList(pendBox, pending);

      // Update admin counts immediately from the detailed lists
      try {
        const ac = Array.isArray(acked) ? acked.length : 0;
        const at = ac + (Array.isArray(pending) ? pending.length : 0);
        updateAdminNoticeCountsForId(noticeId, { ack_count: ac, ack_total: at });
      } catch (e){
        console.warn('Failed to update counts after loading ack list', noticeId, e);
      }
    } catch (err) {
      console.error(err);
      details.dataset.loaded = "0";
      if (ackedBox) ackedBox.textContent = "Failed to load.";
      if (pendBox) pendBox.textContent  = "Failed to load.";
    }
  }, 0);
});


noticeAllClose?.addEventListener("click", closeAllNoticesModal);
noticeAllModal?.addEventListener("click", (e) => {
  if (e.target === noticeAllModal) closeAllNoticesModal();
});

// Acknowledge single from ALL modal (event delegation)
noticeAllList?.addEventListener("click", async (e) => {
  const btn = e.target.closest("button[data-ack]");
  if (!btn) return;

  const id = String(btn.dataset.ack);

  // Find the notice so we know the current version
  const n = (noticesCache || []).find(x => String(x.id) === id);
  if (!n) {
    alert("Notice not found in cache. Reload and try again.");
    return;
  }

  try {
    btn.disabled = true;

    // Pass id + version
    await ackOneNotice(n.id, n.version);

    // Refresh local state + UI
await refreshNotices();
    renderAllNoticesList();

    // If that cleared blocking notices, close the blocking modal
    if (blockingNoticeIds.length === 0 && noticeUnreadModal?.style.display === "flex") {
      closeUnreadModal();
    }

    applyUnlockState();
  } catch (err) {
    console.error(err);
    alert("Failed to acknowledge notice.");
  } finally {
    btn.disabled = false;
  }
});


// Blocking modal: acknowledge ALL
noticeUnreadAcknowledge?.addEventListener("click", async () => {
  if (!blockingNoticeIds.length) return;

  try {
    noticeUnreadAcknowledge.disabled = true;

    // 1. Acknowledge all blocking notices
    for (const n of blockingNoticeIds){
      await ackOneNotice(n.id, n.version);
    }

    // 2. Re-fetch notices from DB
    const list = await fetchNoticesForMe();

    // 3. Recompute notice state (THIS CLEARS blockingNoticeIds)
    computeNoticeState(list);

    // 4. Update UI
    updateNoticeBell();
    closeUnreadModal();
    applyUnlockState();

  } catch (e) {
    console.error(e);
    alert("Failed to acknowledge notices.");
  } finally {
    noticeUnreadAcknowledge.disabled = false;
  }
});


/* =========================================================
   [ADMIN-USERS-1] ADMIN USERS CRUD (Add/Edit/Deactivate)
   ========================================================= */

let adminUsersCache = [];
let adminNoticesCache = [];
let editingNotice = null;
let adminEditingUserId = null;

async function loadAdminNotices(){
  if (!currentUser?.is_admin) return;

const { data, error } = await supabaseClient
  .from("notices")
  .select(`
    id,
    title,
    body_en,
    body_es,
    version,
    is_active,
    updated_at,
    created_by,
    target_all,
    target_roles,
    users:created_by ( name )
  `)
  .order("updated_at", { ascending: false });


  if (error){
    console.error(error);
    alert("Failed to load notices");
    return;
  }

  adminNoticesCache = data || [];

  // Fetch ack counts (batched RPC) and merge into cache
  try {
    const ids = (adminNoticesCache || []).map(n => n.id).filter(Boolean);
    if (ids.length) {
      const counts = await adminFetchNoticeAckCounts(ids);
      console.debug('adminNoticeCounts fetched', counts);
      const map = new Map((counts || []).map(r => [String(r.notice_id), { ack_count: Number(r.ack_count), ack_total: Number(r.ack_total) }]));
      adminNoticesCache.forEach(n => {
        const c = map.get(String(n.id));
        n.ack_count = c?.ack_count ?? 0;
        n.ack_total = c?.ack_total ?? 0;
      });
      console.debug('adminNoticesCache after merge', adminNoticesCache.map(n => ({id:n.id, ack_count:n.ack_count, ack_total:n.ack_total})));

      // Extra verification: sometimes the batched RPC can return 0 for ack_count
      // even though detailed ack lists show entries. For robustness, for any
      // notice where the server says there are recipients (ack_total > 0)
      // but the ack_count is zero, fetch the per-notice ack list and correct it.
      try {
        const verifyIds = (adminNoticesCache || []).filter(n => Number(n.ack_total) > 0 && (!n.ack_count || Number(n.ack_count) === 0)).map(n => n.id);
        if (verifyIds.length){
          for (const id of verifyIds){
            try {
              const { acked, pending } = await adminFetchNoticeAcks(id);
              const ac = Array.isArray(acked) ? acked.length : 0;
              const at = (Array.isArray(acked) ? acked.length : 0) + (Array.isArray(pending) ? pending.length : 0);
              updateAdminNoticeCountsForId(id, { ack_count: ac, ack_total: at });
            } catch (e){
              console.warn('verifyAdminCounts failed for', id, e);
            }
          }
          console.debug('verifyAdminCounts completed for', verifyIds);
        }
      } catch (e){
        console.warn('verifyAdminCounts overall error', e);
      }
    }
  } catch (err) {
    console.error('Failed to fetch notice ack counts', err);
  }

  renderAdminNotices();
}
function openAdminNoticeModal(){
  document.body.classList.add("modal-open");
  adminNoticeModal.style.display = "flex";
  adminNoticeModal.setAttribute("aria-hidden","false");
}

function closeAdminNoticeModal(){
  adminNoticeModal.style.display = "none";
  adminNoticeModal.setAttribute("aria-hidden","true");
  updateBodyModalOpen();
}

function clearNoticeEditor(){
  editingNotice = null;

  if (adminNoticeTitle) adminNoticeTitle.textContent = "New notice";
  if (adminNoticeTitleInput) adminNoticeTitleInput.value = "";
  if (quillEnglish) quillEnglish.setContents([]);
  if (quillSpanish) quillSpanish.setContents([]);

  if (noticeTargetAll) noticeTargetAll.checked = true;
  noticeRoleChks.forEach(chk => chk.checked = false);
}

function hydrateNoticeTargetsFromNotice(notice){
  // If your notices table stores target_roles as int[] and target_all as boolean
  const targetAll = !!notice.target_all;
  const roles = Array.isArray(notice.target_roles) ? notice.target_roles.map(Number) : [];

  if (noticeTargetAll) noticeTargetAll.checked = targetAll;
  noticeRoleChks.forEach(chk => {
    chk.checked = roles.includes(Number(chk.value));
  });
}

function readNoticeTargetsFromUI(){
  let targetAll = !!noticeTargetAll?.checked;
  const roles = noticeRoleChks
    .filter(chk => chk.checked)
    .map(chk => Number(chk.value))
    .filter(n => [1,2,3].includes(n));

  // If the admin selected specific roles, force target_all = false so the
  // notice is restricted to those roles only.
  if (roles.length > 0) targetAll = false;

  return { target_all: targetAll, target_roles: roles };
}

function openAdminNoticeEditor(notice){
  if (!currentUser?.is_admin) return;

  if (!notice){
    clearNoticeEditor();
    editingNotice = null;
    openAdminNoticeModal();
    return;
  }

  editingNotice = notice;

  if (adminNoticeTitle) adminNoticeTitle.textContent = "Edit notice";
  if (adminNoticeTitleInput) adminNoticeTitleInput.value = notice.title || "";
  
  // Load HTML into Quill editors
  if (quillEnglish) quillEnglish.root.innerHTML = notice.body_en || "";
  if (quillSpanish) quillSpanish.root.innerHTML = notice.body_es || "";

  hydrateNoticeTargetsFromNotice(notice);

  openAdminNoticeModal();
}
function renderAdminNotices(){
  if (!adminNoticesList) return;

  const q = (adminNoticeSearch?.value || "").trim().toLowerCase();
  const showInactive = !!adminShowInactiveNotices?.checked;

  let rows = adminNoticesCache.slice();
  if (!showInactive) rows = rows.filter(n => n.is_active !== false);
  if (q) rows = rows.filter(n => (n.title || "").toLowerCase().includes(q));

  if (!rows.length){
    adminNoticesList.innerHTML =
      `<div class="subtitle" style="padding:12px;">No notices.</div>`;
    return;
  }

  adminNoticesList.innerHTML = rows.map(n => {
    const createdBy = escapeHtml(n.users?.name || "Unknown");
    const when = n.updated_at
      ? new Date(n.updated_at).toLocaleDateString("en-GB")
      : "";

    const ackCount = n.ack_count ?? 0;
    const ackTotal = n.ack_total ?? 0;

    return `
      <div class="notice-row"
           data-id="${n.id}"
           style="padding:12px; border-bottom:1px solid #eee;">

        <!-- HEADER -->
        <div style="display:flex; gap:10px; align-items:flex-start;">
          <div style="flex:1; min-width:0;">
            <div style="font-weight:800;">${escapeHtml(n.title)}</div>

            <div style="font-size:11px; color:#667085; margin-top:4px;">
              v${n.version}
              ¬∑ ${createdBy}
              ¬∑ ${when}
              ${!n.is_active
                ? `<span class="notice-pill" style="margin-left:6px;">Inactive</span>`
                : ``}
            </div>
          </div>

          <div style="display:flex; gap:6px;">
            <button data-act="edit">Edit</button>
            <button data-act="toggle">${n.is_active ? "Hide" : "Unhide"}</button>
            <button data-act="delete">Delete</button>
          </div>
        </div>

        <!-- ACKNOWLEDGED BY (ADMIN ONLY) -->
        <div class="ack-summary" style="margin-top:8px;">
          <button type="button"
                  class="ghost"
                  data-ack-toggle="${n.id}"
                  style="padding:6px 10px; border-radius:999px; font-size:12px;">
            Acknowledged:
            <span data-ack-count="${n.id}">${ackCount ?? "‚Äî"}</span>
            <span class="muted"> / </span>
            <span data-ack-total="${n.id}">${ackTotal ?? "‚Äî"}</span>
            <span class="muted"> ¬∑ View</span>
          </button>

          <div id="ack-list-${n.id}"
               class="ack-list"
               style="display:none; margin-top:8px; padding:10px; border:1px solid #e5e7eb; border-radius:12px;">
            <div class="subtitle">Loading‚Ä¶</div>
          </div>
        </div>

      </div>
    `;
  }).join("");
}



async function adminUpsertNotice(payload){
  const pin = getSessionPinOrThrow();

  // Enforce: if roles are supplied we treat this as targeted (target_all=false).
  const targetRoles = Array.isArray(payload.target_roles) ? payload.target_roles : [];
  const targetAll = !!payload.target_all && targetRoles.length === 0;

  const { data, error } = await supabaseClient.rpc("admin_upsert_notice", {
    p_admin_id: currentUser.id,
    p_pin: pin,
    p_notice_id: payload.id || null,
    p_title: payload.title,
    p_body_en: payload.body_en,
    p_body_es: payload.body_es,
    p_target_all: targetAll,
    p_target_roles: targetRoles
  });

  if (error) throw error;
  return data; // notice id
}

async function toggleAdminNoticeActive(notice){
  const pin = getSessionPinOrThrow();

  const next = (notice.is_active === false) ? true : false;
  const ok = confirm(`${next ? "Unhide" : "Hide"} "${notice.title}"?`);
  if (!ok) return;

  const { error } = await supabaseClient.rpc("admin_set_notice_active", {
    p_admin_id: currentUser.id,
    p_pin: pin,
    p_notice_id: notice.id,
    p_active: next
  });

  if (error) throw error;

  await loadAdminNotices();
}

async function deleteAdminNotice(notice){
  const pin = getSessionPinOrThrow();

  const ok = confirm(`Delete "${notice.title}"?\n\nThis cannot be undone.`);
  if (!ok) return;

  const { error } = await supabaseClient.rpc("admin_delete_notice", {
    p_admin_id: currentUser.id,
    p_pin: pin,
    p_notice_id: notice.id
  });

  if (error) throw error;

  await loadAdminNotices();
}


async function loadAdminUsers(){
  if (!adminUsersList) return;

  adminUsersList.textContent = "Loading users‚Ä¶";

  const { data, error } = await supabaseClient
    .from("users")
    .select("id, name, role_id, is_admin, is_active, display_order, roles(name)")
    .order("role_id", { ascending: true })
    .order("display_order", { ascending: true })
    .order("created_at", { ascending: true })

  if (error) {
    console.error(error);
    adminUsersList.textContent = "Failed to load users.";
    return;
  }

  adminUsersCache = data || [];
  renderAdminUsers();
}

function renderAdminUsers(){
  if (!adminUsersList) return;

  const q = (adminUserSearch?.value || "").trim().toLowerCase();
  const showInactive = !!adminShowInactiveUsers?.checked;

  let rows = adminUsersCache.slice();
  if (!showInactive) rows = rows.filter(u => u.is_active !== false);
  if (q) rows = rows.filter(u => (u.name || "").toLowerCase().includes(q));

  if (!rows.length){
    adminUsersList.innerHTML = `<div class="subtitle" style="margin-top:8px;">No users.</div>`;
    return;
  }

  const groups = [
    { title: "Charge Nurses", role_id: 1 },
    { title: "Staff Nurses", role_id: 2 },
    { title: "Nursing Assistants", role_id: 3 },
  ];

  const html = [];

  for (const g of groups){
    const members = rows.filter(u => Number(u.role_id) === g.role_id);
    if (!members.length) continue;

    html.push(`<div class="user-group-title">${g.title}</div>`);

    html.push(members.map(u => {
      return `
        <div class="user-row" draggable="true" data-user-id="${u.id}" data-role-id="${g.role_id}">
          <div class="drag-handle" title="Drag to reorder">‚Üï</div>
          <div class="user-meta">
            <div class="user-name">
              ${escapeHtml(u.name || "")}
              ${u.is_admin ? `<span class="user-tag admin">admin</span>` : ""}
              ${u.is_active === false ? `<span class="user-tag inactive">inactive</span>` : ""}
            </div>
          </div>

          <div class="user-actions">
            <button type="button" data-act="edit" data-id="${u.id}">Edit</button>
            <button type="button" data-act="toggle" data-id="${u.id}">
              ${u.is_active === false ? "Reactivate" : "Deactivate"}
            </button>
          </div>
        </div>
      `;
    }).join(""));
  }

  adminUsersList.innerHTML = html.join("");
}
function clearUserEditor(){
  adminEditingUserId = null;
  if (adminEditUserName) adminEditUserName.value = "";
  if (adminEditUserRole) adminEditUserRole.value = "2";
  if (adminEditUserPin)  adminEditUserPin.value = "";
  if (adminUserEditHelp) adminUserEditHelp.textContent = "Fill details and click Save.";
}

function startEditUser(userId){
  const u = adminUsersCache.find(x => x.id === userId);
  if (!u) return;

  adminEditingUserId = u.id;
  adminEditUserName.value = u.name || "";
  adminEditUserRole.value = String(u.role_id || 2);
  adminEditUserPin.value = "";
  adminUserEditHelp.textContent = "Leave PIN blank to keep current PIN.";
  
  // Scroll to the edit form
  const editSection = document.getElementById("adminUserEditSection");
  if (editSection) {
    editSection.scrollIntoView({ behavior: "smooth", block: "nearest" });
  }
}

async function toggleUserActive(userId){
  const u = adminUsersCache.find(x => x.id === userId);
  if (!u) return;

  const next = (u.is_active === false) ? true : false;
  const ok = confirm(`${next ? "Reactivate" : "Deactivate"} ${u.name}?`);
  if (!ok) return;

  const pin = getSessionPinOrThrow(); // üîë THIS WAS MISSING

  const { error } = await supabaseClient.rpc("set_user_active", {
    p_admin_id: currentUser.id,
    p_pin: pin,
    p_user_id: userId,
    p_active: next
  });

  if (error){
    console.error(error);
    alert("Update failed.");
    return;
  }

  await loadRota();
  await loadAdminUsers();
}

// Drag-and-drop functionality for user reordering
let draggedElement = null;
let draggedUserId = null;
let draggedRoleId = null;

adminUsersList?.addEventListener('dragstart', (e) => {
  const userRow = e.target.closest('.user-row[draggable="true"]');
  if (!userRow) return;
  
  draggedElement = userRow;
  draggedUserId = userRow.dataset.userId;
  draggedRoleId = userRow.dataset.roleId;
  userRow.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
});

adminUsersList?.addEventListener('dragend', (e) => {
  const userRow = e.target.closest('.user-row');
  if (userRow) {
    userRow.classList.remove('dragging');
  }
  document.querySelectorAll('.user-row').forEach(row => row.classList.remove('drag-over'));
  draggedElement = null;
  draggedUserId = null;
  draggedRoleId = null;
});

adminUsersList?.addEventListener('dragover', (e) => {
  e.preventDefault();
  const userRow = e.target.closest('.user-row[draggable="true"]');
  if (!userRow || !draggedElement) return;
  
  // Only allow dropping within the same role group
  if (userRow.dataset.roleId !== draggedRoleId) return;
  if (userRow === draggedElement) return;
  
  e.dataTransfer.dropEffect = 'move';
  
  // Remove drag-over from all rows
  document.querySelectorAll('.user-row').forEach(row => row.classList.remove('drag-over'));
  userRow.classList.add('drag-over');
});

adminUsersList?.addEventListener('drop', async (e) => {
  e.preventDefault();
  const targetRow = e.target.closest('.user-row[draggable="true"]');
  if (!targetRow || !draggedElement) return;
  
  // Only allow dropping within the same role group
  if (targetRow.dataset.roleId !== draggedRoleId) return;
  if (targetRow === draggedElement) return;
  
  targetRow.classList.remove('drag-over');
  
  // Get all user rows in this role group
  const allRows = Array.from(adminUsersList.querySelectorAll(`.user-row[data-role-id="${draggedRoleId}"]`));
  const draggedIndex = allRows.indexOf(draggedElement);
  const targetIndex = allRows.indexOf(targetRow);
  
  if (draggedIndex < targetIndex) {
    targetRow.parentNode.insertBefore(draggedElement, targetRow.nextSibling);
  } else {
    targetRow.parentNode.insertBefore(draggedElement, targetRow);
  }
  
  // Update display_order in database
  await updateUserDisplayOrder(draggedRoleId);
});

async function updateUserDisplayOrder(roleId) {
  try {
    // Get all user rows for this role in current DOM order
    const rows = Array.from(adminUsersList.querySelectorAll(`.user-row[data-role-id="${roleId}"]`));
    
    console.log('Updating order for role:', roleId);
    console.log('Found rows:', rows.length);
    
    // Update each user's display_order
    for (let i = 0; i < rows.length; i++) {
      const userId = rows[i].dataset.userId;
      console.log(`Updating user ${userId} to display_order ${i + 1}`);
      
      const { data, error } = await supabaseClient
        .from('users')
        .update({ display_order: i + 1 })
        .eq('id', userId)
        .select();
      
      if (error) {
        console.error('Failed to update display_order:', error);
        alert(`Failed to save new order: ${error.message}`);
        return;
      }
      console.log('Update result:', data);
    }
    
    console.log('All updates successful, reloading...');
    
    // Reload to show new order
    await loadAdminUsers();
    await loadRota();
  } catch (error) {
    console.error('Error updating user order:', error);
    alert(`Failed to save new order: ${error.message}`);
  }
}


/* =========================================================
   [ADMIN-USERS-2] Wire UI events for Users tab
   ========================================================= */

adminUserSearch?.addEventListener("input", renderAdminUsers);
adminShowInactiveUsers?.addEventListener("change", renderAdminUsers);

adminUsersList?.addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-act]");
  if (!btn) return;

  const id = btn.dataset.id;
  const act = btn.dataset.act;

  if (act === "edit") startEditUser(id);
  if (act === "toggle") toggleUserActive(id);
});

adminAddUserBtn?.addEventListener("click", clearUserEditor);
adminCancelUserEditBtn?.addEventListener("click", clearUserEditor);

adminNoticesList?.addEventListener("click", async (e) => {
  // Handle "Acknowledged: View" toggles
  const ackBtn = e.target.closest("[data-ack-toggle]");
  if (ackBtn) {
    e.preventDefault();

    const noticeId = ackBtn.dataset.ackToggle;
    const box = document.getElementById(`ack-list-${noticeId}`);
    if (!box) return;

    const isOpen = box.style.display === "block";
    box.style.display = isOpen ? "none" : "block";

    // keep aria in sync
    if (ackBtn && ackBtn.setAttribute) ackBtn.setAttribute('aria-expanded', String(!isOpen));

    if (isOpen) return;

    // already loaded once
    if (box.dataset.loaded === "1") return;

    box.innerHTML = `<div class="subtitle">Loading‚Ä¶</div>`;

    try {
      const rows = await fetchNoticeAcksForAdmin(noticeId);

      if (!rows.length) {
        box.innerHTML = `<div class="subtitle">Nobody yet.</div>`;
      } else {
        box.innerHTML = `
          <div style="display:flex; flex-wrap:wrap; gap:8px;">
            ${rows.map(r => `
              <span class="ack-pill"
                    style="padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; font-size:12px;">
                ${escapeHtml(r.name || "Unknown")}
                <span class="muted" style="margin-left:6px;">
                  ${r.acknowledged_at
                    ? new Date(r.acknowledged_at).toLocaleString("en-GB")
                    : ""}
                </span>
              </span>
            `).join("")}
          </div>
        `;

        // Defensive: if the count shown is wrong, update it to the number of rows
        try {
          const countSpan = document.querySelector(`[data-ack-count="${noticeId}"]`);
          if (countSpan && Number(countSpan.textContent) !== rows.length) {
            console.debug('Mismatch detected: fixing ack count for', noticeId, 'to', rows.length);
            countSpan.textContent = String(rows.length);
            // update cache too
            const noticeObj = adminNoticesCache.find(n => String(n.id) === String(noticeId));
            if (noticeObj) noticeObj.ack_count = rows.length;
          }
        } catch (e) { console.warn('failed to update count fallback', e); }
      }

      box.dataset.loaded = "1";
    } catch (err) {
      console.error(err);
      box.innerHTML = `<div class="subtitle">Failed to load.</div>`;
    }

    return;
  }

  // Handle admin action buttons (Edit / Hide / Delete)
  const btn = e.target.closest("button[data-act]");
  if (!btn) return;

  const act = btn.dataset.act;
  const row = btn.closest('.notice-row');
  const id = row?.dataset.id;
  const notice = adminNoticesCache.find(n => String(n.id) === String(id));
  if (!notice) return;

  try {
    btn.disabled = true;

    if (act === 'edit') {
      openAdminNoticeEditor(notice);
    } else if (act === 'toggle') {
      await toggleAdminNoticeActive(notice);
    } else if (act === 'delete') {
      await deleteAdminNotice(notice);
    }
  } catch (err) {
    console.error(err);
    alert("Action failed. Check console.");
  } finally {
    btn.disabled = false;
  }
});


adminNoticeSave?.addEventListener("click", async () => {
  if (!currentUser?.is_admin) return;

  const title = (adminNoticeTitleInput?.value || "").trim();
  const bodyEn = (quillEnglish?.root.innerHTML || "").trim();
  const bodyEs = (quillSpanish?.root.innerHTML || "").trim();
  

  if (!title) return alert("Title is required.");
  if (!bodyEn) return alert("English body is required.");

  const targets = readNoticeTargetsFromUI();

  try {
    adminNoticeSave.disabled = true;

    await adminUpsertNotice({
      id: editingNotice?.id || null,
      title,
      body_en: bodyEn,
      body_es: bodyEs || null,
      target_all: targets.target_all,
      target_roles: targets.target_roles
    });

    closeAdminNoticeModal();
    editingNotice = null;

    await loadAdminNotices();
    alert("Notice saved.");

  } catch (e) {
    console.error(e);
    alert("Failed to save notice. Check console.");
  } finally {
    adminNoticeSave.disabled = false;
  }
});

adminAddNoticeBtn?.addEventListener("click", () => {
  openAdminNoticeEditor(null);
});

adminNoticeCancel?.addEventListener("click", closeAdminNoticeModal);

adminNoticeModal?.addEventListener("click", (e) => {
  if (e.target === adminNoticeModal) closeAdminNoticeModal();
});

// Search + show inactive (client-side filter)
adminNoticeSearch?.addEventListener("input", renderAdminNotices);
adminShowInactiveNotices?.addEventListener("change", renderAdminNotices);

// Target UI convenience: if "All users" checked, clear role checks
noticeTargetAll?.addEventListener("change", () => {
  if (noticeTargetAll.checked){
    noticeRoleChks.forEach(chk => chk.checked = false);
  }
});

// If any role checkbox checked, uncheck "All users"
noticeRoleChks.forEach(chk => {
  chk.addEventListener("change", () => {
    if (chk.checked && noticeTargetAll) noticeTargetAll.checked = false;
  });
});

/* =========================================================
   [ADMIN-USERS-3] Save user (insert/update + optional PIN)
   ========================================================= */

adminSaveUserBtn?.addEventListener("click", async () => {
  const name = adminEditUserName.value.trim();
  const role_id = Number(adminEditUserRole.value);
  const pin = (adminEditUserPin.value || "").trim();

  if (!name) return alert("Name is required.");
  if (![1,2,3].includes(role_id)) return alert("Role invalid.");
  if (pin && !/^\d{4}$/.test(pin)) return alert("PIN must be 4 digits.");

  try {
    const { data: userId, error } = await supabaseClient.rpc("admin_upsert_user", {
      p_user_id: adminEditingUserId, // null = add
      p_name: name,
      p_role_id: role_id
    });
    if (error) throw error;

    if (pin) await adminSetUserPin(userId, pin);

    await loadRota();
    await loadAdminUsers();
    clearUserEditor();
    alert("Saved.");
  } catch (e) {
    console.error(e);
    alert("Save failed. Check console.");
  }
});

/* =========================================================
   [ADMIN-USERS-4] PIN setter via RPC (recommended)
   ========================================================= */
async function adminSetUserPin(userId, pin){
  const { error } = await supabaseClient.rpc("set_user_pin", {
    p_user_id: userId,
    p_pin: pin
  });
  if (error) throw error;
}

/* =========================
   ADMIN PERIODS (v2 dropdown)
   ========================= */

if (adminPeriodSelect) {
  adminPeriodSelect.addEventListener("change", async () => {
    adminSelectedPeriodId = adminPeriodSelect.value;
    renderAdminPeriodMeta(adminSelectedPeriodId);
    renderAdminCloseTime(adminSelectedPeriodId); 
    await loadAdminWeeks(adminSelectedPeriodId);
  });
}

if (adminSetActiveBtn) {
  adminSetActiveBtn.addEventListener("click", async () => {
    if (!adminSelectedPeriodId) return;
    try {
      await setActivePeriod(adminSelectedPeriodId);
      await loadRota(); // refresh main view
      await loadAdminPeriodsForDropdown(); // refresh admin UI
      renderAdminCloseTime(adminSelectedPeriodId)
    } catch (e) {
      console.error(e);
      alert("Set active failed. Check console.");
    }
  });
}

if (adminToggleHiddenBtn) {
  adminToggleHiddenBtn.addEventListener("click", async () => {
    if (!adminSelectedPeriodId) return;
    try {
      await toggleHiddenPeriod(adminSelectedPeriodId);
      await loadRota(); // refresh main view
      await loadAdminPeriodsForDropdown(); // refresh admin UI
    } catch (e) {
      console.error(e);
      alert("Toggle hidden failed. Check console.");
    }
  });
}

async function loadAdminPeriodsForDropdown(){
  if (!adminPeriodSelect) return;

  adminPeriodMeta.textContent = "Loading‚Ä¶";
  adminWeeksList.textContent = "Loading‚Ä¶";

  let periods;
  try {
    periods = await fetchRotaPeriods(); // admin sees all
  } catch (e) {
    console.error(e);
    adminPeriodMeta.textContent = "Failed to load periods.";
    adminWeeksList.textContent = "Failed to load weeks.";
    return;
  }

  periodsCache = periods;

  // Fill dropdown
  adminPeriodSelect.innerHTML = "";
  for (const p of periods){
    const opt = document.createElement("option");
    opt.value = p.id;
    const s = fmt(new Date(p.start_date));
    const e = fmt(new Date(p.end_date));
    opt.textContent = `${s} ‚Äì ${e}${p.is_active ? " ‚òÖ" : ""}${p.is_hidden ? " (hidden)" : ""}`;
    adminPeriodSelect.appendChild(opt);
  }

  // Default selection
  if (!adminSelectedPeriodId) {
    const active = periods.find(p => p.is_active) || periods[periods.length - 1];
    adminSelectedPeriodId = active?.id || periods[0]?.id;
  }

  adminPeriodSelect.value = String(adminSelectedPeriodId);

  renderAdminPeriodMeta(adminSelectedPeriodId);
  await loadAdminWeeks(adminSelectedPeriodId);
  renderAdminCloseTime(adminSelectedPeriodId);
}

function renderAdminPeriodMeta(periodId){
  const p = periodsCache.find(x => String(x.id) === String(periodId));
  if (!p){
    adminPeriodMeta.textContent = "";
    return;
  }

  const bits = [];
  if (p.is_active) bits.push("‚úÖ Active");
  if (p.is_hidden) bits.push("üôà Hidden");
  adminPeriodMeta.textContent = bits.join(" ¬∑ ") || "‚Äî";
}

async function loadAdminWeeks(periodId){
  adminWeeksList.textContent = "Loading weeks‚Ä¶";

  // Pull all dates for the period, but we only need them to discover the weeks + open state
  const { data, error } = await supabaseClient
    .from("rota_dates")
.select("date, week_id, period_id, rota_weeks(id, open, open_after_close)")
    .eq("period_id", periodId)
    .order("date");

  if (error) {
    console.error(error);
    adminWeeksList.textContent = "Failed to load weeks.";
    return;
  }

  // Build unique weeks list from rota_dates (because rota_weeks doesn't have period_id)
const weekMap = new Map();

for (const row of (data || [])) {
  const w = row.rota_weeks;
  if (!w?.id) continue;

  // Compute week start/end from the date in rota_dates
  const ws = startOfWeekSunday(new Date(row.date));
  const we = addDays(ws, 6);

  if (!weekMap.has(w.id)) {
    weekMap.set(w.id, {
      weekId: w.id,
      open: !!w.open,
      openAfterClose: !!w.open_after_close,
      weekStart: ws,
      weekEnd: we
    });
  } else {
    const existing = weekMap.get(w.id);

    // Keep flags consistent (safety: if any row says closed, treat as closed)
    existing.open = existing.open && !!w.open;
    existing.openAfterClose = existing.openAfterClose && !!w.open_after_close;

    // Expand bounds in case of weird data ordering
    if (ws < existing.weekStart) existing.weekStart = ws;
    if (we > existing.weekEnd) existing.weekEnd = we;
  }
}

const weeks = [...weekMap.values()].sort((a,b) => a.weekStart - b.weekStart);


  if (!weeks.length){
    adminWeeksList.textContent = "No weeks found for this period.";
    return;
  }

  // Period lock (deadline)
  const p = periodsCache.find(x => String(x.id) === String(periodId));
  const periodClosed = isPeriodClosed(p);

  adminWeeksList.innerHTML = weeks.map(w => {
    const s = fmt(w.weekStart);
    const e = fmt(w.weekEnd);
   const isOpen = periodClosed ? !!w.openAfterClose : !!w.open;


    const pill = isOpen
      ? `<span style="display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:800; background:#e9fff0; border:1px solid #9fe0b1; color:#0b6b2b;">OPEN</span>`
      : `<span style="display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:800; background:#ffecec; border:1px solid #ffb3b3; color:#8a1f1f;">CLOSED</span>`;

const lockNote = `
  <div style="margin-top:4px; font-size:11px; color:#666;">
   ${isOpen ? "Requests open for staff" : "Requests locked for staff"} 
${periodClosed ? "(after close time)" : "(before close time)"}
  </div>
`;


    const btnText = isOpen ? "Close week" : "Open week";

    return `
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid #eee;">
        <div>
          <div style="font-weight:800;">${s} ‚Äì ${e}</div>
          <div style="margin-top:4px;">${pill}</div>
          ${lockNote}
        </div>

        <button type="button"
  class="week-toggle-btn"
  data-week-id="${w.weekId}"
  data-open="${w.open ? "1" : "0"}"
  data-open-after-close="${w.openAfterClose ? "1" : "0"}"
  data-period-closed="${periodClosed ? "1" : "0"}"
>
          ${btnText}
        </button>
      </div>
    `;
  }).join("");

// Bind toggles (admins can still manage weeks regardless of period close)
adminWeeksList.querySelectorAll("button[data-week-id]").forEach(btn => {
  btn.addEventListener("click", async () => {
    if (!currentUser?.is_admin) return;

    const pin = getSessionPinOrThrow();
    const weekId = btn.dataset.weekId;

    const open = btn.dataset.open === "1";
    const openAfterClose = btn.dataset.openAfterClose === "1";
    const periodClosed = btn.dataset.periodClosed === "1";

// ‚úÖ Toggle the correct flag depending on whether period is closed
let nextOpen = open;
let nextOpenAfterClose = openAfterClose;

if (periodClosed) {
  nextOpenAfterClose = !openAfterClose;  // after deadline behavior
} else {
  nextOpen = !open;                      // normal behavior
}
    try {
      const { error } = await supabaseClient.rpc("admin_set_week_open_flags", {
        p_admin_id: currentUser.id,
        p_pin: pin,
        p_week_id: weekId,
        p_open: nextOpen,
        p_open_after_close: nextOpenAfterClose
      });
      if (error) throw error;

      await loadRota();
      await loadAdminWeeks(periodId); 
    } catch (e) {
      console.error(e);
      alert("Failed to toggle week. Check console.");
    }
  });
});
 }
/* =========================
   ADMIN PERIOD ACTIONS (v1)
   ========================= */
  
async function setActivePeriod(periodId){
  const pin = getSessionPinOrThrow();

  const { error } = await supabaseClient.rpc("admin_set_active_period", {
    p_admin_id: currentUser.id,
    p_pin: pin,
    p_period_id: periodId
  });

  if (error) throw error;
  activePeriodId = periodId;
}
    
async function toggleHiddenPeriod(periodId){
  if (!currentUser?.is_admin) throw new Error("Admin only.");
  const pin = getSessionPinOrThrow();

  const { error } = await supabaseClient.rpc("admin_toggle_hidden_period", {
    p_admin_id: currentUser.id,
    p_pin: pin,
    p_period_id: periodId
  });

  if (error) throw error;
}
// create 5 week period 

async function generateNextFiveWeekPeriod(){
  if (!currentUser?.is_admin) throw new Error("Admin only.");

  const pin = getSessionPinOrThrow();
  const r = computeNextPeriodRange();
  if (!r) throw new Error("No existing periods.");

  const startStr = isoDate(r.start);
  const endStr   = isoDate(r.end);
  const periodName = `${fmt(r.start)} ‚Äì ${fmt(r.end)}`;

  // 1Ô∏è‚É£ create period + weeks + dates server-side
  const { data: periodId, error } = await supabaseClient.rpc(
    "admin_create_five_week_period",
    {
      p_admin_id: currentUser.id,
      p_pin: pin,
      p_name: periodName,
      p_start_date: startStr,
      p_end_date: endStr
    }
  );

  if (error) throw error;

  // ‚úÖ return UUID only
  return periodId;
}



/* =========================
   ADMIN GENERATE PREVIEW
   ========================= */
function computeNextPeriodRange(){
  if (!periodsCache?.length) return null;

const latest = [...periodsCache]
  .sort((a,b) => new Date(a.end_date) - new Date(b.end_date))
  .at(-1);

  if (!latest?.end_date) return null;

  const lastEnd = new Date(latest.end_date);

  let start = addDays(lastEnd, 1);
  while (start.getDay() !== 0) start = addDays(start, 1);

  const end = addDays(start, 34);
  return { start, end, latest };
}

function refreshGeneratePreview(){
  const r = computeNextPeriodRange();
  if (!r){
    adminGeneratePreview.textContent = "Cannot preview. No periods loaded.";
    return;
  }

  adminGeneratePreview.textContent =
    `Next period: ${fmt(r.start)} ‚Äì ${fmt(r.end)} (5 weeks, Sun‚ÄìSat).`;
}

if (adminGenerateBtn) {
  adminGenerateBtn.addEventListener("click", async () => {
    try {
      const r = computeNextPeriodRange();
      if (!r) {
        alert("Cannot generate: no periods loaded.");
        return;
      }

      const ok = confirm(`Generate new 5-week period:\n${fmt(r.start)} ‚Äì ${fmt(r.end)} ?`);
      if (!ok) return;

      adminGenerateBtn.disabled = true;
      adminGeneratePreview.textContent = "Generating‚Ä¶";

      // ‚úÖ RPC returns a UUID (string), not a period object
      const newPeriodId = await generateNextFiveWeekPeriod();

      // Refresh caches + UI
      await loadRota();
      await loadAdminPeriodsForDropdown();
      refreshGeneratePreview();

      // Select the new period everywhere
      adminSelectedPeriodId = newPeriodId;
      activePeriodId = newPeriodId;

      // Optional: auto-set active so staff see it immediately
  // await setActivePeriod(newPeriodId); // only activate when ready

      // Refresh again so ‚òÖ active + dropdown state update
      await loadRota();
      await loadAdminPeriodsForDropdown();

      alert("Generated new 5-week period.");
    } catch (e) {
      console.error(e);

      const msg =
        e?.message ||
        e?.details ||
        e?.hint ||
        (e?.error && (e.error.message || e.error.details)) ||
        JSON.stringify(e, null, 2);

      alert("Generate failed:\n\n" + msg);
    } finally {
      adminGenerateBtn.disabled = false;
      // nice-to-have: restore preview if generation failed
      refreshGeneratePreview();
    }
  });
}


async function setPeriodCloseTime(periodId, closesAtIsoOrNull){
  const pin = getSessionPinOrThrow();

  const { error } = await supabaseClient.rpc("admin_set_period_closes_at", {
    p_admin_id: currentUser.id,
    p_pin: pin,
    p_period_id: periodId,
    p_closes_at: closesAtIsoOrNull
  });

  if (error) throw error;
}

    // OPTIONAL BASELINE RESET HELPERS

async function resetWeeksAfterClose(periodId){
  if (!currentUser?.is_admin) { alert("Admin only."); return; }
  const { data: wkRows, error: wkErr } = await supabaseClient
    .from("rota_dates")
    .select("week_id")
    .eq("period_id", periodId);

  if (wkErr) throw wkErr;

  const weekIds = [...new Set((wkRows || []).map(r => r.week_id).filter(Boolean))];
  if (!weekIds.length) return;

  const { error: resetErr } = await supabaseClient
    .from("rota_weeks")
    .update({ open_after_close: false })
    .in("id", weekIds);

  if (resetErr) throw resetErr;
}
    async function resetWeeksOpen(periodId){
  if (!currentUser?.is_admin) { alert("Admin only."); return; }

  const { data: wkRows, error: wkErr } = await supabaseClient
    .from("rota_dates")
    .select("week_id")
    .eq("period_id", periodId);

  if (wkErr) throw wkErr;

  const weekIds = [...new Set((wkRows || []).map(r => r.week_id).filter(Boolean))];
  if (!weekIds.length) return;

  const { error: resetErr } = await supabaseClient
    .from("rota_weeks")
    .update({ open: true })
    .in("id", weekIds);

  if (resetErr) throw resetErr;
}

async function resetWeeksDefaultForPeriod(periodId){
  if (!currentUser?.is_admin) { alert("Admin only."); return; }
  const { data: wkRows, error: wkErr } = await supabaseClient
    .from("rota_dates")
    .select("week_id")
    .eq("period_id", periodId);

  if (wkErr) throw wkErr;

  const weekIds = [...new Set((wkRows || []).map(r => r.week_id).filter(Boolean))];
  if (!weekIds.length) return;

  const { error: resetErr } = await supabaseClient
    .from("rota_weeks")
    .update({ open: true, open_after_close: false })
    .in("id", weekIds);

  if (resetErr) throw resetErr;
}

if (adminClosesAtSaveBtn) {
  adminClosesAtSaveBtn.addEventListener("click", async () => {
    if (!adminSelectedPeriodId) return alert("Pick a rota period first.");
    if (!adminClosesAtInput?.value) return alert("Pick a date/time first.");

    try {
      const iso = datetimeLocalToISOString(adminClosesAtInput.value);

      await setPeriodCloseTime(adminSelectedPeriodId, iso);

      // ‚úÖ close time should slam all 5 weeks shut by default
      await resetWeeksAfterClose(adminSelectedPeriodId);

      await loadRota(); // refresh main
      await loadAdminPeriodsForDropdown(); // refresh admin cache + UI
      alert("Close time saved.");
    } catch (e) {
      console.error(e);
      alert("Failed to save close time. Check console.");
    }
  });
}

if (adminClosesAtClearBtn) {
  adminClosesAtClearBtn.addEventListener("click", async () => {
    if (!adminSelectedPeriodId) return alert("Pick a rota period first.");

    try {
      await setPeriodCloseTime(adminSelectedPeriodId, null);

      // Optional: when you clear the close time, reopen everything by default
      
 await resetWeeksAfterClose(adminSelectedPeriodId);
await resetWeeksOpen(adminSelectedPeriodId);
      await loadRota();
      await loadAdminPeriodsForDropdown();
      alert("Close time cleared.");
    } catch (e) {
      console.error(e);
      alert("Failed to clear close time. Check console.");
    }
  });
}

    /* =========================================================
       5) PIN MODAL (open/close)
       ========================================================= */
function openPinModal(user){
  selectedUser = user;

  // pick language based on the person you're logging in as
  setLang(user.preferred_lang || "en");

  pinTitle.textContent = t("pinTitle", user.name);
  pinDesc.textContent  = t("pinDesc");

  pinErr.style.display = "none";
  pinInput.value = "";

  document.body.classList.add("modal-open");
  modal.style.display = "flex";
  modal.setAttribute("aria-hidden", "false");
  setTimeout(() => pinInput.focus(), 50);
}

function closePinModal(){
  modal.style.display = "none";
  modal.setAttribute("aria-hidden", "true");

updateBodyModalOpen();


  selectedUser = null;
  pinConfirmBtn.disabled = false;
}
    
pinCancelBtn.addEventListener("click", closePinModal);
modal.addEventListener("click", (e) => { if(e.target === modal) closePinModal(); });

pinInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    pinConfirmBtn.click();
  }
});

    /* =========================================================
       6) AUTH (verify PIN via RPC)
       ========================================================= */
    pinConfirmBtn.addEventListener("click", async () => {
      const pin = pinInput.value.trim();
      if(!selectedUser) return;

 if(!/^\d{4}$/.test(pin)){
  pinErr.textContent = t("pinErrFormat");
  pinErr.style.display = "block";
  return;
}

      pinConfirmBtn.disabled = true;
      pinErr.style.display = "none";

      try{
        const { data: ok, error } = await supabaseClient.rpc("verify_user_pin", {
          p_user_id: selectedUser.id,
          p_pin: pin
        });

        if(error){
          console.error("RPC error:", error);
          pinErr.textContent = "Server error (RPC).";
          pinErr.style.display = "block";
          pinConfirmBtn.disabled = false;
          return;
        }

if(ok !== true){
  pinErr.textContent = t("pinErrWrong");
  pinErr.style.display = "block";
  pinConfirmBtn.disabled = false;
  return;
}

  currentUser = selectedUser;
setSessionPin(selectedUser.id, pin); // ‚úÖ critical (used for saving requests)
localStorage.setItem(STORAGE_KEY, currentUser.id);

await loadUserPermissions();

closePinModal();
applyLanguage();
applyUnlockState();
updateBadges();
updateCloseLabel(activePeriodObj);
refreshNoticesAndMaybeBlock();


      }catch(err){
        console.error("Login exception:", err);
        pinErr.textContent = "Login error. Try again.";
        pinErr.style.display = "block";
        pinConfirmBtn.disabled = false;
      }
    });
function updateBadges(){
  const txt = loginBadge?.querySelector(".acc-txt");

  if (!currentUser){
 if (txt) txt.textContent = t("notLoggedIn");

    else if (loginBadge) loginBadge.textContent = "Not logged in";
    if (adminBadge) adminBadge.style.display = "none";
    if (printBtn) printBtn.style.display = "none";
    return;
  }

  // Show "Account: Name" so staff realise it's a feature
if (txt) txt.textContent = `${t("accountEditTitle")}: ${currentUser.name}`;

  else if (loginBadge) loginBadge.textContent = `Account: ${currentUser.name}`;

  if (adminBadge) adminBadge.style.display = currentUser.is_admin ? "inline-block" : "none";

  // Show print button only for admins
  if (printBtn) printBtn.style.display = currentUser.is_admin ? "inline-block" : "none";

  // Toggle a body-level class so we can scope admin-only UI affordances (e.g. locked-cell highlight)
  try {
    document.body.classList.toggle("admin-view", !!currentUser?.is_admin);
    // Re-apply unlock state so per-td `locked-admin` classes are correctly toggled
    if (typeof applyUnlockState === 'function') applyUnlockState();
  } catch (e) { /* ignore */ }
}

  // DO NOT touch adminViewUsers here.
  // Tab visibility is handled by showAdminTab().


/* =========================================================
   PATCH 2) SHIFT PICKER LOGIC (with OFF priority)
   ========================================================= */

function openShiftModal(){
  if (!activeCell) return;

  // Admin-only: show lock button and paint state
  if (shiftLockBtn) {
    const isAdmin = !!currentUser?.is_admin;
    shiftLockBtn.style.display = isAdmin ? "inline-flex" : "none";

    if (isAdmin) {
      const key = `${activeCell.userId}_${activeCell.date}`;
      const locked = locksCache.has(key);
      shiftLockBtn.textContent = locked ? "üîí" : "üîì";
      shiftLockBtn.title = locked ? "Unlock this cell" : "Lock this cell";
    }
  }

  // Admin-only: show L button
  const shiftBtnL = document.getElementById('shiftBtnL');
  if (shiftBtnL) {
    shiftBtnL.style.display = currentUser?.is_admin ? "block" : "none";
  }

  document.body.classList.add("modal-open");
  shiftModal.style.display = "flex";
  shiftModal.setAttribute("aria-hidden", "false");
}

function closeShiftModal(){
  document.activeElement?.blur?.();
  shiftModal.style.display = "none";
  shiftModal.setAttribute("aria-hidden", "true");
  activeCell = null;
  updateBodyModalOpen();
}

// ===============================
// FIX 1: Shift modal close actions
// ===============================

// Cancel button closes
if (shiftCancelBtn) shiftCancelBtn.addEventListener("click", closeShiftModal);

// Clicking the backdrop closes (only if you clicked the overlay itself)
if (shiftModal) {
  shiftModal.addEventListener("click", (e) => {
    if (e.target === shiftModal) closeShiftModal();
  });
}

// Escape closes (only add ONCE globally)
document.addEventListener("keydown", (e) => {
  if (e.key !== "Escape") return;

  if (shiftHelpModal && shiftHelpModal.style.display === "flex") closeShiftHelpModal();
  if (shiftModal && shiftModal.style.display === "flex") closeShiftModal();
  if (modal && modal.style.display === "flex") closePinModal();
  if (weekCommentModal && weekCommentModal.style.display === "flex") closeWeekCommentModal();
  if (adminModal && adminModal.style.display === "flex") closeAdminConsole();
  if (userModal && userModal.style.display === "flex") closeUserModal();
});

/* =========================================================
   SHIFT PICKER: Dynamic shift grid population
   ========================================================= */

async function populateShiftGrid(){
  try {
    const { data: shifts, error: shiftsErr} = await supabaseClient
      .from("shifts")
      .select("id, code, label, metadata")
      .order("sort_order", { ascending: true });
    
    if (shiftsErr) throw shiftsErr;
    
    const { data: scopes, error: scopesErr } = await supabaseClient
      .from("shift_scopes")
      .select("shift_id")
      .eq("scope", "requests");
    
    if (scopesErr) throw scopesErr;
    
    const scopeSet = new Set((scopes || []).map(s => s.shift_id));
    const requestShifts = (shifts || []).filter(s => scopeSet.has(s.id));
    
    const container = document.getElementById("shiftGridContainer");
    if (!container) return;
    
    let html = "";
    requestShifts.forEach(shift => {
      const meta = shift.metadata || {};
      const fillColor = meta.fill_color || "#f7f7f7";
      const textColor = meta.text_color || "#000";
      const borderColor = meta.border_color || "#ccc";
      const fontWeight = meta.bold ? "bold" : "700";
      const fontStyle = meta.italics ? "italic" : "normal";
      
      const style = `background-color:${fillColor}!important; color:${textColor}!important; border-color:${borderColor}!important; font-weight:${fontWeight}!important; font-style:${fontStyle}!important;`;
      html += `<button class="shift-btn" data-shift="${escapeHtml(shift.code)}" type="button" style="${style}">${escapeHtml(shift.code)}</button>`;
    });
    
    html += `<button class="shift-btn off" data-shift="O*" type="button">O*</button>`;
    html += `<button class="shift-btn" data-shift="CLEAR" type="button">Clear</button>`;
    
    container.innerHTML = html;
    attachShiftButtonListeners();
  } catch (err) {
    console.error("Failed to load shifts for picker", err);
    const container = document.getElementById("shiftGridContainer");
    if (container) {
      container.innerHTML = `
        <button class="shift-btn off" data-shift="O*" type="button">O*</button>
        <button class="shift-btn" data-shift="CLEAR" type="button">Clear</button>
      `;
      attachShiftButtonListeners();
    }
  }
}

function attachShiftButtonListeners(){
  document.querySelectorAll(".shift-btn").forEach(btn => {
    btn.addEventListener("click", async function(){
      if (!activeCell) return;

      const td = activeCell.td;
      const userId = activeCell.userId;
      const date = activeCell.date;
      const shift = this.dataset.shift;
      const key = `${userId}_${date}`;

      let rankToSave = null;

      if (shift === "O*") {
        const pe = pendingEdits[key];
        const currentRank =
          (pe && pe.shift === "O") ? (pe.important_rank ?? null) :
          (requestsCache.get(key)?.value === "O") ? (requestsCache.get(key).important_rank ?? null) :
          null;

        const taken = getTakenOffRanksThisWeek(userId, date, key);
        rankToSave = nextOffPrioritySmart(currentRank, taken);

        if (rankToSave === null && (taken.has(1) && taken.has(2))) {
          alert("No more strong preferences available.\\nUse O or add a comment if needed.");
          closeShiftModal();
          return;
        }
      }

      try {
        closeShiftModal();

        if (shift !== "CLEAR" && shift !== "L") {
          const currentCount = countUserRequestsThisWeek(userId, date);
          const alreadyExists = requestsCache.has(key);

          if (!alreadyExists && currentCount >= MAX_REQUESTS_PER_WEEK) {
            alert("You can only enter 5 requests per week.");
            return;
          }
        }

        if (shift === "CLEAR") {
          td.textContent = "";
          delete pendingEdits[key];
        } else if (shift === "O*") {
          if (rankToSave === 1) td.textContent = "O¬π";
          else if (rankToSave === 2) td.textContent = "O¬≤";
          else td.textContent = "O";
          pendingEdits[key] = { userId, date, shift: "O", important_rank: rankToSave };
        } else {
          td.textContent = shift;
          pendingEdits[key] = { userId, date, shift, important_rank: null };
        }

        if (shift === "CLEAR") {
          await deleteRequestCell(userId, date);
          requestsCache.delete(key);
          delete pendingEdits[key];
          toast(`Cleared + saved (${key})`);
        } else {
          const valueToSave = (shift === "O*") ? "O" : shift;
          const saved = await upsertRequestCell(userId, date, valueToSave, rankToSave);
          requestsCache.set(key, saved);
          delete pendingEdits[key];
          toast(`Saved (${key}) = ${shift}`);
        }
      } catch (err) {
        console.error("Auto-save failed:", err);

        const msg = err?.message || err?.error?.message || err?.details || JSON.stringify(err);

        const pe = pendingEdits[key];
        const existing = requestsCache.get(key);

        const row = pe ? { value: pe.shift, important_rank: pe.important_rank } : existing;
        if (row?.value === "O") {
          if (row.important_rank === 1) td.textContent = "O¬π";
          else if (row.important_rank === 2) td.textContent = "O¬≤";
          else if (row.important_rank === 3) td.textContent = "O¬≥";
          else td.textContent = "O";
        } else {
          td.textContent = row?.value || "";
        }

        delete pendingEdits[key];

        if ((msg || "").toLowerCase().includes("max 5")) {
          alert("Max 5 requests per week. Clear one day to pick another.");
          return;
        }

        if ((msg || "").toLowerCase().includes("priority") ||
            (msg || "").toLowerCase().includes("max 2")) {
          alert("No more strong preferences available.\\nUse O or add a comment.");
          return;
        }
        alert("Save failed. Check console.");
      }
    });
  });
}


    
document.querySelectorAll(".shift-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    if (!activeCell) return;

    const td = activeCell.td;
    const userId = activeCell.userId;
    const date = activeCell.date;
const shift = btn.dataset.shift;
const key = `${userId}_${date}`;
const existing = requestsCache.get(key);

// Special handling for O*: cycle strong preference ranks (O¬π / O¬≤)
let rankToSave = null;

if (shift === "O*") {
  const pe = pendingEdits[key];
  const existing = requestsCache.get(key);

  const currentRank =
    (pe && pe.shift === "O") ? (pe.important_rank ?? null) :
    (existing?.value === "O") ? (existing.important_rank ?? null) :
    null;

  const taken = getTakenOffRanksThisWeek(userId, date, key);
  rankToSave = nextOffPrioritySmart(currentRank, taken);

  // üö´ HARD BLOCK after O¬π + O¬≤
  if (rankToSave === null && (taken.has(1) && taken.has(2))) {
    alert("No more strong preferences available.\nUse O or add a comment if needed.");
    closeShiftModal();
    return;
  }
}


 

    /* -----------------------------
       STEP 1: Max 5 per week guard (except for Leave)
       ----------------------------- */
    if (shift !== "CLEAR" && shift !== "L") {
      const currentCount = countUserRequestsThisWeek(userId, date);
      const alreadyExists = requestsCache.has(key);

      if (!alreadyExists && currentCount >= MAX_REQUESTS_PER_WEEK) {
        alert("You can only enter 5 requests per week.");
        closeShiftModal();
        return;
      }
    }


    /* -----------------------------
       Optimistic UI update
       ----------------------------- */
 if (shift === "CLEAR") {
  td.textContent = "";
  delete pendingEdits[key];
} else if (shift === "O") {
  // plain OFF, no priority
  td.textContent = "O";
  pendingEdits[key] = { userId, date, shift: "O", important_rank: null };

} else if (shift === "O*") {
  // strong OFF, cycles rank
  if (rankToSave === 1) td.textContent = "O¬π";
  else if (rankToSave === 2) td.textContent = "O¬≤";
  else td.textContent = "O"; // fallback (shouldn‚Äôt happen if cycling works)

  // note: we save as value "O" with important_rank 1/2
  pendingEdits[key] = { userId, date, shift: "O", important_rank: rankToSave };

} else {
  td.textContent = shift;
  pendingEdits[key] = { userId, date, shift, important_rank: null };
}

    closeShiftModal();
/* -----------------------------
   Auto-save to Supabase
   ----------------------------- */
try {
  if (shift === "CLEAR") {
    await deleteRequestCell(userId, date);
    requestsCache.delete(key);
    delete pendingEdits[key];
    toast(`Cleared + saved (${key})`);
  } else {
const valueToSave = (shift === "O*") ? "O" : shift;

const saved = await upsertRequestCell(
  userId,
  date,
  valueToSave,
  rankToSave
);

    requestsCache.set(key, saved);
    delete pendingEdits[key];
    toast(`Saved (${key}) = ${shift}`);
  }
} catch (err) {
  console.error("Auto-save failed:", err);

  const msg =
    err?.message ||
    err?.error?.message ||
    err?.details ||
    JSON.stringify(err);

// Revert UI to last known good state (pendingEdits first, then saved)
const pe = pendingEdits[key];
const existing = requestsCache.get(key);

const row = pe ? { value: pe.shift, important_rank: pe.important_rank } : existing;
if (row?.value === "O") {
  if (row.important_rank === 1) td.textContent = "O¬π";
  else if (row.important_rank === 2) td.textContent = "O¬≤";
  else if (row.important_rank === 3) td.textContent = "O¬≥";
  else td.textContent = "O";
} else {
  td.textContent = row?.value || "";
}



  delete pendingEdits[key];

  if ((msg || "").toLowerCase().includes("max 5")) {
    alert("Max 5 requests per week. Clear one day to pick another.");
    return;
  }

if ((msg || "").toLowerCase().includes("priority") ||
    (msg || "").toLowerCase().includes("max 2")) {
  alert("No more strong preferences available.\nUse O or add a comment.");
  return;
}
  alert("Save failed. Check console.");
}
  });
});


    /* =========================================================
   PATCH 2B) AUTO-SAVE (write to Supabase after each selection)
   ========================================================= */

function toast(msg){
  // tiny, non-annoying feedback. If you hate it, delete it.
  console.log(msg);
}

// Upsert a single cell to Supabase
async function upsertRequestCell(userId, date, value, importantRank){
  if (!currentUser) throw new Error("Not logged in.");

  const pin = sessionStorage.getItem(pinKey(currentUser.id));
  if (!pin) throw new Error("Missing session PIN. Log in again.");

  // Admin editing someone else -> admin RPC
  if (currentUser.is_admin && String(userId) !== String(currentUser.id)) {
    const { data, error } = await supabaseClient.rpc("admin_set_request_cell", {
      p_admin_id: currentUser.id,
      p_pin: pin,
      p_target_user_id: userId,
      p_date: date,
      p_value: value,
      p_important_rank: importantRank ?? null
    });
    if (error) throw error;
    return data;
  }

  // Normal -> user RPC
  const { data, error } = await supabaseClient.rpc("set_request_cell", {
    p_user_id: userId,
    p_pin: pin,
    p_date: date,
    p_value: value,
    p_important_rank: importantRank ?? null
  });
  if (error) throw error;
  return data;
}



// Delete a cell completely (optional, but nice for CLEAR)
async function deleteRequestCell(userId, date){
  if (!currentUser) throw new Error("Not logged in.");

  const pin = sessionStorage.getItem(pinKey(currentUser.id));
  if (!pin) throw new Error("Missing session PIN. Log in again.");

  // Admin editing someone else -> admin RPC
  if (currentUser.is_admin && String(userId) !== String(currentUser.id)) {
    const { error } = await supabaseClient.rpc("admin_clear_request_cell", {
      p_admin_id: currentUser.id,
      p_pin: pin,
      p_target_user_id: userId,
      p_date: date
    });
    if (error) throw error;
    return;
  }

  // Normal -> user RPC
  const { error } = await supabaseClient.rpc("clear_request_cell", {
    p_user_id: userId,
    p_pin: pin,
    p_date: date
  });
  if (error) throw error;
}

    
async function loadRota() {
  // -----------------------------
  // 7A) Load users
  // -----------------------------
  const { data: users, error: userError } = await supabaseClient
.from("users")
.select("id, name, role_id, is_admin, is_active, preferred_lang, display_order, roles(name)")
    .order("role_id", { ascending: true })
    .order("display_order", { ascending: true })

  if (userError) {
    console.error("Users load error:", userError);
    alert("Failed to load users.");
    return;
  }

  // Build helper map + store all users for print/export
  allUsers = users || [];
  usersById = new Map((users || []).map(u => [u.id, u.name]));

  // üîê Restore logged-in user from localStorage (ONE TIME LOGIN)
const savedId = localStorage.getItem(STORAGE_KEY);
if (savedId && !currentUser) {
  const restored = (users || []).find(u => String(u.id) === String(savedId));
  const restoredPin = restored ? sessionStorage.getItem(pinKey(restored.id)) : null;

  if (restored && restoredPin) {
    currentUser = restored;
    await loadUserPermissions();
    updateBadges();
    applyUnlockState();
  } else {
    localStorage.removeItem(STORAGE_KEY);
  }
}

refreshNoticesAndMaybeBlock();


// -----------------------------
// 7C) Load rota periods (dropdown + active)
// -----------------------------
let periods;
try {
  periods = await fetchRotaPeriods();
} catch (e) {
  console.error("Period load error:", e);
  alert("Failed to load rota periods.");
  return;
}

if (!periods.length) {
  alert("No rota periods available.");
  return;
}

periodsCache = periods;

// choose active by default, else latest
const active = periods.find(p => p.is_active);
const latest = periods[periods.length - 1];

// Only choose default if user hasn't picked one yet
if (activePeriodId == null) {
  activePeriodId = active ? active.id : latest.id;
}

// populate dropdown + label
populatePeriodDropdown(periods);
periodSelect.value = String(activePeriodId);

const selected = periods.find(p => String(p.id) === String(activePeriodId));
activePeriodObj = selected;   // ‚Üê THIS is 5A in action
updateCloseLabel(selected);
  
// -----------------------------
// 7D) Load rota dates FOR SELECTED PERIOD
// -----------------------------
const { data: dates, error: dateError } = await supabaseClient
  .from("rota_dates")
 .select("date, week_id, period_id, rota_weeks(id, open, open_after_close)")
  .eq("period_id", activePeriodId)
  .order("date");

if (dateError) {
  console.error("Dates load error:", dateError);
  alert("Failed to load dates for this period.");
  return;
}

// -----------------------------
// 7D.5) Load requests for this period (so saved cells show up)
// -----------------------------
const selectedPeriod = periods.find(p => String(p.id) === String(activePeriodId));
const start = selectedPeriod?.start_date;
const end = selectedPeriod?.end_date;

if (start && end) {
  const { data: reqs, error: reqErr } = await supabaseClient
    .from("requests")
    .select("id, user_id, date, value, important_rank")
    .gte("date", start)
    .lte("date", end);

  if (reqErr) {
    console.error("Requests load error:", reqErr);
    alert("Failed to load requests.");
    return;
  }

  requestsCache.clear();
  for (const r of (reqs || [])) {
    requestsCache.set(`${r.user_id}_${r.date}`, r);
  }
} else {
  console.warn("No period dates found for requests fetch.");
  requestsCache.clear();
}

// -----------------------------
// 7D.6) Load locks for this period (so UI blocks staff edits + shows reason)
// -----------------------------
locksCache.clear();

if (start && end) {
  const { data: locks, error: lockErr } = await supabaseClient
    .from("request_cell_locks")
    .select("user_id, date, reason_en, reason_es, locked_by, locked_at")
    .gte("date", start)
    .lte("date", end);

  if (lockErr) {
    console.error("Locks load error:", lockErr);
    // Do NOT hard-fail the whole app if locks fetch fails
  } else {
    for (const L of (locks || [])) {
      locksCache.set(`${L.user_id}_${L.date}`, L);
    }
  }
}

// -----------------------------
// 7E) Render table (weeks + users)
// -----------------------------
const weeks = groupDatesIntoWeeks(dates);

// Store for export/report features
allWeeks = weeks;
weekWindowStart = 0;


// Hide inactive users from the rota table (for everyone)
// (Admins can still view/manage them in Admin ‚Üí Users with "Show inactive")
const visibleUsers = users.filter(u => u.is_active !== false);

render(visibleUsers, weeks);

  
// Period label
if (weeks.length) {
document.getElementById("periodLabel").textContent =
  `${fmt(weeks[0].weekStart)} ‚Äì ${fmt(weeks[weeks.length - 1].weekEnd)} ¬∑ 5-week period`;

}

// Apply locks + badges
applyUnlockState();
updateBadges();
  }

    /* =========================================================
   8) RENDER (table header + grouped rows)
   ========================================================= */
function render(users, weeks){
  const table = document.getElementById("rota");
  table.innerHTML = "";

  // Debug guard: ensure every week has an ID
  weeks.forEach(w => {
    if (!w.weekId) {
      console.warn("Missing weekId for week:", w.weekStart, w);
    }
  });


  const thead = document.createElement("thead");
  const tbody = document.createElement("tbody");
  table.appendChild(thead);
  table.appendChild(tbody);

  // ----- Header row 1: week labels
  const r1 = document.createElement("tr");
  const hName = document.createElement("th");
  hName.className = "name-col";
  hName.textContent = "Name";
  r1.appendChild(hName);

  weeks.forEach((w, idx) => {
    const th = document.createElement("th");
    th.className = "week-head " + (effectiveOpenForWeek(w) ? "" : "closed");


    th.colSpan = 7;
    th.innerHTML = `
  <span class="week-label">${fmt(w.weekStart)} ‚Äì ${fmt(w.weekEnd)}</span>
${w.weekId ? `
  <button
    class="week-comment-btn"
    type="button"
    data-week-id="${String(w.weekId)}"
    title="Week comment"
  >üí¨</button>
` : `
  <span
    style="opacity:0.35; margin-left:6px;"
    title="Week has no ID (rota_dates.week_id missing)"
  >üí¨</span>
`}
`;
r1.appendChild(th);

    if(idx !== weeks.length - 1){
      const sep = document.createElement("th");
      sep.className = "week-sep";
      r1.appendChild(sep);
    }
  });
  thead.appendChild(r1);

  // ----- Header row 2: day letters
  const r2 = document.createElement("tr");
  const blank2 = document.createElement("th");
  blank2.className = "name-col";
  blank2.textContent = "";
  r2.appendChild(blank2);

  const dayLetters = ["S","M","T","W","T","F","S"];
  weeks.forEach((w, idx) => {
    for(let i=0;i<7;i++){
      const th = document.createElement("th");
     th.className = "day " + (effectiveOpenForWeek(w) ? "" : "closed");

      th.textContent = dayLetters[i];
      r2.appendChild(th);
    }
    if(idx !== weeks.length - 1){
      const sep = document.createElement("th");
      sep.className = "week-sep";
      r2.appendChild(sep);
    }
  });
  thead.appendChild(r2);

  // ----- Header row 3: date numbers
  const r3 = document.createElement("tr");
  const blank3 = document.createElement("th");
  blank3.className = "name-col";
  blank3.textContent = "";
  r3.appendChild(blank3);

  weeks.forEach((w, idx) => {
    for(let i=0;i<7;i++){
      const d = new Date(w.days[i].date);
      const isWeekend = (i === 0 || i === 6);
      const th = document.createElement("th");
     th.className = "date " + (effectiveOpenForWeek(w) ? "" : "closed") + (isWeekend ? " weekend" : "");

      th.textContent = d.getDate();
      r3.appendChild(th);
    }
    if(idx !== weeks.length - 1){
      const sep = document.createElement("th");
      sep.className = "week-sep";
      r3.appendChild(sep);
    }
  });
  thead.appendChild(r3);

  // ----- Body grouped by role
  const groups = groupUsers(users);

  for(const g of groups){
    // section header row
    const sectionTr = document.createElement("tr");
    sectionTr.className = "section-row";
    // Store role_id for print filtering
    const roleId = g.className === 'section-cn' ? 1 : g.className === 'section-sn' ? 2 : 3;
    sectionTr.dataset.roleId = roleId;

    const sectionTd = document.createElement("td");
    sectionTd.className = `name-col ${g.className}`;
    sectionTd.colSpan = 1 + (weeks.length * 7) + (weeks.length - 1);
    sectionTd.innerHTML = `<span>${g.title}</span>`;
    sectionTr.appendChild(sectionTd);
    tbody.appendChild(sectionTr);

    // user rows
    for(const u of g.items){
      const tr = document.createElement("tr");
      tr.dataset.userId = u.id;

      // name cell (PIN login)
      const nameTd = document.createElement("td");
      nameTd.className = "name-col";
      nameTd.textContent = u.name;
      nameTd.title = u.name;
      nameTd.addEventListener("click", () => openPinModal(u));
      tr.appendChild(nameTd);

      // date cells
      weeks.forEach((w, idx) => {
        for(let i=0;i<7;i++){
          const isWeekend = (i === 0 || i === 6);
          const dateStr = w.days[i].date;

          const td = document.createElement("td");
          td.className = "cell" + (effectiveOpenForWeek(w) ? "" : " closed") + (isWeekend ? " weekend" : "");

          td.dataset.userId = u.id;
          td.dataset.date = dateStr;

          // ‚úÖ Fill from cache / pending edits
          const key = `${u.id}_${dateStr}`;

          // Pending edits override everything visually
if (pendingEdits[key]) {
  const pe = pendingEdits[key];

if (pe.shift === "O") {
  if (pe.important_rank === 1) td.textContent = "O¬π";
  else if (pe.important_rank === 2) td.textContent = "O¬≤";
  else if (pe.important_rank === 3) td.textContent = "O¬≥";
  else td.textContent = "O";
} else {
  td.textContent = pe.shift || "";
}

} else {
  const r = requestsCache.get(key);

  if (r?.value === "O") {
    if (r.important_rank === 1) td.textContent = "O¬π";
    else if (r.important_rank === 2) td.textContent = "O¬≤";
    else td.textContent = "O";
  } else {
    td.textContent = r?.value || "";
  }
}
          

          tr.appendChild(td);
        }

        if(idx !== weeks.length - 1){
          const sep = document.createElement("td");
          sep.className = "week-sep";
          tr.appendChild(sep);
        }
      });

      tbody.appendChild(tr);
    }
  }

  // Keep your existing logic
  applyUnlockState();
  updateBadges();
}


    /* =========================================================
   9) UNLOCK LOGIC (who can edit which row)
   ========================================================= */
function applyUnlockState(){
  const rows = document.querySelectorAll("#rota tbody tr");

  rows.forEach(r => {
    if (r.classList.contains("section-row")) return;

    const userId = r.dataset.userId;

  const isUnlocked =
  currentUser && (
    currentUser.is_admin ||
    String(currentUser.id) === String(userId)
  );

    r.classList.toggle("unlocked", !!isUnlocked);
    r.classList.toggle("locked", !isUnlocked);

    r.querySelectorAll("td.cell").forEach(td => {
      const isClosedWeek = td.classList.contains("closed");

      // ‚úÖ FINAL rule:
      // - must be your row (or admin)
      // - week must be open (closed class blocks)
      // periodClosed is NOT a blocker: week toggle overrides it
      
const noticesBlocking =
  Array.isArray(blockingNoticeIds) &&
  blockingNoticeIds.length > 0;

// If notices are blocking, staff cannot edit anything (admins too, unless you exempt them)
const canEdit = !!isUnlocked && !isClosedWeek && !noticesBlocking;

td.classList.toggle("editable", canEdit);
      // Admin-only visual hint: mark individual td when a lock exists for that cell
      // (admins are considered 'unlocked' so we can't rely on !isUnlocked there).
      const _key = `${userId}_${td.dataset.date}`;
      const _lockedForCell = locksCache.has(_key);
      td.classList.toggle("locked-admin", !!currentUser?.is_admin && _lockedForCell);
      if (_lockedForCell && !!currentUser?.is_admin) console.debug('applyUnlockState: locked-admin set for', _key);
      if (!td.dataset.bound) {
        td.dataset.bound = "1";
 td.addEventListener("click", () => {
  if (!td.classList.contains("editable")) return;

  const userId = td.dataset.userId;
  const date = td.dataset.date;
  const lock = locksCache.get(`${userId}_${date}`);

  // üö´ Staff: locked cell blocks editing, shows reason
  if (lock && !currentUser?.is_admin) {
    const reason =
      (currentLang === "es" ? lock.reason_es : lock.reason_en) ||
      lock.reason_en ||
      (currentLang === "es" ? "Este d√≠a est√° bloqueado por administraci√≥n." : "This day is locked by management.");

    alert(reason);
    return;
  }

  activeCell = { td, userId, date };
  openShiftModal();
});
      }
    });
  });
}


    
    /* =========================================================
       PRINT & EXPORT SYSTEM
       ========================================================= */
    const printBtn = document.getElementById("printBtn");
    const printModal = document.getElementById("printModal");
    const printClose = document.getElementById("printClose");
    const printCloseX = document.getElementById("printCloseX");
    const printStaffOptions = document.getElementById("printStaffOptions");
    const printAdminOptions = document.getElementById("printAdminOptions");
    const printAllRequests = document.getElementById("printAllRequests");
    const printGroupCN = document.getElementById("printGroupCN");
    const printGroupSN = document.getElementById("printGroupSN");
    const printGroupNA = document.getElementById("printGroupNA");
    const printOwnRow = document.getElementById("printOwnRow");
    const exportExcel = document.getElementById("exportExcel");
    const reportRequestsUsage = document.getElementById("reportRequestsUsage");
    const reportComments = document.getElementById("reportComments");
    
    function openPrintModal(){
        if(!currentUser){alert(t("loginFirst")||"Please log in first.");return}
        printStaffOptions.style.display="block";
        printAdminOptions.style.display=currentUser.is_admin?"block":"none";
        printModal.setAttribute("aria-hidden","false");
        printModal.style.display="flex"
    }
    
    function closePrintModal(){
        printModal.setAttribute("aria-hidden","true");
        printModal.style.display="none"
    }

    function buildPrintHeaderHtml(title, subtitle = "") {
        const period = activePeriodObj?.name || "";
        const printedAt = `${new Date().toLocaleDateString("en-GB")} ${new Date().toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit" })}`;
        return `
          <div class="print-header">
            <h1>Calpe Ward Requests - ${escapeHtml(title)}</h1>
            <div class="print-meta">${escapeHtml(subtitle)}<br>Period: ${escapeHtml(period)} | Printed: ${escapeHtml(printedAt)}</div>
          </div>
        `;
    }

    function cloneRotaForPrint() {
        const rota = document.getElementById("rota");
        return rota ? rota.cloneNode(true) : null;
    }

    function openFittedPrintWindow({ title, subtitle, rotaClone, commentsData, commentsOnly, weekOrder, weeksInfo }) {
      console.log("openFittedPrintWindow called with:");
      console.log("- title:", title);
      console.log("- subtitle:", subtitle);
      console.log("- rotaClone:", rotaClone ? "present" : "null");
      console.log("- commentsData:", commentsData);
      console.log("- commentsData length:", commentsData?.length || 0);
      console.log("- commentsOnly:", commentsOnly);
      console.log("- weekOrder:", weekOrder);
      console.log("- weeksInfo:", weeksInfo);
      
      try {
        if (!rotaClone && !commentsOnly) {
          alert("Nothing to print.");
          return;
        }

        const win = window.open("", "_blank");
        if (!win) {
          alert("Pop-up blocked. Please allow pop-ups for printing.");
          return;
        }

            const doc = win.document;
            doc.open();
            doc.write('<!doctype html><html lang="en"><head><meta charset="utf-8"><title>Print</title></head><body></body></html>');
            doc.close();

            // Build everything via DOM to avoid any script-breaking issues
            const style = doc.createElement('style');
            style.textContent = `
:root { --print-scale: 1; --cn-band: #c8e6c9; --sn-band: #b3e5fc; --na-band: #ffe0b2; }
@page { size: A4 landscape; margin: 4mm; }
html, body { margin: 0; padding: 0; background: #fff; color: #222; }
body { font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif; }
#mmProbe { width: 100mm; height: 0; position: absolute; left: -9999px; top: -9999px; visibility: hidden; }
#printArea { transform: scale(var(--print-scale)); transform-origin: top left; width: calc(100% / var(--print-scale)); }
.print-header { padding: 0 0 3mm 0; margin: 0 0 3mm 0; border-bottom: 2pt solid #333; }
.print-header { page-break-after: avoid; }
.print-header h1 { margin: 0 0 1.5mm 0; font-size: 14pt; font-weight: 800; line-height: 1; color: #111; }
.print-header .print-meta { font-size: 8pt; color: #666; line-height: 1.3; }
table { border-collapse: collapse; width: 100%; }
#rota { table-layout: auto; }
#rota th { background: #e0e0e0; border: 1pt solid #888; padding: 3px 2px; font-size: 7pt; font-weight: 700; color: #000; }
#rota td { border: 1pt solid #ccc; padding: 3px 2px; font-size: 6.8pt; text-align: center; line-height: 1.4; }
#rota tbody th { background: #f5f5f5; font-weight: 600; text-align: left; padding: 3px 4px; font-size: 7pt; border: 1pt solid #888; }
#rota thead th { background: #d9d9d9; }
/* Prevent browser from repeating the header on subsequent pages */
#rota thead { display: table-row-group; }
#rota tfoot { display: table-row-group; }
.week-label { font-size: 6.8pt; font-weight: 700; }
.week-comment-btn { display: none !important; }
/* Tidy, consistent week separator */
th.week-sep, td.week-sep {
  background: #c8c8c8 !important;
  border-left: 1.5pt solid #666 !important;
  border-right: 1.5pt solid #666 !important;
  border-top: 0 !important;
  border-bottom: 0 !important;
  width: 2pt !important;
  min-width: 2pt !important;
  padding: 0 !important;
}
td.section-cn { background: var(--cn-band) !important; font-weight: 700; color: #2e7d32; border: 1pt solid #888 !important; }
td.section-sn { background: var(--sn-band) !important; font-weight: 700; color: #01579b; border: 1pt solid #888 !important; }
td.section-na { background: var(--na-band) !important; font-weight: 700; color: #e65100; border: 1pt solid #888 !important; }
.weekend { background: #fafafa; }
.closed { background: #f0f0f0; }
tr { page-break-inside: avoid; }
#rota { page-break-inside: auto; }
* { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

#rota td.cell {
  font-weight: 400;
  font-size: 7pt;
  letter-spacing: 0.4pt;
  background: #ffffff;
  color: #000;
  white-space: nowrap;
}
#rota tbody tr { page-break-inside: avoid; }
/* Keep request rows together; let comments follow naturally */
#rota tbody th.name-col, #rota td.name-col { white-space: nowrap; }

#rota td.cell:empty {
  background: #ffffff;
}

/* O¬π and O¬≤ - RED text, bold */
#rota td.cell.shift-o1,
#rota td.cell.shift-o2 {
  background: #ffffff !important;
  color: #d32f2f !important;
  font-weight: 700;
}

/* Regular O - dark green text, not bold */
#rota td.cell.shift-o {
  background: #ffffff !important;
  color: #1b5e20 !important;
  font-weight: 400;
}

/* L (Leave) - pink background, not bold */
#rota td.cell.shift-l {
  background: #fbe2d5 !important;
  color: #000 !important;
  font-weight: 400;
}

/* N (Night) - clear/bright blue text, not bold */
#rota td.cell.shift-n {
  background: #ffffff !important;
  color: #1565c0 !important;
  font-weight: 400;
}

/* LD, 8-8, W - regular black text, not bold */
#rota td.cell.shift-bold-black {
  background: #ffffff !important;
  color: #000 !important;
  font-weight: 400;
}

.comments-section {
  margin-top: 20pt;
  padding-top: 10pt;
  border-top: 2pt solid #333;
  page-break-before: avoid;
}

.comments-section h2 {
  margin: 0 0 8pt 0;
  font-size: 12pt;
  font-weight: 700;
  color: #111;
}

.comment-item {
  margin: 8pt 0;
  padding: 6pt;
  border-left: 3pt solid #1976d2;
  background: #f5f5f5;
  font-size: 8pt;
  page-break-inside: avoid;
}

.comment-header {
  font-weight: 600;
  color: #222;
  margin-bottom: 3pt;
}

.comment-text {
  color: #555;
  line-height: 1.4;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* Comments row inside rota table to guarantee perfect alignment */
tbody .comments-row td.comment-week-cell {
  vertical-align: top;
  padding: 6pt;
  background: #f9f9f9;
  border: 1pt solid #ddd;
}
tbody .comments-row td.name-placeholder {
  border: none !important;
  background: transparent !important;
}
`;
            doc.head.appendChild(style);

            // Create print header
            const period = activePeriodObj?.name || "";
            const printedAt = new Date().toLocaleDateString("en-GB") + " " + new Date().toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit" });
            
            const printHeader = doc.createElement('div');
            printHeader.className = 'print-header';
            const h1 = doc.createElement('h1');
            h1.textContent = "Calpe Ward Requests - " + title;
            const meta = doc.createElement('div');
            meta.className = 'print-meta';
            meta.textContent = subtitle + "\nPeriod: " + period + " | Printed: " + printedAt;
            printHeader.appendChild(h1);
            printHeader.appendChild(meta);

            const mmProbe = doc.createElement('div');
            mmProbe.id = 'mmProbe';

            const printArea = doc.createElement('div');
            printArea.id = 'printArea';
            printArea.appendChild(printHeader);
            
            // Add rota table if not comments-only
            if(rotaClone){
                printArea.appendChild(rotaClone);
            }
            
            // Add comments organized by week if provided
            if(commentsData && commentsData.length > 0){
                console.log("Rendering", commentsData.length, "comments in print window");
                // Group comments by week
                const commentsByWeek = {};
                commentsData.forEach(c => {
                    const weekStart = c.week_start || "Unknown";
                    if(!commentsByWeek[weekStart]) commentsByWeek[weekStart] = [];
                    commentsByWeek[weekStart].push(c);
                });

                // Determine week order
                const order = Array.isArray(weeksInfo) && weeksInfo.length === 5
                  ? weeksInfo.slice().sort((a,b)=>new Date(a.week_start)-new Date(b.week_start)).map(w=>w.week_start)
                  : (Array.isArray(weekOrder) && weekOrder.length
                      ? weekOrder.slice().sort((a,b)=>new Date(a)-new Date(b))
                      : Object.keys(commentsByWeek).sort((a,b)=>new Date(a)-new Date(b))
                    );

                // Build a ghost row inside the rota table so alignment is perfect
                const rotaTable = rotaClone || doc.getElementById('rota');
                if (rotaTable) {
                  try {
                    // Determine week groups by counting day header cells between separators
                    const dayHead = rotaTable.querySelector('thead tr:nth-child(2)')
                      || rotaTable.querySelector('thead tr:last-child');
                    const headCells = dayHead ? Array.from(dayHead.querySelectorAll('th')) : [];
                    let afterName = headCells.slice(1); // skip name column
                    if (afterName.length === 0) {
                      const dataRow = rotaTable.querySelector('tbody tr:not(.section-row)');
                      const cells = dataRow ? Array.from(dataRow.querySelectorAll('td')) : [];
                      afterName = cells.slice(1);
                    }
                    const groups = [];
                    let count = 0;
                    for (const el of afterName){
                      if (el.classList && el.classList.contains('week-sep')){
                        if (count > 0){ groups.push(count); count = 0; }
                        continue;
                      }
                      const span = el.getAttribute('colspan');
                      const n = span ? parseInt(span,10) : 1;
                      count += (isNaN(n) ? 1 : n);
                    }
                    if (count > 0) groups.push(count);
                    if (groups.length !== 5){
                      // Fallback to equal 7-day weeks if header is unusual
                      for (let i = groups.length; i < 5; i++) groups.push(7);
                      if (groups.length > 5) groups.splice(5);
                    }

                    // Append to the last tbody to avoid header duplication
                    const bodies = Array.from(rotaTable.querySelectorAll('tbody'));
                    const targetBody = bodies.length ? bodies[bodies.length - 1] : null;
                    const commentsBody = targetBody || doc.createElement('tbody');
                    const row = doc.createElement('tr');
                    row.className = 'comments-row';

                    // Placeholder for name column
                    const nameTd = doc.createElement('td');
                    nameTd.className = 'name-placeholder';
                    row.appendChild(nameTd);

                    const weekStartsOrdered = order.slice(0,5);
                    for (let i = 0; i < 5; i++) {
                      const weekStart = weekStartsOrdered[i];
                      const span = groups[i] || 7;
                      const td = doc.createElement('td');
                      td.className = 'comment-week-cell';
                      td.setAttribute('colspan', String(span));

                      // Keep your preferred header inside each week block
                      const weekDate = new Date(weekStart).toLocaleDateString('en-GB');
                      const head = doc.createElement('div');
                      head.style.cssText = 'font-weight:700;font-size:9pt;color:#1976d2;margin-bottom:6pt;border-bottom:1pt solid #1976d2;padding-bottom:3pt;';
                      head.textContent = 'Week commencing: ' + weekDate;
                      td.appendChild(head);

                      (commentsByWeek[weekStart] || []).forEach(c => {
                        const userName = usersById.get(String(c.user_id)) || 'Unknown';
                        const card = doc.createElement('div');
                        card.style.cssText = 'margin:6pt 0;padding:6pt;border-left:2pt solid #1976d2;background:#fff;font-size:8pt;';
                        const n = doc.createElement('div');
                        n.style.cssText = 'font-weight:600;color:#222;margin-bottom:3pt;';
                        n.textContent = userName;
                        const t = doc.createElement('div');
                        t.style.cssText = 'color:#555;line-height:1.4;white-space:pre-wrap;word-wrap:break-word;font-size:7.5pt;';
                        t.textContent = c.comment || '';
                        card.appendChild(n);
                        card.appendChild(t);
                        td.appendChild(card);
                      });

                      row.appendChild(td);
                      if (i < 4) {
                        const sep = doc.createElement('td');
                        sep.className = 'week-sep';
                        row.appendChild(sep);
                      }
                    }

                    commentsBody.appendChild(row);
                    if (!targetBody) rotaTable.appendChild(commentsBody);
                  } catch(e) {
                    console.warn('Ghost-row comments failed:', e);
                  }
                }
            } else {
                console.log("No comments to render - commentsData:", commentsData);
            }

            doc.body.appendChild(mmProbe);
            doc.body.appendChild(printArea);

            // Add print logic
            const script = doc.createElement('script');
            script.textContent = `(function(){
// Classify cells by shift type and add styling
var cells = document.querySelectorAll('#rota td.cell');
cells.forEach(function(cell){
  var text = (cell.textContent || '').trim();
  if(!text) return;
  
  if(text === 'O¬π' || text === 'O1') {
    cell.classList.add('shift-o1');
  } else if(text === 'O¬≤' || text === 'O2') {
    cell.classList.add('shift-o2');
  } else if(text === 'O') {
    cell.classList.add('shift-o');
  } else if(text.includes('N') && !text.includes('LD')) {
    cell.classList.add('shift-n');
  } else if(text.includes('L') && !text.includes('LD')) {
    cell.classList.add('shift-l');
  } else if(text.includes('LD') || text.includes('8-8') || text === 'W') {
    cell.classList.add('shift-bold-black');
  }
});

// Align ghost-row week cells to actual week widths
(function(){
  try{
    var dayRow = document.querySelector('#rota thead tr:nth-child(2)') || document.querySelector('#rota thead tr:last-child');
    if(!dayRow) return;
    var dayCells = Array.from(dayRow.querySelectorAll('th')).filter(function(th){
      return !(th.classList && (th.classList.contains('name-col') || th.classList.contains('week-sep')));
    });
    if(dayCells.length === 0) return;
    var dayWidth = dayCells[0].getBoundingClientRect().width;
    if(!dayWidth || dayWidth <= 0) return;
    var weekCells = document.querySelectorAll('#rota td.comment-week-cell');
    weekCells.forEach(function(td){
      var span = parseInt(td.getAttribute('colspan'), 10);
      if(!span || isNaN(span)) span = 7;
      td.style.width = (dayWidth * span) + 'px';
    });
  } catch(e){ console.warn('Width alignment for comment-week-cell failed:', e); }
})();

function mmToPx(mm){var probe=document.getElementById('mmProbe');return(probe.getBoundingClientRect().width/100)*mm;}
function fit(){var p=document.getElementById('printArea');document.documentElement.style.setProperty('--print-scale','1');var r=p.getBoundingClientRect();var s=Math.min(mmToPx(293)/r.width,mmToPx(206)/r.height);document.documentElement.style.setProperty('--print-scale',(Math.max(0.1,Math.min(1,s*0.995))).toFixed(4));}
window.addEventListener('load',function(){requestAnimationFrame(function(){requestAnimationFrame(function(){fit();setTimeout(function(){window.focus();window.print();setTimeout(function(){window.close();},250);},50);});});});
})();`;
            doc.body.appendChild(script);

        } catch (err) {
            console.error("Print failed:", err);
            alert("Print failed: " + err.message);
        }
    }

    function hideForRole(roleId) {
        const allSections = Array.from(document.querySelectorAll("#rota tbody tr.section-row"));
        const allRows = Array.from(document.querySelectorAll("#rota tbody tr:not(.section-row)"));
        const prev = new Map();

        [...allSections, ...allRows].forEach(el => prev.set(el, el.style.display));

        allSections.forEach(section => {
            const sectionRoleId = parseInt(section.dataset.roleId);
            if (sectionRoleId !== roleId) section.style.display = "none";
        });
        allRows.forEach(row => {
            const userIdStr = row.dataset.userId;
            const user = allUsers.find(u => String(u.id) === userIdStr || u.id === userIdStr);
            if (user && user.role_id !== roleId) row.style.display = "none";
        });

        return function restore() {
            prev.forEach((display, el) => { el.style.display = display; });
        };
    }

    function hideForCurrentUser() {
        if (!currentUser) return () => {};
        const allRows = Array.from(document.querySelectorAll("#rota tbody tr:not(.section-row)"));
        const sectionRows = Array.from(document.querySelectorAll("#rota tbody tr.section-row"));
        const prev = new Map();

        [...allRows, ...sectionRows].forEach(el => prev.set(el, el.style.display));

        allRows.forEach(row => {
            const userIdStr = row.dataset.userId;
            if (String(currentUser.id) !== userIdStr) row.style.display = "none";
        });
        sectionRows.forEach(sectionRow => {
            const sectionRoleId = parseInt(sectionRow.dataset.roleId);
            if (sectionRoleId !== currentUser.role_id) sectionRow.style.display = "none";
        });

        return function restore() {
            prev.forEach((display, el) => { el.style.display = display; });
        };
    }

    function printAll(){
        closePrintModal();
        const rotaClone = cloneRotaForPrint();
        openFittedPrintWindow({ title: "All Requests", subtitle: "", rotaClone });
    }
    
    function printByGroup(roleId,roleName){
        const restore = hideForRole(roleId);
        const rotaClone = cloneRotaForPrint();
        restore();
        closePrintModal();
        openFittedPrintWindow({ title: `${roleName} Requests`, subtitle: `Group: ${roleName}`, rotaClone });
    }
    
    function printOwnRowFunc(){
        if(!currentUser) return;
        const restore = hideForCurrentUser();
        const rotaClone = cloneRotaForPrint();
        restore();
        closePrintModal();
        openFittedPrintWindow({ title: "My Requests", subtitle: `User: ${currentUser.name}`, rotaClone });
    }
    
    // Admin print configuration modal
    function openAdminPrintConfig(){
        if(!currentUser?.is_admin) {alert("Admin access required"); return}
        closePrintModal();
        
        const modal = document.createElement("div");
        modal.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,23,42,0.28);backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;z-index:10001;overflow-y:auto;padding:14px";
        
        const dialog = document.createElement("div");
        dialog.style.cssText = "background:linear-gradient(180deg,#ffffff 0%,#f6f8fc 100%);padding:18px;border-radius:22px;max-width:620px;width:min(620px,100%);box-shadow:0 28px 80px rgba(15,23,42,0.14);border:1px solid rgba(15,23,42,0.05);margin:20px auto;font-family:'Manrope',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#0f172a";
        
        let html = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                <h2 style="margin:0;font-size:17px;font-weight:700;letter-spacing:0.1px;">Admin Print Configuration</h2>
                <button type="button" onclick="this.closest('[data-modal]').remove()" style="width:32px;height:32px;border-radius:10px;border:1px solid #e5eaf3;background:#ffffff;cursor:pointer;color:#94a3b8;box-shadow:0 3px 8px rgba(15,23,42,0.05);font-size:18px;line-height:1;">√ó</button>
            </div>
            
            <!-- ROLES SECTION -->
            <div style="margin-bottom:18px">
                <label style="display:block;font-weight:600;margin-bottom:10px;font-size:12.5px;color:#6b7387">Select Roles:</label>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="checkbox" class="admin-role-check" value="1" style="width:18px;height:18px;cursor:pointer"> Charge Nurses
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="checkbox" class="admin-role-check" value="2" style="width:18px;height:18px;cursor:pointer"> Staff Nurses
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="checkbox" class="admin-role-check" value="3" style="width:18px;height:18px;cursor:pointer"> Nursing Assistants
                    </label>
                </div>
            </div>
            
            <!-- USERS SECTION -->
            <div style="margin-bottom:18px">
                <label style="display:block;font-weight:600;margin-bottom:10px;font-size:12.5px;color:#6b7387">Select Users (or leave empty for all):</label>
                <input type="text" id="userSearchInput" placeholder="Search staff..." style="width:100%;padding:8px 12px;margin-bottom:12px;border:1px solid #e5eaf3;border-radius:10px;font-size:12.5px;background:#ffffff;box-shadow:inset 0 1px 2px rgba(15,23,42,0.06)">
                <div id="userList" style="max-height:200px;overflow-y:auto;border:1px solid #e7ebf3;border-radius:12px;padding:8px;background:#ffffff;box-shadow:inset 0 1px 2px rgba(15,23,42,0.06)">`;
        
        allUsers.forEach(u => {
            html += `<label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;margin:0">
                <input type="checkbox" class="admin-user-check" value="${u.id}" style="width:16px;height:16px;cursor:pointer"> ${escapeHtml(u.name)}
            </label>`;
        });
        
        html += `</div>
            </div>
            
            <!-- COMMENTS SECTION -->
            <div style="margin-bottom:18px;padding:14px;background:#f5f7fb;border-radius:14px;border:1px solid #e7ebf3">
                <label style="display:block;font-weight:600;margin-bottom:10px;font-size:12.5px;color:#6b7387">What to Print:</label>
                
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:12px">
                    <input type="radio" name="printMode" value="both" checked style="width:16px;height:16px;cursor:pointer"> Requests & Comments
                </label>
                
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:12px">
                    <input type="radio" name="printMode" value="requests" style="width:16px;height:16px;cursor:pointer"> Requests Only
                </label>
                
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                    <input type="radio" name="printMode" value="comments" style="width:16px;height:16px;cursor:pointer"> Comments Only
                </label>
            </div>
            
            <!-- BUTTONS -->
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button type="button" onclick="this.closest('[data-modal]').remove()" style="height:32px;padding:0 14px;border:1px solid #e5eaf3;background:#ffffff;border-radius:12px;cursor:pointer;font-weight:600;font-size:12.5px;box-shadow:0 3px 8px rgba(15,23,42,0.05)">Cancel</button>
                <button type="button" id="adminPrintExecBtn" style="height:32px;padding:0 16px;background:linear-gradient(180deg,#6f8bff 0%,#5472f2 100%);color:white;border:1px solid rgba(84,114,242,0.5);border-radius:12px;cursor:pointer;font-weight:600;font-size:12.5px;box-shadow:0 6px 14px rgba(66,95,210,0.25)">Print</button>
            </div>
        `;
        
        dialog.innerHTML = html;
        dialog.setAttribute("data-modal", "true");
        modal.appendChild(dialog);
        document.body.appendChild(modal);
        
        // User search functionality
        const userSearchInput = document.getElementById("userSearchInput");
        const userCheckboxes = document.querySelectorAll(".admin-user-check");
        userSearchInput.addEventListener("input", (e) => {
            const query = e.target.value.toLowerCase();
            userCheckboxes.forEach(checkbox => {
                const label = checkbox.closest("label");
                const userName = label.textContent.toLowerCase();
                label.style.display = userName.includes(query) ? "flex" : "none";
            });
        });
        
        // Print execution
        document.getElementById("adminPrintExecBtn").addEventListener("click", () => {
            const selectedRoles = Array.from(document.querySelectorAll(".admin-role-check:checked")).map(el => parseInt(el.value));
            const selectedUsers = Array.from(document.querySelectorAll(".admin-user-check:checked")).map(el => el.value);
            const printMode = document.querySelector("input[name='printMode']:checked").value;
            
            modal.remove();
            executeAdminPrint(selectedRoles, selectedUsers, printMode);
        });
        
        modal.addEventListener("click", (e) => {
            if(e.target === modal) modal.remove();
        });
    }
    
    async function executeAdminPrint(selectedRoles, selectedUsers, printMode){
        console.log("=== executeAdminPrint called ===");
        console.log("Selected roles:", selectedRoles);
        console.log("Selected users:", selectedUsers);
        console.log("Print mode:", printMode);
        
        try{
            if(!activePeriodId){
                alert("No active period selected.");
                return
            }
            
            console.log("Active period ID:", activePeriodId);
            
            // Build list of users to keep visible
            let filteredUsers = allUsers;
            if(selectedRoles.length > 0){
                filteredUsers = allUsers.filter(u => selectedRoles.includes(u.role_id));
            }
            if(selectedUsers.length > 0){
                filteredUsers = filteredUsers.filter(u => selectedUsers.includes(String(u.id)));
            }
            
            console.log("Filtered users count:", filteredUsers.length);
            console.log("Filtered users:", filteredUsers.map(u => u.name));
            
            if(filteredUsers.length === 0){
                alert("No staff selected.");
                return
            }
            
            // Save filtered users for comment fetching later
            const usersForComments = filteredUsers.slice();
            console.log("Saved users for comments:", usersForComments.length);
            
            // Filter the rota table to show only selected users
            const restore = (() => {
                const original = new Map();
                const selectedUserIds = new Set(filteredUsers.map(u => String(u.id)));
                
                document.querySelectorAll("#rota tbody tr").forEach(row => {
                  original.set(row, row.style.display);
                  const isSection = row.classList.contains('section-row');
                  if (isSection) {
                    // Keep role sections visible when users are not individually selected
                    if (selectedUsers.length === 0) {
                      const roleIdAttr = row.getAttribute('data-role-id') || row.dataset.roleId;
                      const sectionRoleId = parseInt(roleIdAttr, 10);
                      if (selectedRoles.length === 0 || selectedRoles.includes(sectionRoleId)) {
                        // keep visible
                      } else {
                        row.style.display = 'none';
                      }
                    } else {
                      // If specific users are selected, hide all section headers
                      row.style.display = 'none';
                    }
                    return;
                  }

                  const nameCell = row.querySelector("td:first-child");
                  if(nameCell){
                    const user = allUsers.find(u => u.name === nameCell.textContent);
                    if(!user || !selectedUserIds.has(String(user.id))){
                      row.style.display = "none";
                    }
                  }
                });
                
                return () => {
                    original.forEach((display, row) => {
                        row.style.display = display;
                    });
                };
            })();
            
            // Clone the filtered rota
            const rotaClone = cloneRotaForPrint();
            restore();
            
            console.log("Rota cloned successfully");
            
            // Build title based on selections
            let title = "Filtered Requests";
            let subtitle = "";
            
            if(selectedRoles.length > 0 && selectedUsers.length === 0){
                const roleNames = selectedRoles.map(rid => {
                    if(rid == 1) return "Charge Nurses";
                    if(rid == 2) return "Staff Nurses";
                    if(rid == 3) return "Nursing Assistants";
                    return "";
                }).join(", ");
                title = "Requests by Role";
                subtitle = roleNames;
            } else if(selectedUsers.length > 0 && selectedRoles.length === 0){
                const userNames = usersForComments.map(u => u.name).join(", ");
                title = "Selected Staff Requests";
                subtitle = userNames;
            } else if(selectedRoles.length > 0 && selectedUsers.length > 0){
                const userNames = usersForComments.map(u => u.name).join(", ");
                title = "Filtered Staff Requests";
                subtitle = userNames;
            } else {
                title = "All Requests";
                subtitle = "";
            }
            
            console.log("Title:", title);
            console.log("Subtitle:", subtitle);
            
            // If comments requested, fetch them
            let commentsData = [];
            let weeks = null; // Declare outside the if block so it's accessible later
            if(printMode !== "requests"){
              console.log("Fetching comments...");
              console.log("usersForComments:", usersForComments?.length);
              const userIds = usersForComments.map(u => u.id);
              console.log("User IDs for comments:", userIds);

              // Pull week IDs from the same DOM controls the modal uses
              const weekBtns = Array.from(document.querySelectorAll('.week-comment-btn'));
              const weekIds = Array.from(new Set(weekBtns
                .map(b => (b?.dataset?.weekId || '').trim())
                .filter(Boolean))
              );
              console.log("Week IDs from DOM:", weekIds);

              // Resolve week_start values for these IDs (safe table)
              const { data: weeksData, error: weekErr } = await supabaseClient
                .from('rota_weeks')
                .select('id, week_start')
                .in('id', weekIds)
                .order('week_start', { ascending: true });

              if (weekErr) {
                console.error('Week fetch error:', weekErr);
                throw weekErr;
              }

              weeks = weeksData; // Assign to outer scope variable
              console.log('Weeks fetched (by DOM ids):', weeks?.length || 0, weeks);

              if (weeks && weeks.length > 0) {
                // EXACT same path as the modal: fetchWeekComments per week
                const commentPromises = weeks.map(week =>
                  fetchWeekComments(week.id).then(rows => ({
                    data: rows || [],
                    week_start: week.week_start
                  }))
                );

                const results = await Promise.all(commentPromises);

                // Combine and enrich
                commentsData = [];
                for (const result of results) {
                  for (const comment of result.data) {
                    commentsData.push({
                      ...comment,
                      week_start: result.week_start,
                      user_name: usersById.get(String(comment.user_id)) || 'Unknown'
                    });
                  }
                }

                console.log('Total comments fetched (pre-filter):', commentsData.length);

                // Filter by selected users
                const selectedUserIds = new Set(userIds.map(id => String(id)));
                commentsData = commentsData.filter(c => selectedUserIds.has(String(c.user_id)));

                console.log('Comments after filtering by selected users:', commentsData.length);
              }
            } else {
                console.log("Skipping comments (requests only mode)");
            }
            
            console.log("Opening print window...");
            
            // Call print window with all data
            if(printMode === "comments"){
                // Comments only mode
                openFittedPrintWindow({ 
                    title: "Staff Comments Only", 
                    subtitle: usersForComments.map(u => u.name).join(", "), 
                    rotaClone: null,
                    commentsData: commentsData,
                    weekOrder: (printMode !== "requests" && typeof weeks !== 'undefined' ? weeks.map(w=>w.week_start) : undefined),
                    weeksInfo: (printMode !== "requests" && typeof weeks !== 'undefined' ? weeks : undefined),
                    commentsOnly: true
                });
            } else {
                // Requests or Both mode
                openFittedPrintWindow({ 
                    title: title, 
                    subtitle: subtitle, 
                    rotaClone: rotaClone,
                    commentsData: commentsData,
                    weekOrder: (printMode !== "requests" && typeof weeks !== 'undefined' ? weeks.map(w=>w.week_start) : undefined),
                    weeksInfo: (printMode !== "requests" && typeof weeks !== 'undefined' ? weeks : undefined)
                });
            }
        } catch(err){
            console.error("Admin print error:", err);
            alert("Print failed: " + (err.message || "Unknown error"));
        }
    }
    
    async function exportToExcel(){
        try{
            const weeks = (allWeeks || []).slice(weekWindowStart, weekWindowStart + WINDOW_WEEKS);
            if (!weeks.length) {
                alert("No weeks loaded for export.");
                return;
            }

            const visibleUsers = allUsers.filter(u => u.is_active !== false);
            const dayLetters = ["S","M","T","W","T","F","S"];
            const totalColumns = 2 + (weeks.length * 8); // Name + spacer + (7 days + count) per week
            const csvRows = [];

            const toCell = (val) => {
                if (val == null) return "";
                const s = String(val);
                if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
                return s;
            };

            const blankRow = () => new Array(totalColumns).fill("");
            const rolePrefix = (user) => {
                if (user.role_id === 1) return "CN";
                if (user.role_id === 2) return "SN";
                if (user.role_id === 3) return "NA";
                return "";
            };

            const formatRequestValue = (req) => {
                if (!req) return "";
                if (req.value === "O") {
                    if (req.important_rank === 1) return "O¬π";
                    if (req.important_rank === 2) return "O¬≤";
                    if (req.important_rank === 3) return "O¬≥";
                    return "O";
                }
                if (req.value === "8-8") return "'8-8";
                return req.value || "";
            };

            const headerTop = blankRow();
            headerTop[0] = "Calpe Ward";
            csvRows.push(blankRow());
            csvRows.push(headerTop);
            csvRows.push(blankRow());

            const periodLabel = activePeriodObj?.name || `${fmt(weeks[0].weekStart)} - ${fmt(weeks[weeks.length - 1].weekEnd)}`;
            const periodRow = blankRow();
            periodRow[0] = periodLabel;
            csvRows.push(periodRow);
            csvRows.push(blankRow());

            const accessRow = blankRow();
            accessRow[0] = "Access Requests";
            csvRows.push(accessRow);

            const headerRow = blankRow();
            headerRow[0] = "Name";
            headerRow[1] = "";
            weeks.forEach((w, wIdx) => {
                for (let d = 0; d < 7; d++) {
                    headerRow[2 + (wIdx * 8) + d] = dayLetters[d];
                }
                headerRow[2 + (wIdx * 8) + 7] = (wIdx === 0) ? "7" : "";
            });
            csvRows.push(headerRow);

            const dateRow = blankRow();
            weeks.forEach((w, wIdx) => {
                for (let d = 0; d < 7; d++) {
                    const dateNum = new Date(w.days[d].date).getDate();
                    dateRow[2 + (wIdx * 8) + d] = String(dateNum);
                }
            });
            csvRows.push(dateRow);

            visibleUsers.forEach(user => {
                const row = blankRow();
                const prefix = rolePrefix(user);
                row[0] = prefix ? `${prefix} ${user.name}` : user.name;
                row[1] = "";
                weeks.forEach((w, wIdx) => {
                    for (let d = 0; d < 7; d++) {
                        const dateStr = w.days[d].date;
                        const req = requestsCache.get(`${user.id}_${dateStr}`);
                        row[2 + (wIdx * 8) + d] = formatRequestValue(req);
                    }
                    row[2 + (wIdx * 8) + 7] = "";
                });
                csvRows.push(row);
            });

            const csv = "\ufeff" + csvRows.map(r => r.map(toCell).join(",")).join("\n");
            const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
            const link=document.createElement("a");
            const url=URL.createObjectURL(blob);
            link.setAttribute("href",url);
            link.setAttribute("download",`calpe-ward-requests-${activePeriodObj?.name||"export"}.csv`);
            link.style.display="none";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            closePrintModal();
            alert("Excel file exported successfully!")
        }catch(err){
            console.error("Export failed:",err);
            alert("Failed to export. Check console.")
        }
    }
    
    async function generateRequestsUsageReport(){
        try{
            const weeks=allWeeks.slice(weekWindowStart,weekWindowStart+5);
            const stats=allUsers.map(user=>{
                let totalRequests=0,offDutyCount=0,priorityOffDuty=0;
                weeks.forEach(w=>{
                    const days=daysInWeek(w.weekStart);
                    days.forEach(d=>{
                        const dateStr=isoDate(d);
                        const req=requestsCache.get(`${user.id}_${dateStr}`);
                        if(req?.value){
                            totalRequests++;
                            if(req.value==="O"||req.value==="O*"){
                                offDutyCount++;
                                if(req.value==="O*")priorityOffDuty++
                            }
                        }
                    })
                });
                return{
                    name:user.name,
                    role:user.role_id===1?"CN":user.role_id===2?"SN":"NA",
                    totalRequests,
                    offDutyCount,
                    priorityOffDuty,
                    percentUsed:Math.round((totalRequests/(weeks.length*7))*100)
                }
            });
            let csv="Name,Role,Total Requests,Off Duty Requests,Priority Off Duty,% Used\n";
            stats.forEach(s=>csv+=`"${s.name}",${s.role},${s.totalRequests},${s.offDutyCount},${s.priorityOffDuty},${s.percentUsed}%\n`);
            const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
            const link=document.createElement("a");
            const url=URL.createObjectURL(blob);
            link.setAttribute("href",url);
            link.setAttribute("download",`requests-usage-report-${activePeriodObj?.name||"report"}.csv`);
            link.style.display="none";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            closePrintModal();
            alert("Requests usage report generated!")
        }catch(err){
            console.error("Report generation failed:",err);
            alert("Failed to generate report. Check console.")
        }
    }
    
    async function generateCommentsReport(){
        try{
            if(!activePeriodId){
                alert("No active period selected.");
                return
            }
            const{data:comments,error}=await supabaseClient
                .from("week_comments")
                .select("*, users(name)")
                .eq("period_id",activePeriodId)
                .order("week_start",{ascending:true})
                .order("created_at",{ascending:true});
            if(error)throw error;
            if(!comments||comments.length===0){
                alert("No comments found for this period.");
                return
            }
            let csv="Week Start,User,Comment,Posted\n";
            comments.forEach(c=>{
                const weekDate=new Date(c.week_start).toLocaleDateString("en-GB");
                const userName=c.users?.name||"Unknown";
                const comment=(c.comment||"").replace(/"/g,'""');
                const posted=new Date(c.created_at).toLocaleString("en-GB");
                csv+=`"${weekDate}","${userName}","${comment}","${posted}"\n`
            });
            const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
            const link=document.createElement("a");
            const url=URL.createObjectURL(blob);
            link.setAttribute("href",url);
            link.setAttribute("download",`comments-report-${activePeriodObj?.name||"report"}.csv`);
            link.style.display="none";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            closePrintModal();
            alert(`Comments report generated! ${comments.length} comments exported.`)
        }catch(err){
            console.error("Comments report failed:",err);
            alert("Failed to generate comments report. Check console.")
        }
    }
    
    printBtn?.addEventListener("click",openPrintModal);
    printClose?.addEventListener("click",closePrintModal);
    printCloseX?.addEventListener("click",closePrintModal);
    printAllRequests?.addEventListener("click",printAll);
    printGroupCN?.addEventListener("click",()=>printByGroup(1,"Charge Nurses"));
    printGroupSN?.addEventListener("click",()=>printByGroup(2,"Staff Nurses"));
    printGroupNA?.addEventListener("click",()=>printByGroup(3,"Nursing Assistants"));
    printOwnRow?.addEventListener("click",printOwnRowFunc);
    exportExcel?.addEventListener("click",exportToExcel);
    reportRequestsUsage?.addEventListener("click",generateRequestsUsageReport);
    reportComments?.addEventListener("click",generateCommentsReport);
    printModal?.addEventListener("click",(e)=>{if(e.target===printModal)closePrintModal()});

/* =========================================================
       10) BOOT
       ========================================================= */
    loadRota();
    populateShiftGrid();
    

  </script>
</body>
</html>





























































